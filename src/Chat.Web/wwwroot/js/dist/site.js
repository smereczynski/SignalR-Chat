(()=>{(function(){if(window.appLogger)return;let l=null;function T(d){l=d}function g(d,a,c){let i={level:d,msg:a,traceId:l,ts:new Date().toISOString()};return c&&Object.keys(c).forEach(p=>i[p]=c[p]),i}function v(d,a,c){let i=g(d,a,c),p="["+i.level+"]";return i.traceId&&(p+="["+i.traceId+"]"),p+=" "+i.msg,d==="error"?console.error(p,c||""):d==="warn"?console.warn(p,c||""):console.log(p,c||""),i}let A=window.fetch;window.fetch=function(d,a){return A(d,a).then(c=>{try{let i=c.headers.get("X-Trace-Id");i&&T(i)}catch{}return c})},window.appLogger={info:(d,a)=>v("info",d,a),warn:(d,a)=>v("warn",d,a),error:(d,a)=>v("error",d,a),setTraceId:T,getTraceId:()=>l}})();document.addEventListener("DOMContentLoaded",()=>{appLogger.info("site.js init (vanilla)");let l=t=>document.querySelector(t),T=t=>Array.from(document.querySelectorAll(t)),g=(t,e,o,n)=>t&&t.addEventListener(e,o,n||!1),v=document.getElementById("users-list");v&&v.addEventListener("click",t=>{let e=t.target.closest("li");if(!e||!v.contains(e))return;let o=e.getAttribute("data-username"),n=document.getElementById("message-input");if(!o||!n)return;let s=n.value||"";if(s.startsWith("/")){let r=s.split(")");r.length>1&&(s=r.slice(1).join(")"))}s="/private("+o+") "+s.trim(),n.value=s,n.dispatchEvent(new Event("change")),n.focus()}),g(l("#expand-sidebar"),"click",()=>{document.querySelectorAll(".sidebar").forEach(t=>t.classList.toggle("open")),document.querySelectorAll(".users-container").forEach(t=>t.classList.remove("open"))}),g(l("#expand-users-list"),"click",()=>{document.querySelectorAll(".users-container").forEach(t=>t.classList.toggle("open")),document.querySelectorAll(".sidebar").forEach(t=>t.classList.remove("open"))}),document.addEventListener("click",t=>{(t.target.closest(".sidebar.open ul li a")||t.target.closest("#users-list li"))&&document.querySelectorAll(".sidebar, .users-container").forEach(e=>e.classList.remove("open"))}),T(".modal").forEach(t=>{g(t,"shown.bs.modal",()=>{let e=t.querySelector("input[type=text]:first-child");e&&e.focus()}),g(t,"hidden.bs.modal",()=>{t.querySelectorAll(".modal-body input:not(#newRoomName)").forEach(e=>e.value="")})}),document.addEventListener("click",t=>{let e=t.target.closest(".alert .btn-close");if(e){let o=e.closest(".alert");o&&(o.style.display="none")}}),window.bootstrap&&bootstrap.Tooltip&&T("[data-bs-toggle='tooltip']").forEach(t=>new bootstrap.Tooltip(t,{delay:{show:500}}));let A=document.getElementById("remove-message-modal");A&&g(A,"shown.bs.modal",t=>{let e=t.relatedTarget;if(e){let o=e.getAttribute("data-messageId"),n=document.getElementById("itemToDelete");o&&n&&(n.value=o)}}),document.addEventListener("mouseover",t=>{let e=t.target.closest(".ismine");if(e){let o=e.querySelector(".actions");o&&o.classList.remove("d-none")}}),document.addEventListener("mouseout",t=>{let e=t.target.closest(".ismine");if(e&&!e.querySelector(".dropdown-menu.show")){let o=e.querySelector(".actions");o&&o.classList.add("d-none")}}),document.addEventListener("hidden.bs.dropdown",t=>{let e=t.target.closest(".actions .dropdown");if(e){let o=e.closest(".actions");o&&o.classList.add("d-none")}});function d(t,e){return fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(e||{})})}function a(t){let e=document.getElementById("otpError");e&&(t?(e.textContent=t,e.classList.remove("d-none")):(e.textContent="",e.classList.add("d-none")))}function c(){a(null),window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow;if(t.verifyInFlight)return;let e=(document.getElementById("otpUserName")?.value||"").trim(),o=(document.getElementById("otpCode")?.value||"").trim();if(!e||!o){a("User and code are required");return}let n=document.getElementById("btn-verify-otp");n&&(n.disabled=!0),t.verifyInFlight=!0;let s=performance.now();d("/api/auth/verify",{userName:e,code:o}).then(r=>{if(!r.ok)throw new Error("Invalid code");return r.json().catch(()=>({}))}).then(()=>{if(appLogger.info("OTP verify success",{user:e}),t.lastSendId){let w=Math.round(performance.now()-(t.lastSendCompletedTs||t.lastSendStartTs||s));appLogger.info("OTP verify latency",{user:e,sendId:t.lastSendId,verifyLatencyMs:w})}let r=document.getElementById("otp-login-modal");if(r&&window.bootstrap)try{(bootstrap.Modal.getInstance(r)||new bootstrap.Modal(r)).hide()}catch{}window.chatApp&&typeof window.chatApp.onAuthenticated=="function"?window.chatApp.onAuthenticated():appLogger.warn("chatApp.onAuthenticated not available")}).catch(r=>{appLogger.error("OTP verify failed",{user:e,error:r.message}),a(r.message||"Verification failed")}).finally(()=>{t.verifyInFlight=!1,n&&(n.disabled=!1)})}function i(t){t=t||{};let e=!!t.resend;a(null);let o=(document.getElementById("otpUserName")?.value||"").trim();if(!o){a("User selection is required");return}window.__otpFlow=window.__otpFlow||{};let n=window.__otpFlow,s=document.getElementById("btn-send-otp");if(s&&s.disabled&&!e)return;let r=document.getElementById("btn-resend-otp");if(e&&r&&r.disabled)return;let w=document.getElementById("otpContainer"),I=parseInt(w?.getAttribute("data-otp-timeout-ms")||"8000",10),q=parseInt(w?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10),u=document.getElementById("otpSendingIndicator"),L=document.getElementById("otpSendCountdown"),y=document.getElementById("otpRetryLink"),h=document.getElementById("otpRetryCountdown");if(!e&&s&&(s.disabled=!0),e&&r&&(r.disabled=!0),u){u.classList.remove("d-none","fade-hidden"),u.querySelectorAll("[data-state]")?.forEach(m=>m.classList.add("d-none"));let f=u.querySelector('[data-state="sending"]');f&&f.classList.remove("d-none")}if(y&&(y.classList.add("disabled-link"),y.dataset.cooldownLeft="0"),h&&(h.textContent=""),n.startAbort)try{n.startAbort.abort()}catch{}let b=new AbortController;n.startAbort=b,n.activeUser=o;let B="send_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);n.lastSendId=B,n.lastSendStartTs=performance.now(),n.lastSendCompletedTs=null;let _=I;L&&(L.textContent=Math.ceil(_/1e3)),n.countdownInterval&&clearInterval(n.countdownInterval),n.countdownInterval=setInterval(()=>{_-=1e3,_<=0?(L&&(L.textContent="0"),clearInterval(n.countdownInterval),n.countdownInterval=null):L&&(L.textContent=Math.ceil(_/1e3))},1e3),n.startTimeout&&clearTimeout(n.startTimeout),n.startTimeout=setTimeout(()=>{if(!b.signal.aborted){appLogger.warn("OTP send timeout",{user:o,timeoutMs:I,sendId:B});try{b.abort()}catch{}}},I),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o}),credentials:"same-origin",signal:b.signal}).then(f=>{if(!f.ok)throw new Error("Failed to send code");return f.json().catch(()=>({}))}).then(()=>{if(n.activeUser!==o||b.signal.aborted)return;n.lastSendCompletedTs=performance.now();let f=Math.round(n.lastSendCompletedTs-n.lastSendStartTs);if(appLogger.info("OTP code sent",{user:o,durationMs:f,sendId:B}),u){u.querySelectorAll("[data-state]")?.forEach(E=>E.classList.add("d-none"));let m=u.querySelector('[data-state="success"]');m&&m.classList.remove("d-none"),setTimeout(()=>{u.classList.add("fade-hidden")},2e3),setTimeout(()=>{u.classList.add("d-none")},2500)}if(!e){let m=l("#otp-step1"),E=l("#otp-step2");m&&E&&(m.classList.add("d-none"),E.classList.remove("d-none"));let C=l("#otpCode");C&&C.focus()}}).catch(f=>{let m=b.signal.aborted,E=performance.now(),C=Math.round(E-n.lastSendStartTs);if(m?appLogger.warn("OTP send aborted",{user:o,durationMs:C,sendId:B}):(appLogger.error("OTP send failed",{error:f.message,user:o,durationMs:C,sendId:B}),a(f.message||"Error sending code")),u)if(u.querySelectorAll("[data-state]")?.forEach(M=>M.classList.add("d-none")),m)u.classList.add("fade-hidden"),setTimeout(()=>u.classList.add("d-none"),250);else{let M=u.querySelector('[data-state="error"]');if(M&&M.classList.remove("d-none"),y){let S=q;y.classList.add("disabled-link"),y.dataset.cooldownLeft=S.toString(),h&&(h.textContent="("+Math.ceil(S/1e3)+"s)"),n.retryInterval&&clearInterval(n.retryInterval),n.retryInterval=setInterval(()=>{S-=1e3,S<=0?(clearInterval(n.retryInterval),n.retryInterval=null,y.classList.remove("disabled-link"),y.dataset.cooldownLeft="0",h&&(h.textContent="")):(y.dataset.cooldownLeft=S.toString(),h&&(h.textContent="("+Math.ceil(S/1e3)+"s)"))},1e3)}}}).finally(()=>{s&&(s.disabled=!1),r&&(r.disabled=!1),n.startTimeout&&(clearTimeout(n.startTimeout),n.startTimeout=null),n.countdownInterval&&(clearInterval(n.countdownInterval),n.countdownInterval=null)})}document.addEventListener("click",t=>{if(t.target.closest("#btn-send-otp")){i({resend:!1});return}if(t.target.closest("#btn-resend-otp")){i({resend:!0});return}if(t.target.closest("#btn-verify-otp")){c();return}if(t.target.closest("#btn-logout")){d("/api/auth/logout",{}).then(()=>{appLogger.info("Logout success"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()}).catch(()=>{appLogger.warn("Logout request error"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()});return}}),document.addEventListener("click",t=>{let e=t.target.closest("#otpRetryLink");if(e){if(t.preventDefault(),e.classList.contains("disabled-link"))return;i({resend:!1})}});let p=document.getElementById("otpCode");p&&p.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),c())});let k=document.getElementById("otp-login-modal");k&&(g(k,"show.bs.modal",()=>{a(null);let t=window.__otpFlow=window.__otpFlow||{};t.activeUser=null,l("#otp-step1")?.classList.remove("d-none"),l("#otp-step2")?.classList.add("d-none");let e=l("#otpCode");e&&(e.value="");let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(n=>{if(!n.ok)throw new Error("Failed to load users");return n.json()}).then(n=>{o.innerHTML='<option value="" disabled selected>Select user...</option>'+n.map(s=>`<option value="${s.userName}">${s.fullName||s.userName}</option>`).join(""),o.dataset.loaded="true"}).catch(n=>{a(n.message)})}),g(k,"hide.bs.modal",()=>{let t=window.__otpFlow;if(t?.startAbort)try{t.startAbort.abort()}catch{}t&&(t.activeUser=null),l("#otp-step1")?.classList.remove("d-none"),l("#otp-step2")?.classList.add("d-none"),a(null);let e=document.getElementById("btn-send-otp");e&&(e.disabled=!1);let o=document.getElementById("otpSendingIndicator");o&&(o.classList.add("d-none"),o.classList.remove("fade-hidden"),o.querySelectorAll("[data-state]")?.forEach(I=>I.classList.add("d-none")));let n=document.getElementById("btn-resend-otp");n&&(n.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null),t.retryInterval&&(clearInterval(t.retryInterval),t.retryInterval=null);let s=document.getElementById("otpSendCountdown");s&&(s.textContent="0");let r=document.getElementById("otpRetryCountdown");r&&(r.textContent="");let w=document.getElementById("otpRetryLink");w&&(w.classList.add("disabled-link"),w.dataset.cooldownLeft="0")}))});})();
