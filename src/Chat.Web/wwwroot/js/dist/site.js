(()=>{(function(){if(window.appLogger)return;let l=null;function T(s){l=s}function g(s,c,d){let i={level:s,msg:c,traceId:l,ts:new Date().toISOString()};return d&&Object.keys(d).forEach(p=>i[p]=d[p]),i}function L(s,c,d){let i=g(s,c,d),p="["+i.level+"]";return i.traceId&&(p+="["+i.traceId+"]"),p+=" "+i.msg,s==="error"?console.error(p,d||""):s==="warn"?console.warn(p,d||""):console.log(p,d||""),i}let M=window.fetch;window.fetch=function(s,c){return M(s,c).then(d=>{try{let i=d.headers.get("X-Trace-Id");i&&T(i)}catch{}return d})},window.appLogger={info:(s,c)=>L("info",s,c),warn:(s,c)=>L("warn",s,c),error:(s,c)=>L("error",s,c),setTraceId:T,getTraceId:()=>l}})();document.addEventListener("DOMContentLoaded",()=>{appLogger.info("site.js init (vanilla)");let l=e=>document.querySelector(e),T=e=>Array.from(document.querySelectorAll(e)),g=(e,n,o,t)=>e&&e.addEventListener(n,o,t||!1);g(l("#expand-sidebar"),"click",()=>{document.querySelectorAll(".sidebar").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".users-container").forEach(e=>e.classList.remove("open"))}),g(l("#expand-users-list"),"click",()=>{document.querySelectorAll(".users-container").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".sidebar").forEach(e=>e.classList.remove("open"))}),document.addEventListener("click",e=>{(e.target.closest(".sidebar.open ul li a")||e.target.closest("#users-list li"))&&document.querySelectorAll(".sidebar, .users-container").forEach(n=>n.classList.remove("open"))}),T(".modal").forEach(e=>{g(e,"shown.bs.modal",()=>{let n=e.querySelector("input[type=text]:first-child");n&&n.focus()}),g(e,"hidden.bs.modal",()=>{e.querySelectorAll(".modal-body input:not(#newRoomName)").forEach(n=>n.value="")})}),document.addEventListener("click",e=>{let n=e.target.closest(".alert .btn-close");if(n){let o=n.closest(".alert");o&&(o.style.display="none")}}),window.bootstrap&&bootstrap.Tooltip&&T("[data-bs-toggle='tooltip']").forEach(e=>new bootstrap.Tooltip(e,{delay:{show:500}}));let L=document.getElementById("remove-message-modal");L&&g(L,"shown.bs.modal",e=>{let n=e.relatedTarget;if(n){let o=n.getAttribute("data-messageId"),t=document.getElementById("itemToDelete");o&&t&&(t.value=o)}}),document.addEventListener("mouseover",e=>{let n=e.target.closest(".ismine");if(n){let o=n.querySelector(".actions");o&&o.classList.remove("d-none")}}),document.addEventListener("mouseout",e=>{let n=e.target.closest(".ismine");if(n&&!n.querySelector(".dropdown-menu.show")){let o=n.querySelector(".actions");o&&o.classList.add("d-none")}}),document.addEventListener("hidden.bs.dropdown",e=>{let n=e.target.closest(".actions .dropdown");if(n){let o=n.closest(".actions");o&&o.classList.add("d-none")}});function M(e,n){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(n||{})})}function s(e){let n=document.getElementById("otpError");n&&(e?(n.textContent=e,n.classList.remove("d-none")):(n.textContent="",n.classList.add("d-none")))}function c(){s(null),window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow;if(e.verifyInFlight)return;let n=(document.getElementById("otpUserName")?.value||"").trim(),o=(document.getElementById("otpCode")?.value||"").trim();if(!n||!o){s("User and code are required");return}let t=document.getElementById("btn-verify-otp");t&&(t.disabled=!0),e.verifyInFlight=!0;let a=performance.now();M("/api/auth/verify",{userName:n,code:o}).then(r=>{if(!r.ok)throw new Error("Invalid code");return r.json().catch(()=>({}))}).then(()=>{if(appLogger.info("OTP verify success",{user:n}),e.lastSendId){let y=Math.round(performance.now()-(e.lastSendCompletedTs||e.lastSendStartTs||a));appLogger.info("OTP verify latency",{user:n,sendId:e.lastSendId,verifyLatencyMs:y})}let r=document.getElementById("otp-login-modal");if(r&&window.bootstrap)try{(bootstrap.Modal.getInstance(r)||new bootstrap.Modal(r)).hide()}catch{}window.chatApp&&typeof window.chatApp.onAuthenticated=="function"?window.chatApp.onAuthenticated():appLogger.warn("chatApp.onAuthenticated not available")}).catch(r=>{appLogger.error("OTP verify failed",{user:n,error:r.message}),s(r.message||"Verification failed")}).finally(()=>{e.verifyInFlight=!1,t&&(t.disabled=!1)})}function d(e){e=e||{};let n=!!e.resend;s(null);let o=(document.getElementById("otpUserName")?.value||"").trim();if(!o){s("User selection is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,a=document.getElementById("btn-send-otp");if(a&&a.disabled&&!n)return;let r=document.getElementById("btn-resend-otp"),y=parseInt(q?.getAttribute("data-otp-resend-delay-ms")||"300000",10);t.firstSendAt=t.firstSendAt||0;let A=Date.now();if(!n)t.firstSendAt=A;else if(A-(t.firstSendAt||0)<y)return;let q=document.getElementById("otpContainer"),k=parseInt(q?.getAttribute("data-otp-timeout-ms")||"29000",10),x=3e4,N=parseInt(q?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10),u=document.getElementById("otpSendingIndicator"),b=document.getElementById("otpSendCountdown"),v=document.getElementById("otpRetryLink"),h=document.getElementById("otpRetryCountdown");if(!n&&a&&(a.disabled=!0),n&&r&&(r.disabled=!0),u){u.classList.remove("d-none","fade-hidden"),u.querySelectorAll("[data-state]")?.forEach(m=>m.classList.add("d-none"));let f=u.querySelector('[data-state="sending"]');f&&f.classList.remove("d-none")}if(v&&(v.classList.add("disabled-link"),v.dataset.cooldownLeft="0"),h&&(h.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let E=new AbortController;t.startAbort=E,t.activeUser=o;let B="send_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);t.lastSendId=B,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let _=x;b&&(b.textContent=Math.ceil(_/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{_-=1e3,_<=0?(b&&(b.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):b&&(b.textContent=Math.ceil(_/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!E.signal.aborted){appLogger.warn("OTP send timeout",{user:o,timeoutMs:k,sendId:B});try{E.abort()}catch{}}},k),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o}),credentials:"same-origin",signal:E.signal}).then(f=>{if(!f.ok)throw new Error("Failed to send code");return f.json().catch(()=>({}))}).then(()=>{if(t.activeUser!==o||E.signal.aborted)return;t.lastSendCompletedTs=performance.now();let f=Math.round(t.lastSendCompletedTs-t.lastSendStartTs);if(appLogger.info("OTP code sent",{user:o,durationMs:f,sendId:B}),u){u.querySelectorAll("[data-state]")?.forEach(S=>S.classList.add("d-none"));let m=u.querySelector('[data-state="success"]');m&&m.classList.remove("d-none"),setTimeout(()=>{u.classList.add("fade-hidden")},2e3),setTimeout(()=>{u.classList.add("d-none")},2500)}if(!n){let m=l("#otp-step1"),S=l("#otp-step2");m&&S&&(m.classList.add("d-none"),S.classList.remove("d-none"));let C=l("#otpCode");C&&C.focus();let w=document.getElementById("btn-resend-otp");if(w){w.disabled=!0;let I=(t.firstSendAt||Date.now())+y;t.resendAvailInterval&&clearInterval(t.resendAvailInterval);let F=()=>{let O=I-Date.now();if(O<=0)clearInterval(t.resendAvailInterval),t.resendAvailInterval=null,w.disabled=!1,w.textContent="Resend";else{let D=Math.ceil(O/1e3);w.textContent="Resend in "+D+"s"}};F(),t.resendAvailInterval=setInterval(F,1e3)}}}).catch(f=>{let m=E.signal.aborted,S=performance.now(),C=Math.round(S-t.lastSendStartTs);if(m?appLogger.warn("OTP send aborted",{user:o,durationMs:C,sendId:B}):(appLogger.error("OTP send failed",{error:f.message,user:o,durationMs:C,sendId:B}),s(f.message||"Error sending code")),u)if(u.querySelectorAll("[data-state]")?.forEach(w=>w.classList.add("d-none")),m)u.classList.add("fade-hidden"),setTimeout(()=>u.classList.add("d-none"),250);else{let w=u.querySelector('[data-state="error"]');if(w&&w.classList.remove("d-none"),v){let I=N;v.classList.add("disabled-link"),v.dataset.cooldownLeft=I.toString(),h&&(h.textContent="("+Math.ceil(I/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{I-=1e3,I<=0?(clearInterval(t.retryInterval),t.retryInterval=null,v.classList.remove("disabled-link"),v.dataset.cooldownLeft="0",h&&(h.textContent="")):(v.dataset.cooldownLeft=I.toString(),h&&(h.textContent="("+Math.ceil(I/1e3)+"s)"))},1e3)}}}).finally(()=>{a&&(a.disabled=!1),r&&(r.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){d({resend:!1});return}if(e.target.closest("#btn-resend-otp")){d({resend:!0});return}if(e.target.closest("#btn-verify-otp")){c();return}if(e.target.closest("#btn-logout")){M("/api/auth/logout",{}).then(()=>{appLogger.info("Logout success"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()}).catch(()=>{appLogger.warn("Logout request error"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()});return}}),document.addEventListener("click",e=>{let n=e.target.closest("#otpRetryLink");if(n){if(e.preventDefault(),n.classList.contains("disabled-link"))return;d({resend:!1})}});let i=document.getElementById("otpCode");i&&i.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),c())});let p=document.getElementById("otp-login-modal");p&&(g(p,"show.bs.modal",()=>{s(null);let e=window.__otpFlow=window.__otpFlow||{};e.activeUser=null,l("#otp-step1")?.classList.remove("d-none"),l("#otp-step2")?.classList.add("d-none");let n=l("#otpCode");n&&(n.value="");let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(t=>{if(!t.ok)throw new Error("Failed to load users");return t.json()}).then(t=>{o.innerHTML='<option value="" disabled selected>Select user...</option>'+t.map(a=>`<option value="${a.userName}">${a.fullName||a.userName}</option>`).join(""),o.dataset.loaded="true"}).catch(t=>{s(t.message)})}),g(p,"hide.bs.modal",()=>{let e=window.__otpFlow;if(e?.startAbort)try{e.startAbort.abort()}catch{}e&&(e.activeUser=null),l("#otp-step1")?.classList.remove("d-none"),l("#otp-step2")?.classList.add("d-none"),s(null);let n=document.getElementById("btn-send-otp");n&&(n.disabled=!1);let o=document.getElementById("otpSendingIndicator");o&&(o.classList.add("d-none"),o.classList.remove("fade-hidden"),o.querySelectorAll("[data-state]")?.forEach(A=>A.classList.add("d-none")));let t=document.getElementById("btn-resend-otp");t&&(t.disabled=!1),e.startTimeout&&(clearTimeout(e.startTimeout),e.startTimeout=null),e.countdownInterval&&(clearInterval(e.countdownInterval),e.countdownInterval=null),e.retryInterval&&(clearInterval(e.retryInterval),e.retryInterval=null);let a=document.getElementById("otpSendCountdown");a&&(a.textContent="0");let r=document.getElementById("otpRetryCountdown");r&&(r.textContent="");let y=document.getElementById("otpRetryLink");y&&(y.classList.add("disabled-link"),y.dataset.cooldownLeft="0")}))});})();
