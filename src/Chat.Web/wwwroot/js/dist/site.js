(()=>{(function(){if(window.appLogger)return;let d=null;function E(r){d=r}function g(r,u,i){let l={level:r,msg:u,traceId:d,ts:new Date().toISOString()};return i&&Object.keys(i).forEach(p=>l[p]=i[p]),l}function S(r,u,i){let l=g(r,u,i),p="["+l.level+"]";return l.traceId&&(p+="["+l.traceId+"]"),p+=" "+l.msg,r==="error"?console.error(p,i||""):r==="warn"?console.warn(p,i||""):console.log(p,i||""),l}let F=window.fetch;window.fetch=function(r,u){return F(r,u).then(i=>{try{let l=i.headers.get("X-Trace-Id");l&&E(l)}catch{}return i})},window.appLogger={info:(r,u)=>S("info",r,u),warn:(r,u)=>S("warn",r,u),error:(r,u)=>S("error",r,u),setTraceId:E,getTraceId:()=>d}})();(function(){window.i18n={},fetch("/api/localization/strings",{credentials:"same-origin"}).then(d=>d.ok?d.json():{}).then(d=>{window.i18n=d,document.dispatchEvent(new Event("i18n-loaded"))}).catch(()=>{window.i18n={Loading:"Loading\u2026",Error:"Error",Retry:"Retry",FailedToLoadUsers:"Failed to load users",UserSelectionRequired:"User selection is required",FailedToSendCode:"Failed to send code",ErrorSendingCode:"Error sending code",UserAndCodeRequired:"User and code are required",InvalidVerificationCode:"Invalid verification code",VerificationFailed:"Verification failed",SendingTooQuickly:"You are sending messages too quickly",SelectUser:"Select user..."}})})();document.addEventListener("DOMContentLoaded",()=>{appLogger.info("site.js init (vanilla)");let d=e=>document.querySelector(e),E=e=>Array.from(document.querySelectorAll(e)),g=(e,n,o,t)=>e&&e.addEventListener(n,o,t||!1);g(d("#expand-sidebar"),"click",()=>{document.querySelectorAll(".sidebar").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".users-container").forEach(e=>e.classList.remove("open"))}),g(d("#expand-users-list"),"click",()=>{document.querySelectorAll(".users-container").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".sidebar").forEach(e=>e.classList.remove("open"))}),document.addEventListener("click",e=>{(e.target.closest(".sidebar.open ul li a")||e.target.closest("#users-list li"))&&document.querySelectorAll(".sidebar, .users-container").forEach(n=>n.classList.remove("open"))}),E(".modal").forEach(e=>{g(e,"shown.bs.modal",()=>{let n=e.querySelector("input[type=text]:first-child");n&&n.focus()}),g(e,"hidden.bs.modal",()=>{e.querySelectorAll(".modal-body input:not(#newRoomName)").forEach(n=>n.value="")})}),document.addEventListener("click",e=>{let n=e.target.closest(".alert .btn-close");if(n){let o=n.closest(".alert");o&&(o.style.display="none")}}),window.bootstrap&&bootstrap.Tooltip&&E("[data-bs-toggle='tooltip']").forEach(e=>new bootstrap.Tooltip(e,{delay:{show:500}}));let S=document.getElementById("remove-message-modal");S&&g(S,"shown.bs.modal",e=>{let n=e.relatedTarget;if(n){let o=n.getAttribute("data-messageId"),t=document.getElementById("itemToDelete");o&&t&&(t.value=o)}}),document.addEventListener("mouseover",e=>{let n=e.target.closest(".ismine");if(n){let o=n.querySelector(".actions");o&&o.classList.remove("d-none")}}),document.addEventListener("mouseout",e=>{let n=e.target.closest(".ismine");if(n&&!n.querySelector(".dropdown-menu.show")){let o=n.querySelector(".actions");o&&o.classList.add("d-none")}}),document.addEventListener("hidden.bs.dropdown",e=>{let n=e.target.closest(".actions .dropdown");if(n){let o=n.closest(".actions");o&&o.classList.add("d-none")}});function F(e,n){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(n||{})})}function r(e){let n=document.getElementById("otpError");n&&(e?(n.textContent=e,n.classList.remove("d-none")):(n.textContent="",n.classList.add("d-none")))}function u(){r(null),window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow;if(e.verifyInFlight)return;let n=(document.getElementById("otpUserName")?.value||"").trim(),o=(document.getElementById("otpCode")?.value||"").trim();if(!n||!o){r(window.i18n.UserAndCodeRequired||"User and code are required");return}let t=document.getElementById("btn-verify-otp");t&&(t.disabled=!0),e.verifyInFlight=!0;let a=performance.now();F("/api/auth/verify",{userName:n,code:o}).then(s=>{if(!s.ok)throw new Error(window.i18n.InvalidVerificationCode||"Invalid code");return s.json().catch(()=>({}))}).then(()=>{if(appLogger.info("OTP verify success",{user:n}),e.lastSendId){let c=Math.round(performance.now()-(e.lastSendCompletedTs||e.lastSendStartTs||a));appLogger.info("OTP verify latency",{user:n,sendId:e.lastSendId,verifyLatencyMs:c})}let s=document.getElementById("otp-login-modal");if(s&&window.bootstrap)try{(bootstrap.Modal.getInstance(s)||new bootstrap.Modal(s)).hide()}catch{}window.chatApp&&typeof window.chatApp.onAuthenticated=="function"?window.chatApp.onAuthenticated():appLogger.warn("chatApp.onAuthenticated not available")}).catch(s=>{appLogger.error("OTP verify failed",{user:n,error:s.message}),r(s.message||window.i18n.VerificationFailed||"Verification failed")}).finally(()=>{e.verifyInFlight=!1,t&&(t.disabled=!1)})}function i(e){e=e||{};let n=!!e.resend;r(null);let o=(document.getElementById("otpUserName")?.value||"").trim();if(!o){r(window.i18n.UserSelectionRequired||"User selection is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,a=document.getElementById("btn-send-otp");if(a&&a.disabled&&!n)return;let s=document.getElementById("btn-resend-otp"),c=document.getElementById("otpContainer"),T=parseInt(c?.getAttribute("data-otp-resend-delay-ms")||"300000",10);t.firstSendAt=t.firstSendAt||0;let v=Date.now();if(!n)t.firstSendAt=v;else if(v-(t.firstSendAt||0)<T)return;let b=parseInt(c?.getAttribute("data-otp-timeout-ms")||"29000",10),x=3e4,N=parseInt(c?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10),f=document.getElementById("otpSendingIndicator"),C=document.getElementById("otpSendCountdown"),h=document.getElementById("otpRetryLink"),I=document.getElementById("otpRetryCountdown");if(!n&&a&&(a.disabled=!0),n&&s&&(s.disabled=!0),f){f.classList.remove("d-none","fade-hidden"),f.querySelectorAll("[data-state]")?.forEach(w=>w.classList.add("d-none"));let m=f.querySelector('[data-state="sending"]');m&&m.classList.remove("d-none")}if(h&&(h.classList.add("disabled-link"),h.dataset.cooldownLeft="0"),I&&(I.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let A=new AbortController;t.startAbort=A,t.activeUser=o;let q="send_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);t.lastSendId=q,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let _=x;C&&(C.textContent=Math.ceil(_/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{_-=1e3,_<=0?(C&&(C.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):C&&(C.textContent=Math.ceil(_/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!A.signal.aborted){appLogger.warn("OTP send timeout",{user:o,timeoutMs:b,sendId:q});try{A.abort()}catch{}}},b),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o}),credentials:"same-origin",signal:A.signal}).then(m=>{if(!m.ok)throw new Error(window.i18n.FailedToSendCode||"Failed to send code");return m.json().catch(()=>({}))}).then(()=>{if(t.activeUser!==o||A.signal.aborted)return;t.lastSendCompletedTs=performance.now();let m=Math.round(t.lastSendCompletedTs-t.lastSendStartTs);if(appLogger.info("OTP code sent",{user:o,durationMs:m,sendId:q}),f){f.querySelectorAll("[data-state]")?.forEach(B=>B.classList.add("d-none"));let w=f.querySelector('[data-state="success"]');w&&w.classList.remove("d-none"),setTimeout(()=>{f.classList.add("fade-hidden")},2e3),setTimeout(()=>{f.classList.add("d-none")},2500)}if(!n){let w=d("#otp-step1"),B=d("#otp-step2");w&&B&&(w.classList.add("d-none"),B.classList.remove("d-none"));let k=d("#otpCode");k&&k.focus();let y=document.getElementById("btn-resend-otp");if(y){y.disabled=!0;let L=(t.firstSendAt||Date.now())+T;t.resendAvailInterval&&clearInterval(t.resendAvailInterval);let O=()=>{let R=L-Date.now();if(R<=0)clearInterval(t.resendAvailInterval),t.resendAvailInterval=null,y.disabled=!1,y.textContent="Resend";else{let D=Math.ceil(R/1e3);y.textContent="Resend in "+D+"s"}};O(),t.resendAvailInterval=setInterval(O,1e3)}}}).catch(m=>{let w=A.signal.aborted,B=performance.now(),k=Math.round(B-t.lastSendStartTs);if(w?appLogger.warn("OTP send aborted",{user:o,durationMs:k,sendId:q}):(appLogger.error("OTP send failed",{error:m.message,user:o,durationMs:k,sendId:q}),r(m.message||window.i18n.ErrorSendingCode||"Error sending code")),f)if(f.querySelectorAll("[data-state]")?.forEach(y=>y.classList.add("d-none")),w)f.classList.add("fade-hidden"),setTimeout(()=>f.classList.add("d-none"),250);else{let y=f.querySelector('[data-state="error"]');if(y&&y.classList.remove("d-none"),h){let L=N;h.classList.add("disabled-link"),h.dataset.cooldownLeft=L.toString(),I&&(I.textContent="("+Math.ceil(L/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{L-=1e3,L<=0?(clearInterval(t.retryInterval),t.retryInterval=null,h.classList.remove("disabled-link"),h.dataset.cooldownLeft="0",I&&(I.textContent="")):(h.dataset.cooldownLeft=L.toString(),I&&(I.textContent="("+Math.ceil(L/1e3)+"s)"))},1e3)}}}).finally(()=>{a&&(a.disabled=!1),s&&(s.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){i({resend:!1});return}if(e.target.closest("#btn-resend-otp")){i({resend:!0});return}if(e.target.closest("#btn-verify-otp")){u();return}if(e.target.closest("#btn-logout")){F("/api/auth/logout",{}).then(()=>{appLogger.info("Logout success")}).catch(()=>{appLogger.warn("Logout request error")}).finally(()=>{window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup(),window.location.replace("/login?ReturnUrl=/chat")});return}}),document.addEventListener("click",e=>{let n=e.target.closest("#otpRetryLink");if(n){if(e.preventDefault(),n.classList.contains("disabled-link"))return;i({resend:!1})}});let l=document.getElementById("otpCode");l&&l.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),u())});let p=document.getElementById("otp-login-modal");p&&(g(p,"show.bs.modal",()=>{r(null);let e=window.__otpFlow=window.__otpFlow||{};e.activeUser=null,d("#otp-step1")?.classList.remove("d-none"),d("#otp-step2")?.classList.add("d-none");let n=d("#otpCode");n&&(n.value="");let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(t=>{if(!t.ok)throw new Error(window.i18n.FailedToLoadUsers||"Failed to load users");return t.json()}).then(t=>{let a=window.i18n.SelectUser||"Select user...";o.innerHTML='<option value="" disabled selected>'+a+"</option>"+t.map(s=>`<option value="${s.userName}">${s.fullName||s.userName}</option>`).join(""),o.dataset.loaded="true"}).catch(t=>{r(t.message)})}),g(p,"hide.bs.modal",()=>{let e=window.__otpFlow;if(e?.startAbort)try{e.startAbort.abort()}catch{}e&&(e.activeUser=null),d("#otp-step1")?.classList.remove("d-none"),d("#otp-step2")?.classList.add("d-none"),r(null);let n=document.getElementById("btn-send-otp");n&&(n.disabled=!1);let o=document.getElementById("otpSendingIndicator");o&&(o.classList.add("d-none"),o.classList.remove("fade-hidden"),o.querySelectorAll("[data-state]")?.forEach(T=>T.classList.add("d-none")));let t=document.getElementById("btn-resend-otp");t&&(t.disabled=!1),e.startTimeout&&(clearTimeout(e.startTimeout),e.startTimeout=null),e.countdownInterval&&(clearInterval(e.countdownInterval),e.countdownInterval=null),e.retryInterval&&(clearInterval(e.retryInterval),e.retryInterval=null);let a=document.getElementById("otpSendCountdown");a&&(a.textContent="0");let s=document.getElementById("otpRetryCountdown");s&&(s.textContent="");let c=document.getElementById("otpRetryLink");c&&(c.classList.add("disabled-link"),c.dataset.cooldownLeft="0")}));let U=document.getElementById("languageModal");if(U){let e={en:"\u{1F1EC}\u{1F1E7}","pl-PL":"\u{1F1F5}\u{1F1F1}","de-DE":"\u{1F1E9}\u{1F1EA}","cs-CZ":"\u{1F1E8}\u{1F1FF}","sk-SK":"\u{1F1F8}\u{1F1F0}","uk-UA":"\u{1F1FA}\u{1F1E6}","be-BY":"\u{1F1E7}\u{1F1FE}","lt-LT":"\u{1F1F1}\u{1F1F9}","ru-RU":"\u{1F1F7}\u{1F1FA}"},n=document.documentElement.lang||"en",o="en";if(n.length===2){let a=Object.keys(e).find(s=>s.toLowerCase().startsWith(n.toLowerCase()));a&&(o=a)}else o=n;let t=document.getElementById("currentLanguageFlag");t&&e[o]&&(t.textContent=e[o]),g(U,"show.bs.modal",()=>{E("#languageModal .language-list button").forEach(a=>{a.getAttribute("data-culture")===o?a.classList.add("active"):a.classList.remove("active")})}),document.addEventListener("click",a=>{let s=a.target.closest("#languageModal .language-list button");if(s){let c=s.getAttribute("data-culture"),T=s.getAttribute("data-flag");if(c&&c!==o){appLogger.info("Changing language",{from:o,to:c});let v=document.createElement("form");v.method="POST",v.action="/Culture/Set";let M=document.createElement("input");M.type="hidden",M.name="culture",M.value=c,v.appendChild(M);let b=document.createElement("input");b.type="hidden",b.name="returnUrl",b.value=window.location.pathname+window.location.search,v.appendChild(b),document.body.appendChild(v),v.submit()}}})}});})();
