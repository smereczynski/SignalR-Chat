(()=>{(function(){if(window.appLogger)return;let l=null;function S(s){l=s}function g(s,c,d){let i={level:s,msg:c,traceId:l,ts:new Date().toISOString()};return d&&Object.keys(d).forEach(f=>i[f]=d[f]),i}function v(s,c,d){let i=g(s,c,d),f="["+i.level+"]";return i.traceId&&(f+="["+i.traceId+"]"),f+=" "+i.msg,s==="error"?console.error(f,d||""):s==="warn"?console.warn(f,d||""):console.log(f,d||""),i}let C=window.fetch;window.fetch=function(s,c){return C(s,c).then(d=>{try{let i=d.headers.get("X-Trace-Id");i&&S(i)}catch{}return d})},window.appLogger={info:(s,c)=>v("info",s,c),warn:(s,c)=>v("warn",s,c),error:(s,c)=>v("error",s,c),setTraceId:S,getTraceId:()=>l}})();document.addEventListener("DOMContentLoaded",()=>{appLogger.info("site.js init (vanilla)");let l=t=>document.querySelector(t),S=t=>Array.from(document.querySelectorAll(t)),g=(t,e,o,n)=>t&&t.addEventListener(e,o,n||!1);g(l("#expand-sidebar"),"click",()=>{document.querySelectorAll(".sidebar").forEach(t=>t.classList.toggle("open")),document.querySelectorAll(".users-container").forEach(t=>t.classList.remove("open"))}),g(l("#expand-users-list"),"click",()=>{document.querySelectorAll(".users-container").forEach(t=>t.classList.toggle("open")),document.querySelectorAll(".sidebar").forEach(t=>t.classList.remove("open"))}),document.addEventListener("click",t=>{(t.target.closest(".sidebar.open ul li a")||t.target.closest("#users-list li"))&&document.querySelectorAll(".sidebar, .users-container").forEach(e=>e.classList.remove("open"))}),S(".modal").forEach(t=>{g(t,"shown.bs.modal",()=>{let e=t.querySelector("input[type=text]:first-child");e&&e.focus()}),g(t,"hidden.bs.modal",()=>{t.querySelectorAll(".modal-body input:not(#newRoomName)").forEach(e=>e.value="")})}),document.addEventListener("click",t=>{let e=t.target.closest(".alert .btn-close");if(e){let o=e.closest(".alert");o&&(o.style.display="none")}}),window.bootstrap&&bootstrap.Tooltip&&S("[data-bs-toggle='tooltip']").forEach(t=>new bootstrap.Tooltip(t,{delay:{show:500}}));let v=document.getElementById("remove-message-modal");v&&g(v,"shown.bs.modal",t=>{let e=t.relatedTarget;if(e){let o=e.getAttribute("data-messageId"),n=document.getElementById("itemToDelete");o&&n&&(n.value=o)}}),document.addEventListener("mouseover",t=>{let e=t.target.closest(".ismine");if(e){let o=e.querySelector(".actions");o&&o.classList.remove("d-none")}}),document.addEventListener("mouseout",t=>{let e=t.target.closest(".ismine");if(e&&!e.querySelector(".dropdown-menu.show")){let o=e.querySelector(".actions");o&&o.classList.add("d-none")}}),document.addEventListener("hidden.bs.dropdown",t=>{let e=t.target.closest(".actions .dropdown");if(e){let o=e.closest(".actions");o&&o.classList.add("d-none")}});function C(t,e){return fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(e||{})})}function s(t){let e=document.getElementById("otpError");e&&(t?(e.textContent=t,e.classList.remove("d-none")):(e.textContent="",e.classList.add("d-none")))}function c(){s(null),window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow;if(t.verifyInFlight)return;let e=(document.getElementById("otpUserName")?.value||"").trim(),o=(document.getElementById("otpCode")?.value||"").trim();if(!e||!o){s("User and code are required");return}let n=document.getElementById("btn-verify-otp");n&&(n.disabled=!0),t.verifyInFlight=!0;let a=performance.now();C("/api/auth/verify",{userName:e,code:o}).then(r=>{if(!r.ok)throw new Error("Invalid code");return r.json().catch(()=>({}))}).then(()=>{if(appLogger.info("OTP verify success",{user:e}),t.lastSendId){let w=Math.round(performance.now()-(t.lastSendCompletedTs||t.lastSendStartTs||a));appLogger.info("OTP verify latency",{user:e,sendId:t.lastSendId,verifyLatencyMs:w})}let r=document.getElementById("otp-login-modal");if(r&&window.bootstrap)try{(bootstrap.Modal.getInstance(r)||new bootstrap.Modal(r)).hide()}catch{}window.chatApp&&typeof window.chatApp.onAuthenticated=="function"?window.chatApp.onAuthenticated():appLogger.warn("chatApp.onAuthenticated not available")}).catch(r=>{appLogger.error("OTP verify failed",{user:e,error:r.message}),s(r.message||"Verification failed")}).finally(()=>{t.verifyInFlight=!1,n&&(n.disabled=!1)})}function d(t){t=t||{};let e=!!t.resend;s(null);let o=(document.getElementById("otpUserName")?.value||"").trim();if(!o){s("User selection is required");return}window.__otpFlow=window.__otpFlow||{};let n=window.__otpFlow,a=document.getElementById("btn-send-otp");if(a&&a.disabled&&!e)return;let r=document.getElementById("btn-resend-otp");if(e&&r&&r.disabled)return;let w=document.getElementById("otpContainer"),q=parseInt(w?.getAttribute("data-otp-timeout-ms")||"29000",10),k=3e4,O=parseInt(w?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10),u=document.getElementById("otpSendingIndicator"),I=document.getElementById("otpSendCountdown"),y=document.getElementById("otpRetryLink"),h=document.getElementById("otpRetryCountdown");if(!e&&a&&(a.disabled=!0),e&&r&&(r.disabled=!0),u){u.classList.remove("d-none","fade-hidden"),u.querySelectorAll("[data-state]")?.forEach(m=>m.classList.add("d-none"));let p=u.querySelector('[data-state="sending"]');p&&p.classList.remove("d-none")}if(y&&(y.classList.add("disabled-link"),y.dataset.cooldownLeft="0"),h&&(h.textContent=""),n.startAbort)try{n.startAbort.abort()}catch{}let L=new AbortController;n.startAbort=L,n.activeUser=o;let T="send_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);n.lastSendId=T,n.lastSendStartTs=performance.now(),n.lastSendCompletedTs=null;let A=k;I&&(I.textContent=Math.ceil(A/1e3)),n.countdownInterval&&clearInterval(n.countdownInterval),n.countdownInterval=setInterval(()=>{A-=1e3,A<=0?(I&&(I.textContent="0"),clearInterval(n.countdownInterval),n.countdownInterval=null):I&&(I.textContent=Math.ceil(A/1e3))},1e3),n.startTimeout&&clearTimeout(n.startTimeout),n.startTimeout=setTimeout(()=>{if(!L.signal.aborted){appLogger.warn("OTP send timeout",{user:o,timeoutMs:q,sendId:T});try{L.abort()}catch{}}},q),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o}),credentials:"same-origin",signal:L.signal}).then(p=>{if(!p.ok)throw new Error("Failed to send code");return p.json().catch(()=>({}))}).then(()=>{if(n.activeUser!==o||L.signal.aborted)return;n.lastSendCompletedTs=performance.now();let p=Math.round(n.lastSendCompletedTs-n.lastSendStartTs);if(appLogger.info("OTP code sent",{user:o,durationMs:p,sendId:T}),u){u.querySelectorAll("[data-state]")?.forEach(b=>b.classList.add("d-none"));let m=u.querySelector('[data-state="success"]');m&&m.classList.remove("d-none"),setTimeout(()=>{u.classList.add("fade-hidden")},2e3),setTimeout(()=>{u.classList.add("d-none")},2500)}if(!e){let m=l("#otp-step1"),b=l("#otp-step2");m&&b&&(m.classList.add("d-none"),b.classList.remove("d-none"));let B=l("#otpCode");B&&B.focus()}}).catch(p=>{let m=L.signal.aborted,b=performance.now(),B=Math.round(b-n.lastSendStartTs);if(m?appLogger.warn("OTP send aborted",{user:o,durationMs:B,sendId:T}):(appLogger.error("OTP send failed",{error:p.message,user:o,durationMs:B,sendId:T}),s(p.message||"Error sending code")),u)if(u.querySelectorAll("[data-state]")?.forEach(M=>M.classList.add("d-none")),m)u.classList.add("fade-hidden"),setTimeout(()=>u.classList.add("d-none"),250);else{let M=u.querySelector('[data-state="error"]');if(M&&M.classList.remove("d-none"),y){let E=O;y.classList.add("disabled-link"),y.dataset.cooldownLeft=E.toString(),h&&(h.textContent="("+Math.ceil(E/1e3)+"s)"),n.retryInterval&&clearInterval(n.retryInterval),n.retryInterval=setInterval(()=>{E-=1e3,E<=0?(clearInterval(n.retryInterval),n.retryInterval=null,y.classList.remove("disabled-link"),y.dataset.cooldownLeft="0",h&&(h.textContent="")):(y.dataset.cooldownLeft=E.toString(),h&&(h.textContent="("+Math.ceil(E/1e3)+"s)"))},1e3)}}}).finally(()=>{a&&(a.disabled=!1),r&&(r.disabled=!1),n.startTimeout&&(clearTimeout(n.startTimeout),n.startTimeout=null),n.countdownInterval&&(clearInterval(n.countdownInterval),n.countdownInterval=null)})}document.addEventListener("click",t=>{if(t.target.closest("#btn-send-otp")){d({resend:!1});return}if(t.target.closest("#btn-resend-otp")){d({resend:!0});return}if(t.target.closest("#btn-verify-otp")){c();return}if(t.target.closest("#btn-logout")){C("/api/auth/logout",{}).then(()=>{appLogger.info("Logout success"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()}).catch(()=>{appLogger.warn("Logout request error"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()});return}}),document.addEventListener("click",t=>{let e=t.target.closest("#otpRetryLink");if(e){if(t.preventDefault(),e.classList.contains("disabled-link"))return;d({resend:!1})}});let i=document.getElementById("otpCode");i&&i.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),c())});let f=document.getElementById("otp-login-modal");f&&(g(f,"show.bs.modal",()=>{s(null);let t=window.__otpFlow=window.__otpFlow||{};t.activeUser=null,l("#otp-step1")?.classList.remove("d-none"),l("#otp-step2")?.classList.add("d-none");let e=l("#otpCode");e&&(e.value="");let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(n=>{if(!n.ok)throw new Error("Failed to load users");return n.json()}).then(n=>{o.innerHTML='<option value="" disabled selected>Select user...</option>'+n.map(a=>`<option value="${a.userName}">${a.fullName||a.userName}</option>`).join(""),o.dataset.loaded="true"}).catch(n=>{s(n.message)})}),g(f,"hide.bs.modal",()=>{let t=window.__otpFlow;if(t?.startAbort)try{t.startAbort.abort()}catch{}t&&(t.activeUser=null),l("#otp-step1")?.classList.remove("d-none"),l("#otp-step2")?.classList.add("d-none"),s(null);let e=document.getElementById("btn-send-otp");e&&(e.disabled=!1);let o=document.getElementById("otpSendingIndicator");o&&(o.classList.add("d-none"),o.classList.remove("fade-hidden"),o.querySelectorAll("[data-state]")?.forEach(_=>_.classList.add("d-none")));let n=document.getElementById("btn-resend-otp");n&&(n.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null),t.retryInterval&&(clearInterval(t.retryInterval),t.retryInterval=null);let a=document.getElementById("otpSendCountdown");a&&(a.textContent="0");let r=document.getElementById("otpRetryCountdown");r&&(r.textContent="");let w=document.getElementById("otpRetryLink");w&&(w.classList.add("disabled-link"),w.dataset.cooldownLeft="0")}))});})();
