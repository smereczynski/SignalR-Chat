(()=>{(function(){if(window.appLogger)return;let c=null;function m(n){c=n}function l(n,s,a){let e={level:n,msg:s,traceId:c,ts:new Date().toISOString()};return a&&Object.keys(a).forEach(t=>e[t]=a[t]),e}function p(n,s,a){let e=l(n,s,a),t="["+e.level+"]";return e.traceId&&(t+="["+e.traceId+"]"),t+=" "+e.msg,n==="error"?console.error(t,a||""):n==="warn"?console.warn(t,a||""):console.log(t,a||""),e}let f=window.fetch;window.fetch=function(n,s){return f(n,s).then(a=>{try{let e=a.headers.get("X-Trace-Id");e&&m(e)}catch{}return a})},window.appLogger={info:(n,s)=>p("info",n,s),warn:(n,s)=>p("warn",n,s),error:(n,s)=>p("error",n,s),setTraceId:m,getTraceId:()=>c}})();document.addEventListener("DOMContentLoaded",()=>{appLogger.info("site.js init (vanilla)");let c=e=>document.querySelector(e),m=e=>Array.from(document.querySelectorAll(e)),l=(e,t,o,d)=>e&&e.addEventListener(t,o,d||!1),p=document.getElementById("users-list");p&&p.addEventListener("click",e=>{let t=e.target.closest("li");if(!t||!p.contains(t))return;let o=t.getAttribute("data-username"),d=document.getElementById("message-input");if(!o||!d)return;let r=d.value||"";if(r.startsWith("/")){let u=r.split(")");u.length>1&&(r=u.slice(1).join(")"))}r="/private("+o+") "+r.trim(),d.value=r,d.dispatchEvent(new Event("change")),d.focus()}),l(c("#expand-sidebar"),"click",()=>{document.querySelectorAll(".sidebar").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".users-container").forEach(e=>e.classList.remove("open"))}),l(c("#expand-users-list"),"click",()=>{document.querySelectorAll(".users-container").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".sidebar").forEach(e=>e.classList.remove("open"))}),document.addEventListener("click",e=>{(e.target.closest(".sidebar.open ul li a")||e.target.closest("#users-list li"))&&document.querySelectorAll(".sidebar, .users-container").forEach(t=>t.classList.remove("open"))}),m(".modal").forEach(e=>{l(e,"shown.bs.modal",()=>{let t=e.querySelector("input[type=text]:first-child");t&&t.focus()}),l(e,"hidden.bs.modal",()=>{e.querySelectorAll(".modal-body input:not(#newRoomName)").forEach(t=>t.value="")})}),document.addEventListener("click",e=>{let t=e.target.closest(".alert .btn-close");if(t){let o=t.closest(".alert");o&&(o.style.display="none")}}),window.bootstrap&&bootstrap.Tooltip&&m("[data-bs-toggle='tooltip']").forEach(e=>new bootstrap.Tooltip(e,{delay:{show:500}}));let f=document.getElementById("remove-message-modal");f&&l(f,"shown.bs.modal",e=>{let t=e.relatedTarget;if(t){let o=t.getAttribute("data-messageId"),d=document.getElementById("itemToDelete");o&&d&&(d.value=o)}}),document.addEventListener("mouseover",e=>{let t=e.target.closest(".ismine");if(t){let o=t.querySelector(".actions");o&&o.classList.remove("d-none")}}),document.addEventListener("mouseout",e=>{let t=e.target.closest(".ismine");if(t&&!t.querySelector(".dropdown-menu.show")){let o=t.querySelector(".actions");o&&o.classList.add("d-none")}}),document.addEventListener("hidden.bs.dropdown",e=>{let t=e.target.closest(".actions .dropdown");if(t){let o=t.closest(".actions");o&&o.classList.add("d-none")}});function n(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(t||{})})}function s(e){let t=document.getElementById("otpError");t&&(e?(t.textContent=e,t.classList.remove("d-none")):(t.textContent="",t.classList.add("d-none")))}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){s(null);let r=(document.getElementById("otpUserName")?.value||"").trim(),u=(document.getElementById("otpDestination")?.value||"").trim();if(!r){s("Username is required");return}n("/api/auth/start",{userName:r,destination:u||null}).then(i=>{if(!i.ok)throw new Error("Failed to send code");return i.json().catch(()=>({}))}).then(()=>{appLogger.info("OTP code sent",{user:r,dest:u||null}),c("#otp-step1")?.classList.add("d-none"),c("#otp-step2")?.classList.remove("d-none"),c("#otpCode")?.focus()}).catch(i=>{appLogger.error("OTP send failed",{error:i.message}),s(i.message||"Error sending code")});return}if(e.target.closest("#btn-verify-otp")){s(null);let r=(document.getElementById("otpUserName")?.value||"").trim(),u=(document.getElementById("otpCode")?.value||"").trim();if(!r||!u){s("Username and code are required");return}n("/api/auth/verify",{userName:r,code:u}).then(i=>{if(!i.ok)throw new Error("Invalid code");return i.json().catch(()=>({}))}).then(()=>{appLogger.info("OTP verify success",{user:r});let i=document.getElementById("otp-login-modal");if(i&&window.bootstrap)try{(bootstrap.Modal.getInstance(i)||new bootstrap.Modal(i)).hide()}catch{}window.chatApp&&typeof window.chatApp.onAuthenticated=="function"?window.chatApp.onAuthenticated():appLogger.warn("chatApp.onAuthenticated not available")}).catch(i=>{appLogger.error("OTP verify failed",{user:r,error:i.message}),s(i.message||"Verification failed")});return}if(e.target.closest("#btn-logout")){n("/api/auth/logout",{}).then(()=>{appLogger.info("Logout success"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()}).catch(()=>{appLogger.warn("Logout request error"),window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup()});return}});let a=document.getElementById("otp-login-modal");a&&l(a,"show.bs.modal",()=>{s(null),c("#otp-step1")?.classList.remove("d-none"),c("#otp-step2")?.classList.add("d-none");let e=c("#otpCode");e&&(e.value="")})});})();
