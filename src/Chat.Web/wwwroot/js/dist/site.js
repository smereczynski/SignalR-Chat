(()=>{(function(){if(window.appLogger)return;let d=null;function S(r){d=r}function w(r,u,l){let c={level:r,msg:u,traceId:d,ts:new Date().toISOString()};return l&&Object.keys(l).forEach(g=>c[g]=l[g]),c}function T(r,u,l){let c=w(r,u,l),g="["+c.level+"]";return c.traceId&&(g+="["+c.traceId+"]"),g+=" "+c.msg,r==="error"?console.error(g,l||""):r==="warn"?console.warn(g,l||""):console.log(g,l||""),c}let F=window.fetch;window.fetch=function(r,u){return F(r,u).then(l=>{try{let c=l.headers.get("X-Trace-Id");c&&S(c)}catch{}return l})},window.appLogger={info:(r,u)=>T("info",r,u),warn:(r,u)=>T("warn",r,u),error:(r,u)=>T("error",r,u),setTraceId:S,getTraceId:()=>d}})();(function(){window.i18n={},fetch("/api/localization/strings",{credentials:"same-origin"}).then(d=>d.ok?d.json():{}).then(d=>{window.i18n=d,document.dispatchEvent(new Event("i18n-loaded"))}).catch(()=>{window.i18n={Loading:"Loading\u2026",Error:"Error",Retry:"Retry",FailedToLoadUsers:"Failed to load users",UserSelectionRequired:"User selection is required",FailedToSendCode:"Failed to send code",ErrorSendingCode:"Error sending code",UserAndCodeRequired:"User and code are required",InvalidVerificationCode:"Invalid verification code",VerificationFailed:"Verification failed",SendingTooQuickly:"You are sending messages too quickly",SelectUser:"Select user..."}})})();document.addEventListener("DOMContentLoaded",()=>{appLogger.info("site.js init (vanilla)");let d=e=>document.querySelector(e),S=e=>Array.from(document.querySelectorAll(e)),w=(e,n,o,t)=>e&&e.addEventListener(n,o,t||!1);w(d("#expand-sidebar"),"click",()=>{document.querySelectorAll(".sidebar").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".users-container").forEach(e=>e.classList.remove("open"))}),w(d("#expand-users-list"),"click",()=>{document.querySelectorAll(".users-container").forEach(e=>e.classList.toggle("open")),document.querySelectorAll(".sidebar").forEach(e=>e.classList.remove("open"))}),document.addEventListener("click",e=>{(e.target.closest(".sidebar.open ul li a")||e.target.closest("#users-list li"))&&document.querySelectorAll(".sidebar, .users-container").forEach(n=>n.classList.remove("open"))}),S(".modal").forEach(e=>{w(e,"shown.bs.modal",()=>{let n=e.querySelector("input[type=text]:first-child");n&&n.focus()}),w(e,"hidden.bs.modal",()=>{e.querySelectorAll(".modal-body input:not(#newRoomName)").forEach(n=>n.value="")})}),document.addEventListener("click",e=>{let n=e.target.closest(".alert .btn-close");if(n){let o=n.closest(".alert");o&&(o.style.display="none")}}),window.bootstrap&&bootstrap.Tooltip&&S("[data-bs-toggle='tooltip']").forEach(e=>new bootstrap.Tooltip(e,{delay:{show:500}}));let T=document.getElementById("remove-message-modal");T&&w(T,"shown.bs.modal",e=>{let n=e.relatedTarget;if(n){let o=n.getAttribute("data-messageId"),t=document.getElementById("itemToDelete");o&&t&&(t.value=o)}}),document.addEventListener("mouseover",e=>{let n=e.target.closest(".ismine");if(n){let o=n.querySelector(".actions");o&&o.classList.remove("d-none")}}),document.addEventListener("mouseout",e=>{let n=e.target.closest(".ismine");if(n&&!n.querySelector(".dropdown-menu.show")){let o=n.querySelector(".actions");o&&o.classList.add("d-none")}}),document.addEventListener("hidden.bs.dropdown",e=>{let n=e.target.closest(".actions .dropdown");if(n){let o=n.closest(".actions");o&&o.classList.add("d-none")}});function F(e,n){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(n||{})})}function r(e){let n=document.getElementById("otpError");n&&(e?(n.textContent=e,n.classList.remove("d-none")):(n.textContent="",n.classList.add("d-none")))}function u(){r(null),window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow;if(e.verifyInFlight)return;let n=(document.getElementById("otpUserName")?.value||"").trim(),o=(document.getElementById("otpCode")?.value||"").trim();if(!n||!o){r(window.i18n.UserAndCodeRequired||"User and code are required");return}let t=document.getElementById("btn-verify-otp");t&&(t.disabled=!0),e.verifyInFlight=!0;let i=performance.now();F("/api/auth/verify",{userName:n,code:o}).then(s=>{if(!s.ok)throw new Error(window.i18n.InvalidVerificationCode||"Invalid code");return s.json().catch(()=>({}))}).then(()=>{if(appLogger.info("OTP verify success",{user:n}),e.lastSendId){let a=Math.round(performance.now()-(e.lastSendCompletedTs||e.lastSendStartTs||i));appLogger.info("OTP verify latency",{user:n,sendId:e.lastSendId,verifyLatencyMs:a})}let s=document.getElementById("otp-login-modal");if(s&&window.bootstrap)try{(bootstrap.Modal.getInstance(s)||new bootstrap.Modal(s)).hide()}catch{}window.chatApp&&typeof window.chatApp.onAuthenticated=="function"?window.chatApp.onAuthenticated():appLogger.warn("chatApp.onAuthenticated not available")}).catch(s=>{appLogger.error("OTP verify failed",{user:n,error:s.message}),r(s.message||window.i18n.VerificationFailed||"Verification failed")}).finally(()=>{e.verifyInFlight=!1,t&&(t.disabled=!1)})}function l(e){e=e||{};let n=!!e.resend;r(null);let o=(document.getElementById("otpUserName")?.value||"").trim();if(!o){r(window.i18n.UserSelectionRequired||"User selection is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,i=document.getElementById("btn-send-otp");if(i&&i.disabled&&!n)return;let s=document.getElementById("btn-resend-otp"),a=document.getElementById("otpContainer"),f=parseInt(a?.getAttribute("data-otp-resend-delay-ms")||"300000",10);t.firstSendAt=t.firstSendAt||0;let U=Date.now();if(!n)t.firstSendAt=U;else if(U-(t.firstSendAt||0)<f)return;let E=parseInt(a?.getAttribute("data-otp-timeout-ms")||"29000",10),C=3e4,N=parseInt(a?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10),m=document.getElementById("otpSendingIndicator"),A=document.getElementById("otpSendCountdown"),v=document.getElementById("otpRetryLink"),I=document.getElementById("otpRetryCountdown");if(!n&&i&&(i.disabled=!0),n&&s&&(s.disabled=!0),m){m.classList.remove("d-none","fade-hidden"),m.querySelectorAll("[data-state]")?.forEach(y=>y.classList.add("d-none"));let p=m.querySelector('[data-state="sending"]');p&&p.classList.remove("d-none")}if(v&&(v.classList.add("disabled-link"),v.dataset.cooldownLeft="0"),I&&(I.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let B=new AbortController;t.startAbort=B,t.activeUser=o;let k="send_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);t.lastSendId=k,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let _=C;A&&(A.textContent=Math.ceil(_/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{_-=1e3,_<=0?(A&&(A.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):A&&(A.textContent=Math.ceil(_/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!B.signal.aborted){appLogger.warn("OTP send timeout",{user:o,timeoutMs:E,sendId:k});try{B.abort()}catch{}}},E),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o}),credentials:"same-origin",signal:B.signal}).then(p=>{if(!p.ok)throw new Error(window.i18n.FailedToSendCode||"Failed to send code");return p.json().catch(()=>({}))}).then(()=>{if(t.activeUser!==o||B.signal.aborted)return;t.lastSendCompletedTs=performance.now();let p=Math.round(t.lastSendCompletedTs-t.lastSendStartTs);if(appLogger.info("OTP code sent",{user:o,durationMs:p,sendId:k}),m){m.querySelectorAll("[data-state]")?.forEach(M=>M.classList.add("d-none"));let y=m.querySelector('[data-state="success"]');y&&y.classList.remove("d-none"),setTimeout(()=>{m.classList.add("fade-hidden")},2e3),setTimeout(()=>{m.classList.add("d-none")},2500)}if(!n){let y=d("#otp-step1"),M=d("#otp-step2");y&&M&&(y.classList.add("d-none"),M.classList.remove("d-none"));let q=d("#otpCode");q&&q.focus();let h=document.getElementById("btn-resend-otp");if(h){h.disabled=!0;let L=(t.firstSendAt||Date.now())+f;t.resendAvailInterval&&clearInterval(t.resendAvailInterval);let R=()=>{let x=L-Date.now();if(x<=0)clearInterval(t.resendAvailInterval),t.resendAvailInterval=null,h.disabled=!1,h.textContent="Resend";else{let D=Math.ceil(x/1e3);h.textContent="Resend in "+D+"s"}};R(),t.resendAvailInterval=setInterval(R,1e3)}}}).catch(p=>{let y=B.signal.aborted,M=performance.now(),q=Math.round(M-t.lastSendStartTs);if(y?appLogger.warn("OTP send aborted",{user:o,durationMs:q,sendId:k}):(appLogger.error("OTP send failed",{error:p.message,user:o,durationMs:q,sendId:k}),r(p.message||window.i18n.ErrorSendingCode||"Error sending code")),m)if(m.querySelectorAll("[data-state]")?.forEach(h=>h.classList.add("d-none")),y)m.classList.add("fade-hidden"),setTimeout(()=>m.classList.add("d-none"),250);else{let h=m.querySelector('[data-state="error"]');if(h&&h.classList.remove("d-none"),v){let L=N;v.classList.add("disabled-link"),v.dataset.cooldownLeft=L.toString(),I&&(I.textContent="("+Math.ceil(L/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{L-=1e3,L<=0?(clearInterval(t.retryInterval),t.retryInterval=null,v.classList.remove("disabled-link"),v.dataset.cooldownLeft="0",I&&(I.textContent="")):(v.dataset.cooldownLeft=L.toString(),I&&(I.textContent="("+Math.ceil(L/1e3)+"s)"))},1e3)}}}).finally(()=>{i&&(i.disabled=!1),s&&(s.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){l({resend:!1});return}if(e.target.closest("#btn-resend-otp")){l({resend:!0});return}if(e.target.closest("#btn-verify-otp")){u();return}if(e.target.closest("#btn-logout")){F("/api/auth/logout",{}).then(()=>{appLogger.info("Logout success")}).catch(()=>{appLogger.warn("Logout request error")}).finally(()=>{window.chatApp?.logoutCleanup&&window.chatApp.logoutCleanup(),window.location.replace("/login?ReturnUrl=/chat")});return}}),document.addEventListener("click",e=>{let n=e.target.closest("#otpRetryLink");if(n){if(e.preventDefault(),n.classList.contains("disabled-link"))return;l({resend:!1})}});let c=document.getElementById("otpCode");c&&c.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),u())});let g=document.getElementById("otp-login-modal");g&&(w(g,"show.bs.modal",()=>{r(null);let e=window.__otpFlow=window.__otpFlow||{};e.activeUser=null,d("#otp-step1")?.classList.remove("d-none"),d("#otp-step2")?.classList.add("d-none");let n=d("#otpCode");n&&(n.value="");let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(t=>{if(!t.ok)throw new Error(window.i18n.FailedToLoadUsers||"Failed to load users");return t.json()}).then(t=>{let i=window.i18n.SelectUser||"Select user...";o.innerHTML='<option value="" disabled selected>'+i+"</option>"+t.map(s=>`<option value="${s.userName}">${s.fullName||s.userName}</option>`).join(""),o.dataset.loaded="true"}).catch(t=>{r(t.message)})}),w(g,"hide.bs.modal",()=>{let e=window.__otpFlow;if(e?.startAbort)try{e.startAbort.abort()}catch{}e&&(e.activeUser=null),d("#otp-step1")?.classList.remove("d-none"),d("#otp-step2")?.classList.add("d-none"),r(null);let n=document.getElementById("btn-send-otp");n&&(n.disabled=!1);let o=document.getElementById("otpSendingIndicator");o&&(o.classList.add("d-none"),o.classList.remove("fade-hidden"),o.querySelectorAll("[data-state]")?.forEach(f=>f.classList.add("d-none")));let t=document.getElementById("btn-resend-otp");t&&(t.disabled=!1),e.startTimeout&&(clearTimeout(e.startTimeout),e.startTimeout=null),e.countdownInterval&&(clearInterval(e.countdownInterval),e.countdownInterval=null),e.retryInterval&&(clearInterval(e.retryInterval),e.retryInterval=null);let i=document.getElementById("otpSendCountdown");i&&(i.textContent="0");let s=document.getElementById("otpRetryCountdown");s&&(s.textContent="");let a=document.getElementById("otpRetryLink");a&&(a.classList.add("disabled-link"),a.dataset.cooldownLeft="0")}));let O=document.getElementById("languageModal");if(O){let n=function(s,a){!s||!a||(Array.from(s.classList).filter(f=>f.startsWith("fi-")).forEach(f=>s.classList.remove(f)),s.classList.add("fi","fis",`fi-${a}`))};var P=n;let e={en:"gb","pl-PL":"pl","de-DE":"de","cs-CZ":"cz","sk-SK":"sk","uk-UA":"ua","lt-LT":"lt","ru-RU":"ru"},o=document.documentElement.lang||"en",t="en";if(o.length===2){let s=Object.keys(e).find(a=>a.toLowerCase().startsWith(o.toLowerCase()));s&&(t=s)}else t=o;let i=document.getElementById("currentLanguageFlag");n(i,e[t]),w(O,"show.bs.modal",()=>{S("#languageModal .language-list button").forEach(s=>{s.getAttribute("data-culture")===t?s.classList.add("active"):s.classList.remove("active")})}),document.addEventListener("click",s=>{let a=s.target.closest("#languageModal .language-list button");if(a){let f=a.getAttribute("data-culture"),U=a.getAttribute("data-flag");if(f&&f!==t){appLogger.info("Changing language",{from:t,to:f});let b=document.createElement("form");b.method="POST",b.action="/Culture/Set";let E=document.createElement("input");E.type="hidden",E.name="culture",E.value=f,b.appendChild(E);let C=document.createElement("input");C.type="hidden",C.name="returnUrl",C.value=window.location.pathname+window.location.search,b.appendChild(C),document.body.appendChild(b),b.submit()}}})}});})();
