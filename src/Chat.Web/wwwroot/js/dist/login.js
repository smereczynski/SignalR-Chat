(()=>{(function(){let E=r=>document.querySelector(r),U=(r,s,p,y)=>r&&r.addEventListener(s,p,y||!1);function b(r,s){return fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(s||{})})}function u(r){let s=document.getElementById("otpError");s&&(r?(s.textContent=r,s.classList.remove("d-none")):(s.textContent="",s.classList.add("d-none")))}document.addEventListener("DOMContentLoaded",()=>{let r=document.getElementById("otpUserName");function s(){let t=document.getElementById("otpUserName");if(t){let o=t.querySelector('option[data-i18n-key="selectUser"]');o&&window.i18n?.selectUser&&(o.textContent=window.i18n.selectUser)}}document.addEventListener("i18n-loaded",s),r&&r.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(t=>{if(!t.ok)throw new Error(window.i18n?.failedToLoadUsers||"Failed to load users");return t.json()}).then(t=>{r.innerHTML="";let o=document.createElement("option");o.value="",o.disabled=!0,o.selected=!0,o.textContent=window.i18n?.selectUser||"Select user...",o.dataset.i18nKey="selectUser",r.appendChild(o),(t||[]).forEach(e=>{let i=document.createElement("option");i.value=String(e.userName||""),i.textContent=String(e.fullName||e.userName||""),r.appendChild(i)}),r.dataset.loaded="true",s()}).catch(t=>u(t.message));function p(t){u(null);let o=(document.getElementById("otpUserName")?.value||"").trim();if(!o){u(window.i18n?.userSelectionRequired||"User selection is required");return}window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow,i=document.getElementById("otpContainer"),g=parseInt(i?.getAttribute("data-otp-resend-delay-ms")||"300000",10);if(!t)e.firstSendAt=Date.now();else{let a=Date.now()-(e.firstSendAt||0);if(a<g){let w=Math.ceil((g-a)/1e3),l=window.i18n?.pleaseWaitSeconds?.replace("{0}",w)||`Please wait ${w} seconds before resending`;u(l);return}}let n=document.getElementById("otpSendingIndicator"),d=document.getElementById("otpSendCountdown"),c=document.getElementById("otpRetryLink"),f=document.getElementById("otpRetryCountdown"),h=document.getElementById("btn-resend-otp"),v=document.getElementById("btn-send-otp");!t&&v&&(v.disabled=!0),t&&h&&(h.disabled=!0);let S=parseInt(i?.getAttribute("data-otp-timeout-ms")||"29000",10),L=3e4,T=parseInt(i?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10);if(n){n.classList.remove("d-none","fade-hidden"),n.querySelectorAll("[data-state]")?.forEach(w=>w.classList.add("d-none"));let a=n.querySelector('[data-state="sending"]');a&&a.classList.remove("d-none")}if(c&&(c.classList.add("disabled-link"),c.dataset.cooldownLeft="0"),f&&(f.textContent=""),e.startAbort)try{e.startAbort.abort()}catch{}let m=new AbortController;e.startAbort=m,e.activeUser=o,e.lastSendStartTs=performance.now(),e.lastSendCompletedTs=null;let I=L;d&&(d.textContent=Math.ceil(I/1e3)),e.countdownInterval&&clearInterval(e.countdownInterval),e.countdownInterval=setInterval(()=>{I-=1e3,I<=0?(d&&(d.textContent="0"),clearInterval(e.countdownInterval),e.countdownInterval=null):d&&(d.textContent=Math.ceil(I/1e3))},1e3),e.startTimeout&&clearTimeout(e.startTimeout),e.startTimeout=setTimeout(()=>{if(!m.signal.aborted)try{m.abort()}catch{}},S),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o}),credentials:"same-origin",signal:m.signal}).then(a=>{if(!a.ok)throw new Error(window.i18n?.failedToSendCode||"Failed to send code");return a.json().catch(()=>({}))}).then(()=>{e.activeUser!==o||m.signal.aborted||(e.lastSendCompletedTs=performance.now(),t||(E("#otp-step1")?.classList.add("d-none"),E("#otp-step2")?.classList.remove("d-none"),document.getElementById("otpCode")?.focus()),n&&(n.querySelectorAll("[data-state]")?.forEach(a=>a.classList.add("d-none")),n.querySelector('[data-state="success"]')?.classList.remove("d-none"),setTimeout(()=>n.classList.add("fade-hidden"),2e3),setTimeout(()=>n.classList.add("d-none"),2500)))}).catch(a=>{if(!m.signal.aborted&&(u(a.message||window.i18n?.errorSendingCode||"Error sending code"),n&&(n.querySelectorAll("[data-state]")?.forEach(l=>l.classList.add("d-none")),n.querySelector('[data-state="error"]')?.classList.remove("d-none")),c)){let l=T;c.classList.add("disabled-link"),c.dataset.cooldownLeft=l.toString(),f&&(f.textContent="("+Math.ceil(l/1e3)+"s)"),e.retryInterval&&clearInterval(e.retryInterval),e.retryInterval=setInterval(()=>{l-=1e3,l<=0?(clearInterval(e.retryInterval),e.retryInterval=null,c.classList.remove("disabled-link"),c.dataset.cooldownLeft="0",f&&(f.textContent="")):(c.dataset.cooldownLeft=l.toString(),f&&(f.textContent="("+Math.ceil(l/1e3)+"s)"))},1e3)}}).finally(()=>{v&&(v.disabled=!1),h&&(h.disabled=!1),e.startTimeout&&(clearTimeout(e.startTimeout),e.startTimeout=null),e.countdownInterval&&(clearInterval(e.countdownInterval),e.countdownInterval=null)})}function y(){u(null),window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow;if(t.verifyInFlight)return;let o=(document.getElementById("otpUserName")?.value||"").trim(),e=(document.getElementById("otpCode")?.value||"").trim();if(!o||!e){u(window.i18n?.userAndCodeRequired||"User and code are required");return}let i=document.getElementById("btn-verify-otp");i&&(i.disabled=!0),t.verifyInFlight=!0;let g=typeof window.__returnUrl=="string"?window.__returnUrl:"/chat";b("/api/auth/verify",{userName:o,code:e,returnUrl:g}).then(n=>{if(!n.ok)throw new Error(window.i18n?.invalidVerificationCode||"Invalid code");return n.json().catch(()=>({}))}).then(n=>{let d=n&&typeof n.nextUrl=="string"?n.nextUrl:"/chat";d.startsWith("/")&&!d.startsWith("//")?window.location.href=d:window.location.href="/chat"}).catch(n=>u(n.message||window.i18n?.verificationFailed||"Verification failed")).finally(()=>{t.verifyInFlight=!1,i&&(i.disabled=!1)})}document.addEventListener("click",t=>{if(t.target.closest("#btn-send-otp")){p(!1);return}if(t.target.closest("#btn-resend-otp")){p(!0);return}if(t.target.closest("#btn-verify-otp")){y();return}});let C=document.getElementById("otpCode");C&&C.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),y())})})})();})();
