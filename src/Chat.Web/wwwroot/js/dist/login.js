(()=>{(function(){let h=i=>document.querySelector(i),T=(i,r,p,y)=>i&&i.addEventListener(r,p,y||!1);function b(i,r){return fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(r||{})})}function u(i){let r=document.getElementById("otpError");r&&(i?(r.textContent=i,r.classList.remove("d-none")):(r.textContent="",r.classList.add("d-none")))}document.addEventListener("DOMContentLoaded",()=>{let i=document.getElementById("btn-microsoft-login");i&&i.addEventListener("click",n=>{n.preventDefault(),window.location.href="/login/entra"});function r(n){u(null);let f=(document.getElementById("otpEmail")?.value||"").trim();if(!f){u(window.i18n?.emailRequired||"Email is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,l=document.getElementById("otpContainer"),v=parseInt(l?.getAttribute("data-otp-resend-delay-ms")||"300000",10);if(!n)t.firstSendAt=Date.now();else{let o=Date.now()-(t.firstSendAt||0);if(o<v){let w=Math.ceil((v-o)/1e3),d=window.i18n?.pleaseWaitSeconds?.replace("{0}",w)||`Please wait ${w} seconds before resending`;u(d);return}}let e=document.getElementById("otpSendingIndicator"),a=document.getElementById("otpSendCountdown"),s=document.getElementById("otpRetryLink"),c=document.getElementById("otpRetryCountdown"),g=document.getElementById("btn-resend-otp"),I=document.getElementById("btn-send-otp");!n&&I&&(I.disabled=!0),n&&g&&(g.disabled=!0);let C=parseInt(l?.getAttribute("data-otp-timeout-ms")||"29000",10),S=3e4,B=parseInt(l?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10);if(e){e.classList.remove("d-none","fade-hidden"),e.querySelectorAll("[data-state]")?.forEach(w=>w.classList.add("d-none"));let o=e.querySelector('[data-state="sending"]');o&&o.classList.remove("d-none")}if(s&&(s.classList.add("disabled-link"),s.dataset.cooldownLeft="0"),c&&(c.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let m=new AbortController;t.startAbort=m,t.activeEmail=f,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let E=S;a&&(a.textContent=Math.ceil(E/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{E-=1e3,E<=0?(a&&(a.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):a&&(a.textContent=Math.ceil(E/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!m.signal.aborted)try{m.abort()}catch{}},C),b("/api/auth/start",{userName:f}).then(o=>{if(!o.ok)throw new Error(window.i18n?.failedToSendCode||"Failed to send code");return o.json().catch(()=>({}))}).then(()=>{t.activeEmail!==f||m.signal.aborted||(t.lastSendCompletedTs=performance.now(),n||(h("#otp-step1")?.classList.add("d-none"),h("#otp-step2")?.classList.remove("d-none"),document.getElementById("otpCode")?.focus()),e&&(e.querySelectorAll("[data-state]")?.forEach(o=>o.classList.add("d-none")),e.querySelector('[data-state="success"]')?.classList.remove("d-none"),setTimeout(()=>e.classList.add("fade-hidden"),2e3),setTimeout(()=>e.classList.add("d-none"),2500)))}).catch(o=>{if(!m.signal.aborted&&(u(o.message||window.i18n?.errorSendingCode||"Error sending code"),e&&(e.querySelectorAll("[data-state]")?.forEach(d=>d.classList.add("d-none")),e.querySelector('[data-state="error"]')?.classList.remove("d-none")),s)){let d=B;s.classList.add("disabled-link"),s.dataset.cooldownLeft=d.toString(),c&&(c.textContent="("+Math.ceil(d/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{d-=1e3,d<=0?(clearInterval(t.retryInterval),t.retryInterval=null,s.classList.remove("disabled-link"),s.dataset.cooldownLeft="0",c&&(c.textContent="")):(s.dataset.cooldownLeft=d.toString(),c&&(c.textContent="("+Math.ceil(d/1e3)+"s)"))},1e3)}}).finally(()=>{I&&(I.disabled=!1),g&&(g.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}function p(){u(null),window.__otpFlow=window.__otpFlow||{};let n=window.__otpFlow;if(n.verifyInFlight)return;let f=(document.getElementById("otpEmail")?.value||"").trim(),t=(document.getElementById("otpCode")?.value||"").trim();if(!f||!t){u(window.i18n?.emailAndCodeRequired||"Email and code are required");return}let l=document.getElementById("btn-verify-otp");l&&(l.disabled=!0),n.verifyInFlight=!0;let v=typeof window.__returnUrl=="string"?window.__returnUrl:"/chat";b("/api/auth/verify",{userName:f,code:t,returnUrl:v}).then(e=>{if(!e.ok)throw new Error(window.i18n?.invalidVerificationCode||"Invalid code");return e.json().catch(()=>({}))}).then(e=>{let a=e&&typeof e.nextUrl=="string"?e.nextUrl:"/chat";a.startsWith("/")&&!a.startsWith("//")?window.location.href=a:window.location.href="/chat"}).catch(e=>u(e.message||window.i18n?.verificationFailed||"Verification failed")).finally(()=>{n.verifyInFlight=!1,l&&(l.disabled=!1)})}document.addEventListener("click",n=>{if(n.target.closest("#btn-send-otp")){r(!1);return}if(n.target.closest("#btn-resend-otp")){r(!0);return}if(n.target.closest("#btn-verify-otp")){p();return}});let y=document.getElementById("otpCode");y&&y.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),p())});let L=document.getElementById("otpEmail");L&&L.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),r(!1))})})})();})();
