(()=>{(function(){let I=o=>document.querySelector(o),T=(o,r,w,y)=>o&&o.addEventListener(r,w,y||!1);function E(o,r){return fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(r||{})})}function u(o){let r=document.getElementById("otpError");r&&(o?(r.textContent=o,r.classList.remove("d-none")):(r.textContent="",r.classList.add("d-none")))}document.addEventListener("DOMContentLoaded",()=>{let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(e=>{if(!e.ok)throw new Error("Failed to load users");return e.json()}).then(e=>{o.innerHTML='<option value="" disabled selected>Select user...</option>'+e.map(s=>`<option value="${s.userName}">${s.fullName||s.userName}</option>`).join(""),o.dataset.loaded="true"}).catch(e=>u(e.message));function r(e){u(null);let s=(document.getElementById("otpUserName")?.value||"").trim();if(!s){u("User selection is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,i=document.getElementById("otpContainer"),f=parseInt(i?.getAttribute("data-otp-resend-delay-ms")||"300000",10);if(!e)t.firstSendAt=Date.now();else if(Date.now()-(t.firstSendAt||0)<f)return;let n=document.getElementById("otpSendingIndicator"),m=document.getElementById("otpSendCountdown"),d=document.getElementById("otpRetryLink"),l=document.getElementById("otpRetryCountdown"),h=document.getElementById("btn-resend-otp"),v=document.getElementById("btn-send-otp");!e&&v&&(v.disabled=!0),e&&h&&(h.disabled=!0);let L=parseInt(i?.getAttribute("data-otp-timeout-ms")||"29000",10),C=3e4,S=parseInt(i?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10);if(n){n.classList.remove("d-none","fade-hidden"),n.querySelectorAll("[data-state]")?.forEach(b=>b.classList.add("d-none"));let a=n.querySelector('[data-state="sending"]');a&&a.classList.remove("d-none")}if(d&&(d.classList.add("disabled-link"),d.dataset.cooldownLeft="0"),l&&(l.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let p=new AbortController;t.startAbort=p,t.activeUser=s,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let g=C;m&&(m.textContent=Math.ceil(g/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{g-=1e3,g<=0?(m&&(m.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):m&&(m.textContent=Math.ceil(g/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!p.signal.aborted)try{p.abort()}catch{}},L),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:s}),credentials:"same-origin",signal:p.signal}).then(a=>{if(!a.ok)throw new Error("Failed to send code");return a.json().catch(()=>({}))}).then(()=>{t.activeUser!==s||p.signal.aborted||(t.lastSendCompletedTs=performance.now(),e||(I("#otp-step1")?.classList.add("d-none"),I("#otp-step2")?.classList.remove("d-none"),document.getElementById("otpCode")?.focus()),n&&(n.querySelectorAll("[data-state]")?.forEach(a=>a.classList.add("d-none")),n.querySelector('[data-state="success"]')?.classList.remove("d-none"),setTimeout(()=>n.classList.add("fade-hidden"),2e3),setTimeout(()=>n.classList.add("d-none"),2500)))}).catch(a=>{if(!p.signal.aborted&&(u(a.message||"Error sending code"),n&&(n.querySelectorAll("[data-state]")?.forEach(c=>c.classList.add("d-none")),n.querySelector('[data-state="error"]')?.classList.remove("d-none")),d)){let c=S;d.classList.add("disabled-link"),d.dataset.cooldownLeft=c.toString(),l&&(l.textContent="("+Math.ceil(c/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{c-=1e3,c<=0?(clearInterval(t.retryInterval),t.retryInterval=null,d.classList.remove("disabled-link"),d.dataset.cooldownLeft="0",l&&(l.textContent="")):(d.dataset.cooldownLeft=c.toString(),l&&(l.textContent="("+Math.ceil(c/1e3)+"s)"))},1e3)}}).finally(()=>{v&&(v.disabled=!1),h&&(h.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}function w(){u(null),window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow;if(e.verifyInFlight)return;let s=(document.getElementById("otpUserName")?.value||"").trim(),t=(document.getElementById("otpCode")?.value||"").trim();if(!s||!t){u("User and code are required");return}let i=document.getElementById("btn-verify-otp");i&&(i.disabled=!0),e.verifyInFlight=!0,E("/api/auth/verify",{userName:s,code:t}).then(f=>{if(!f.ok)throw new Error("Invalid code");return f.json().catch(()=>({}))}).then(()=>{let n=new URLSearchParams(window.location.search).get("ReturnUrl")||"/chat";n.startsWith("/")&&!n.startsWith("//")?window.location.href=n:window.location.href="/chat"}).catch(f=>u(f.message||"Verification failed")).finally(()=>{e.verifyInFlight=!1,i&&(i.disabled=!1)})}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){r(!1);return}if(e.target.closest("#btn-resend-otp")){r(!0);return}if(e.target.closest("#btn-verify-otp")){w();return}});let y=document.getElementById("otpCode");y&&y.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),w())})})})();})();
