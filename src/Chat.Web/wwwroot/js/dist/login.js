(()=>{(function(){let E=o=>document.querySelector(o),T=(o,s,p,w)=>o&&o.addEventListener(s,p,w||!1);function b(o,s){return fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(s||{})})}function c(o){let s=document.getElementById("otpError");s&&(o?(s.textContent=o,s.classList.remove("d-none")):(s.textContent="",s.classList.add("d-none")))}document.addEventListener("DOMContentLoaded",()=>{let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(e=>{if(!e.ok)throw new Error("Failed to load users");return e.json()}).then(e=>{o.innerHTML="";let a=document.createElement("option");a.value="",a.disabled=!0,a.selected=!0,a.textContent="Select user...",o.appendChild(a),(e||[]).forEach(t=>{let d=document.createElement("option");d.value=String(t.userName||""),d.textContent=String(t.fullName||t.userName||""),o.appendChild(d)}),o.dataset.loaded="true"}).catch(e=>c(e.message));function s(e){c(null);let a=(document.getElementById("otpUserName")?.value||"").trim();if(!a){c("User selection is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,d=document.getElementById("otpContainer"),y=parseInt(d?.getAttribute("data-otp-resend-delay-ms")||"300000",10);if(!e)t.firstSendAt=Date.now();else{let r=Date.now()-(t.firstSendAt||0);if(r<y){let I=Math.ceil((y-r)/1e3);c(`Please wait ${I} seconds before resending`);return}}let n=document.getElementById("otpSendingIndicator"),i=document.getElementById("otpSendCountdown"),l=document.getElementById("otpRetryLink"),u=document.getElementById("otpRetryCountdown"),h=document.getElementById("btn-resend-otp"),g=document.getElementById("btn-send-otp");!e&&g&&(g.disabled=!0),e&&h&&(h.disabled=!0);let C=parseInt(d?.getAttribute("data-otp-timeout-ms")||"29000",10),L=3e4,S=parseInt(d?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10);if(n){n.classList.remove("d-none","fade-hidden"),n.querySelectorAll("[data-state]")?.forEach(I=>I.classList.add("d-none"));let r=n.querySelector('[data-state="sending"]');r&&r.classList.remove("d-none")}if(l&&(l.classList.add("disabled-link"),l.dataset.cooldownLeft="0"),u&&(u.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let m=new AbortController;t.startAbort=m,t.activeUser=a,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let v=L;i&&(i.textContent=Math.ceil(v/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{v-=1e3,v<=0?(i&&(i.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):i&&(i.textContent=Math.ceil(v/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!m.signal.aborted)try{m.abort()}catch{}},C),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:a}),credentials:"same-origin",signal:m.signal}).then(r=>{if(!r.ok)throw new Error("Failed to send code");return r.json().catch(()=>({}))}).then(()=>{t.activeUser!==a||m.signal.aborted||(t.lastSendCompletedTs=performance.now(),e||(E("#otp-step1")?.classList.add("d-none"),E("#otp-step2")?.classList.remove("d-none"),document.getElementById("otpCode")?.focus()),n&&(n.querySelectorAll("[data-state]")?.forEach(r=>r.classList.add("d-none")),n.querySelector('[data-state="success"]')?.classList.remove("d-none"),setTimeout(()=>n.classList.add("fade-hidden"),2e3),setTimeout(()=>n.classList.add("d-none"),2500)))}).catch(r=>{if(!m.signal.aborted&&(c(r.message||"Error sending code"),n&&(n.querySelectorAll("[data-state]")?.forEach(f=>f.classList.add("d-none")),n.querySelector('[data-state="error"]')?.classList.remove("d-none")),l)){let f=S;l.classList.add("disabled-link"),l.dataset.cooldownLeft=f.toString(),u&&(u.textContent="("+Math.ceil(f/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{f-=1e3,f<=0?(clearInterval(t.retryInterval),t.retryInterval=null,l.classList.remove("disabled-link"),l.dataset.cooldownLeft="0",u&&(u.textContent="")):(l.dataset.cooldownLeft=f.toString(),u&&(u.textContent="("+Math.ceil(f/1e3)+"s)"))},1e3)}}).finally(()=>{g&&(g.disabled=!1),h&&(h.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}function p(){c(null),window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow;if(e.verifyInFlight)return;let a=(document.getElementById("otpUserName")?.value||"").trim(),t=(document.getElementById("otpCode")?.value||"").trim();if(!a||!t){c("User and code are required");return}let d=document.getElementById("btn-verify-otp");d&&(d.disabled=!0),e.verifyInFlight=!0;let y=typeof window.__returnUrl=="string"?window.__returnUrl:"/chat";b("/api/auth/verify",{userName:a,code:t,returnUrl:y}).then(n=>{if(!n.ok)throw new Error("Invalid code");return n.json().catch(()=>({}))}).then(n=>{let i=n&&typeof n.nextUrl=="string"?n.nextUrl:"/chat";i.startsWith("/")&&!i.startsWith("//")?window.location.href=i:window.location.href="/chat"}).catch(n=>c(n.message||"Verification failed")).finally(()=>{e.verifyInFlight=!1,d&&(d.disabled=!1)})}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){s(!1);return}if(e.target.closest("#btn-resend-otp")){s(!0);return}if(e.target.closest("#btn-verify-otp")){p();return}});let w=document.getElementById("otpCode");w&&w.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),p())})})})();})();
