(()=>{(function(){let I=o=>document.querySelector(o),T=(o,a,p,w)=>o&&o.addEventListener(a,p,w||!1);function b(o,a){return fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(a||{})})}function f(o){let a=document.getElementById("otpError");a&&(o?(a.textContent=o,a.classList.remove("d-none")):(a.textContent="",a.classList.add("d-none")))}document.addEventListener("DOMContentLoaded",()=>{let o=document.getElementById("otpUserName");o&&o.dataset.loaded!=="true"&&fetch("/api/auth/users",{credentials:"same-origin"}).then(e=>{if(!e.ok)throw new Error("Failed to load users");return e.json()}).then(e=>{o.innerHTML="";let r=document.createElement("option");r.value="",r.disabled=!0,r.selected=!0,r.textContent="Select user...",o.appendChild(r),(e||[]).forEach(t=>{let s=document.createElement("option");s.value=String(t.userName||""),s.textContent=String(t.fullName||t.userName||""),o.appendChild(s)}),o.dataset.loaded="true"}).catch(e=>f(e.message));function a(e){f(null);let r=(document.getElementById("otpUserName")?.value||"").trim();if(!r){f("User selection is required");return}window.__otpFlow=window.__otpFlow||{};let t=window.__otpFlow,s=document.getElementById("otpContainer"),v=parseInt(s?.getAttribute("data-otp-resend-delay-ms")||"300000",10);if(!e)t.firstSendAt=Date.now();else if(Date.now()-(t.firstSendAt||0)<v)return;let n=document.getElementById("otpSendingIndicator"),i=document.getElementById("otpSendCountdown"),l=document.getElementById("otpRetryLink"),c=document.getElementById("otpRetryCountdown"),y=document.getElementById("btn-resend-otp"),h=document.getElementById("btn-send-otp");!e&&h&&(h.disabled=!0),e&&y&&(y.disabled=!0);let C=parseInt(s?.getAttribute("data-otp-timeout-ms")||"29000",10),L=3e4,S=parseInt(s?.getAttribute("data-otp-retry-cooldown-ms")||"5000",10);if(n){n.classList.remove("d-none","fade-hidden"),n.querySelectorAll("[data-state]")?.forEach(E=>E.classList.add("d-none"));let d=n.querySelector('[data-state="sending"]');d&&d.classList.remove("d-none")}if(l&&(l.classList.add("disabled-link"),l.dataset.cooldownLeft="0"),c&&(c.textContent=""),t.startAbort)try{t.startAbort.abort()}catch{}let m=new AbortController;t.startAbort=m,t.activeUser=r,t.lastSendStartTs=performance.now(),t.lastSendCompletedTs=null;let g=L;i&&(i.textContent=Math.ceil(g/1e3)),t.countdownInterval&&clearInterval(t.countdownInterval),t.countdownInterval=setInterval(()=>{g-=1e3,g<=0?(i&&(i.textContent="0"),clearInterval(t.countdownInterval),t.countdownInterval=null):i&&(i.textContent=Math.ceil(g/1e3))},1e3),t.startTimeout&&clearTimeout(t.startTimeout),t.startTimeout=setTimeout(()=>{if(!m.signal.aborted)try{m.abort()}catch{}},C),fetch("/api/auth/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:r}),credentials:"same-origin",signal:m.signal}).then(d=>{if(!d.ok)throw new Error("Failed to send code");return d.json().catch(()=>({}))}).then(()=>{t.activeUser!==r||m.signal.aborted||(t.lastSendCompletedTs=performance.now(),e||(I("#otp-step1")?.classList.add("d-none"),I("#otp-step2")?.classList.remove("d-none"),document.getElementById("otpCode")?.focus()),n&&(n.querySelectorAll("[data-state]")?.forEach(d=>d.classList.add("d-none")),n.querySelector('[data-state="success"]')?.classList.remove("d-none"),setTimeout(()=>n.classList.add("fade-hidden"),2e3),setTimeout(()=>n.classList.add("d-none"),2500)))}).catch(d=>{if(!m.signal.aborted&&(f(d.message||"Error sending code"),n&&(n.querySelectorAll("[data-state]")?.forEach(u=>u.classList.add("d-none")),n.querySelector('[data-state="error"]')?.classList.remove("d-none")),l)){let u=S;l.classList.add("disabled-link"),l.dataset.cooldownLeft=u.toString(),c&&(c.textContent="("+Math.ceil(u/1e3)+"s)"),t.retryInterval&&clearInterval(t.retryInterval),t.retryInterval=setInterval(()=>{u-=1e3,u<=0?(clearInterval(t.retryInterval),t.retryInterval=null,l.classList.remove("disabled-link"),l.dataset.cooldownLeft="0",c&&(c.textContent="")):(l.dataset.cooldownLeft=u.toString(),c&&(c.textContent="("+Math.ceil(u/1e3)+"s)"))},1e3)}}).finally(()=>{h&&(h.disabled=!1),y&&(y.disabled=!1),t.startTimeout&&(clearTimeout(t.startTimeout),t.startTimeout=null),t.countdownInterval&&(clearInterval(t.countdownInterval),t.countdownInterval=null)})}function p(){f(null),window.__otpFlow=window.__otpFlow||{};let e=window.__otpFlow;if(e.verifyInFlight)return;let r=(document.getElementById("otpUserName")?.value||"").trim(),t=(document.getElementById("otpCode")?.value||"").trim();if(!r||!t){f("User and code are required");return}let s=document.getElementById("btn-verify-otp");s&&(s.disabled=!0),e.verifyInFlight=!0;let v=typeof window.__returnUrl=="string"?window.__returnUrl:"/chat";b("/api/auth/verify",{userName:r,code:t,returnUrl:v}).then(n=>{if(!n.ok)throw new Error("Invalid code");return n.json().catch(()=>({}))}).then(n=>{let i=n&&typeof n.nextUrl=="string"?n.nextUrl:"/chat";i.startsWith("/")&&!i.startsWith("//")?window.location.href=i:window.location.href="/chat"}).catch(n=>f(n.message||"Verification failed")).finally(()=>{e.verifyInFlight=!1,s&&(s.disabled=!1)})}document.addEventListener("click",e=>{if(e.target.closest("#btn-send-otp")){a(!1);return}if(e.target.closest("#btn-resend-otp")){a(!0);return}if(e.target.closest("#btn-verify-otp")){p();return}});let w=document.getElementById("otpCode");w&&w.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),p())})})})();})();
