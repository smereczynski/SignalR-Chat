(()=>{window.__chatAppBooted?console.warn("chat.js: duplicate include detected, skipping second init"):window.__chatAppBooted=!0;(function(){let b=(e,n,o)=>window.appLogger&&window.appLogger[e]?window.appLogger[e](n,o):console.log(`[${e}] ${n}`,o||""),y={UNKNOWN:"UNKNOWN",PROBING:"PROBING",AUTHENTICATED:"AUTHENTICATED",UNAUTHENTICATED:"UNAUTHENTICATED"},t={loading:!0,profile:null,rooms:[],users:[],messages:[],joinedRoom:null,filter:"",oldestLoaded:null,canLoadMore:!0,pageSize:20,loadingMore:!1,lastSendAt:0,minSendIntervalMs:800,joinInProgress:!1,pendingJoin:null,outbox:[],pendingAck:{},authStatus:y.UNKNOWN,pendingMessages:{},isOffline:!1,unreadCount:0,unsentByRoom:{},ackTimers:{},autoScroll:!0,_firstRender:!0,_autoFillPass:0};t._hubStartedEarly=!1,t._graceStartedAt=null,t._graceEnded=!1;let s={},w={current:"disconnected",lastUpdate:0,isReconnecting:!1,reconnectSource:null};function J(){return!!(t.authGraceUntil&&Date.now()<t.authGraceUntil)}function Ee(){s.app=document.querySelector(".app");let e=Array.from(document.querySelectorAll(".vh-100"));if(s.loaderWrapper=e.find(n=>n.querySelector(".spinner-border"))||document.querySelector(".d-flex.vh-100")||e[0],s.loaderWrapper===e[0]&&e.length>1){let n=e.find(o=>o!==e[0]);n&&(s.loaderWrapper=n)}s.roomsList=document.getElementById("rooms-list"),s.usersList=document.getElementById("users-list"),s.messagesList=document.getElementById("messages-list"),s.messageInput=document.getElementById("message-input"),s.joinedRoomTitle=document.getElementById("joinedRoom"),s.filterInput=document.querySelector(".users-container input[type=text]"),s.errorAlert=document.getElementById("errorAlert"),s.itemToDelete=document.getElementById("itemToDelete"),s.profileAvatarImg=document.getElementById("profileAvatarImg")||document.querySelector(".profile img.avatar"),s.profileAvatarInitial=document.getElementById("profileAvatarInitial")||document.querySelector(".profile span.avatar"),s.profileName=document.getElementById("profileName")||document.querySelector(".profile span:not(.avatar)"),s.btnLogin=document.getElementById("btn-login"),s.btnLogout=document.getElementById("btn-logout"),s.roomsNoSelection=document.querySelector('[data-role="no-room-selected"]'),s.roomsPanel=document.querySelector('[data-role="room-panel"]'),s.usersHeader=document.getElementById("users-header"),s.queueBadge=document.getElementById("queue-badge"),s.roomHeader=document.querySelector('.main-content[data-role="room-panel"] .header')}function I(e){t.loading=e,s.loaderWrapper&&s.loaderWrapper.classList.toggle("d-none",!e),s.app&&s.app.classList.toggle("d-none",e)}function L(e){if(s.roomHeader)switch(s.roomHeader.classList.remove("connection-state-connected","connection-state-reconnecting","connection-state-disconnected","connection-state-degraded"),!t._baseRoomTitle&&s.joinedRoomTitle&&(t._baseRoomTitle=s.joinedRoomTitle.textContent||""),e){case"connected":s.roomHeader.classList.add("connection-state-connected"),s.joinedRoomTitle&&t._baseRoomTitle&&(s.joinedRoomTitle.textContent=t._baseRoomTitle);break;case"reconnecting":s.roomHeader.classList.add("connection-state-reconnecting"),s.joinedRoomTitle&&t._baseRoomTitle&&(s.joinedRoomTitle.textContent=t._baseRoomTitle+" ("+(window.i18n.reconnecting||"RECONNECTING\u2026")+")");break;case"degraded":if(s.roomHeader.classList.add("connection-state-degraded"),s.joinedRoomTitle&&t._baseRoomTitle){let n="\u26A0\uFE0F";s.joinedRoomTitle.textContent=t._baseRoomTitle+" ("+n+" "+(window.i18n.degraded||"LIMITED")+")"}break;case"disconnected":if(s.roomHeader.classList.add("connection-state-disconnected"),s.joinedRoomTitle){let n=t._baseRoomTitle||s.joinedRoomTitle.textContent||"",o="\u26A0\uFE0F";s.joinedRoomTitle.textContent=n+" ("+o+" "+(window.i18n.disconnected||"DISCONNECTED")+")"}break}}function z(){let e=Date.now()-w.lastUpdate;if(w.isReconnecting&&w.reconnectSource==="automatic"&&e<6e4)return"reconnecting";if(w.isReconnecting&&w.reconnectSource==="manual")return e<1e4?"reconnecting":"disconnected";if(!f)return"disconnected";let n=f.state&&f.state.toLowerCase?f.state.toLowerCase():"",o=n==="connected",a=Date.now()-S.lastCheck;return o&&a<3e4&&!S.isHealthy?"degraded":e<5e3?w.current:n==="connected"?"connected":(n==="connecting"||n==="reconnecting")&&e>=6e4?"disconnected":n==="connecting"||n==="reconnecting"?"reconnecting":"disconnected"}function Me(){setInterval(()=>{L(z())},2500)}let S={isHealthy:!0,lastCheck:0,redis:"Unknown",cosmos:"Unknown"};async function ne(){if(!(!f||f.state!=="Connected"))try{let e=await f.invoke("GetHealthStatus");S.isHealthy=e.isHealthy||!1,S.redis=e.redis||"Unknown",S.cosmos=e.cosmos||"Unknown",S.lastCheck=Date.now(),console.debug("[Health]",e.isHealthy?"\u2713 Healthy":"\u2717 Unhealthy",`Redis: ${e.redis}, Cosmos: ${e.cosmos}`)}catch(e){console.warn("[Health] Check failed:",e),S.isHealthy=!1,S.redis="Error",S.cosmos="Error",S.lastCheck=Date.now()}}async function oe(){if(!(!f||f.state!=="Connected"))try{let e=await f.invoke("Heartbeat");e.acknowledged&&e.health&&(S.isHealthy=e.health.isHealthy||!1,S.redis=e.health.redis||"Unknown",S.cosmos=e.health.cosmos||"Unknown",S.lastCheck=Date.now(),console.debug("[Heartbeat] Acknowledged",e.timestamp))}catch(e){console.warn("[Heartbeat] Failed:",e)}}function ke(){setInterval(async()=>{await ne()},15e3),setInterval(async()=>{await oe()},3e4),setTimeout(async()=>{await ne(),await oe()},2e3)}function D(e,n){let o=e&&typeof e=="string"&&e.trim().length>0?e:n||"";return o&&o.trim().charAt(0).toUpperCase()||"?"}function x(){s.roomsList&&(s.roomsList.innerHTML="",t.rooms.forEach(e=>{let n=document.createElement("li"),o=document.createElement("a");o.href="#",o.textContent=e.name,o.dataset.roomId=e.id,t.pendingJoin===e.name&&(!t.joinedRoom||t.joinedRoom.name!==e.name)&&o.classList.add("joining"),t.joinedRoom&&t.joinedRoom.name===e.name&&o.classList.add("active"),o.addEventListener("click",a=>{a.preventDefault(),B(e.name)}),n.appendChild(o),s.roomsList.appendChild(n)}))}function A(){if(!s.usersList)return;let e=t.filter.toLowerCase();s.usersList.innerHTML="";let n=t.users.filter(o=>!e||(o.fullName||o.userName||"").toLowerCase().includes(e));if(n.forEach(o=>{let a=document.createElement("li");a.dataset.username=o.userName;let i=document.createElement("div");if(i.className="user",o.avatar){let d=document.createElement("img");d.className="avatar me-2",d.src="/avatars/"+o.avatar,i.appendChild(d)}else{let d=document.createElement("span");d.className="avatar me-2 text-uppercase",d.textContent=D(o.fullName,o.userName),i.appendChild(d)}let r=document.createElement("div");r.className="user-info";let m=document.createElement("span");m.className="name",m.textContent=o.fullName||o.userName,r.appendChild(m);let c=document.createElement("span");c.className="device",c.textContent=o.device||"",r.appendChild(c),i.appendChild(r),a.appendChild(i),s.usersList.appendChild(a)}),s.usersHeader&&window.i18n?.whosHere){let o=window.i18n.whosHere;s.usersHeader.textContent=o.replace("{0}",n.length)}}function se(e){let n=new Date(e),a=Math.round((n-new Date)/(1e3*3600*24)),i=n.getDate(),r=n.getMonth()+1,m=n.getFullYear(),d=!(document.documentElement.lang||"en").startsWith("en"),g=n.getHours(),p=("0"+n.getMinutes()).slice(-2),u="",N;d?N=("0"+g).slice(-2):(u=g>=12?window.i18n.PM||"PM":window.i18n.AM||"AM",g>12&&(g=g%12),g===0&&(g=12),N=g);let E=`${i}/${r}/${m}`,ee=d?`${N}:${p}`:`${N}:${p} ${u}`,st=`${E} ${ee}`,te=E,at=window.i18n.Today||"Today",it=window.i18n.Yesterday||"Yesterday";return a===0?te=`${at}, ${ee}`:a===-1&&(te=`${it}, ${ee}`),{relative:te,full:st}}function v(){s.messagesList&&(s.messagesList.innerHTML="",t.messages.forEach(e=>q(e,!1)),T())}function q(e,n){if(!s.messagesList)return;let o=document.createElement("li");o.dataset.cid=e.correlationId||"",typeof e.id=="number"&&(o.dataset.id=String(e.id)),e.failed&&o.classList.add("failed");let a=document.createElement("div");if(a.className="message-item",e.isMine&&a.classList.add("ismine"),e.avatar){let u=document.createElement("img");u.className="avatar avatar-lg mx-2",u.src="/avatars/"+e.avatar,a.appendChild(u)}else{let u=document.createElement("span");u.className="avatar avatar-lg mx-2 text-uppercase",u.textContent=D(e.fromFullName,e.fromUserName),a.appendChild(u)}let i=document.createElement("div");i.className="message-content";let r=document.createElement("div");r.className="message-info d-flex flex-wrap align-items-center";let m=document.createElement("span");m.className="author",m.textContent=e.fromFullName||e.fromUserName,r.appendChild(m);let c=document.createElement("span");c.className="timestamp";let d=se(e.timestamp);if(c.textContent=d.relative,c.dataset.bsTitle=d.full,c.setAttribute("data-bs-toggle","tooltip"),r.appendChild(c),e.failed){let u=document.createElement("span");u.className="send-status ms-2 text-danger",u.textContent=window.i18n.MessageFailed||"(failed)",r.appendChild(u);let N=document.createElement("button");N.type="button",N.className="btn btn-link p-0 ms-2 retry-send",N.textContent=window.i18n.Retry||"Retry",N.addEventListener("click",()=>we(e.correlationId)),r.appendChild(N)}else if(e.pending){let u=document.createElement("span");u.className="send-status ms-2 text-muted",u.textContent=window.i18n.MessagePending||"\u2026",r.appendChild(u)}i.appendChild(r);let g=document.createElement("div");g.className="content",g.textContent=e.content,i.appendChild(g);let p=document.createElement("div");if(p.className="read-receipt small text-muted",ae(p,e),i.appendChild(p),a.appendChild(i),o.appendChild(a),s.messagesList.appendChild(o),n){let u=document.querySelector(".messages-container");u&&(t.autoScroll||t._firstRender)&&(u.scrollTop=u.scrollHeight)}return o}function U(e){if(!s.messagesList||!e.correlationId)return!1;let n=s.messagesList.querySelector('li[data-cid="'+e.correlationId+'"]');if(!n)return!1;typeof e.id=="number"&&(n.dataset.id=String(e.id));let o=n.querySelector(".timestamp");if(o){let c=se(e.timestamp);o.textContent=c.relative,o.dataset.bsTitle=c.full}let a=n.querySelector(".content");a&&(a.textContent=e.content),n.classList.toggle("failed",!!e.failed);let i=n.querySelector(".send-status");if(!i&&(e.failed||e.pending)){let c=n.querySelector(".message-info");c&&(i=document.createElement("span"),i.className="send-status ms-2",c.appendChild(i))}i&&(e.failed?(i.textContent=window.i18n.MessageFailed||"(failed)",i.className="send-status ms-2 text-danger"):e.pending?(i.textContent=window.i18n.MessagePending||"\u2026",i.className="send-status ms-2 text-muted"):i.remove());let r=n.querySelector("button.retry-send");if(e.failed){if(!r){let c=n.querySelector(".message-info");c&&(r=document.createElement("button"),r.type="button",r.className="btn btn-link p-0 ms-2 retry-send",r.textContent=window.i18n.Retry||"Retry",r.addEventListener("click",()=>we(e.correlationId)),c.appendChild(r))}}else r&&r.remove();n.dataset.cid=e.correlationId||"";let m=n.querySelector(".read-receipt");if(!m){m=document.createElement("div"),m.className="read-receipt small text-muted";let c=n.querySelector(".message-content");c&&c.appendChild(m)}return ae(m,e),!0}function ae(e,n){if(!e)return;let o=Array.isArray(n.readBy)?n.readBy:[];if(!!!n.isMine){e.textContent="",e.classList.add("d-none");return}e.classList.remove("d-none");let i=(t.profile&&t.profile.userName||"").toLowerCase(),r=o.filter(m=>m&&m.toLowerCase()!==i);if(r.length===0){e.textContent=window.i18n?.delivered||"Delivered";return}e.textContent=(window.i18n?.readBy||"Read by")+" "+r.join(", ")}function T(){let e=document.querySelector(".no-messages-info");e&&e.classList.toggle("d-none",t.messages.length>0);let n=document.querySelector(".messages-container");n&&!t.loadingMore&&(t.autoScroll||t._firstRender)&&(n.scrollTop=n.scrollHeight),t._firstRender=!1,window.bootstrap&&[].slice.call(s.messagesList.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(a=>{try{new window.bootstrap.Tooltip(a)}catch{}}),xe(),k()}function xe(){try{let e=document.querySelector(".messages-container");if(!e||t.loadingMore||!t.canLoadMore||!t.joinedRoom||!t.oldestLoaded)return;!(e.scrollHeight>e.clientHeight+4)&&t._autoFillPass<3&&(t._autoFillPass++,setTimeout(()=>ge(),0))}catch{}}function C(){let e=t.profile;s.profileName&&(e?(s.profileName.textContent=e.fullName||e.userName,e.avatar?(s.profileAvatarImg&&(s.profileAvatarImg.src="/avatars/"+e.avatar,s.profileAvatarImg.classList.remove("d-none")),s.profileAvatarInitial&&s.profileAvatarInitial.classList.add("d-none")):(s.profileAvatarInitial&&(s.profileAvatarInitial.textContent=D(e.fullName,e.userName),s.profileAvatarInitial.classList.remove("d-none")),s.profileAvatarImg&&s.profileAvatarImg.classList.add("d-none")),s.btnLogin&&s.btnLogin.classList.add("d-none"),s.btnLogout&&s.btnLogout.classList.remove("d-none")):(s.profileName.textContent="Not signed in",s.profileAvatarImg&&s.profileAvatarImg.classList.add("d-none"),s.profileAvatarInitial&&(s.profileAvatarInitial.classList.remove("d-none"),s.profileAvatarInitial.textContent="?"),s.btnLogin&&s.btnLogin.classList.remove("d-none"),s.btnLogout&&s.btnLogout.classList.add("d-none")))}let ie=C;C=function(){if(!s.profileName){ie();return}if(!t.profile){let e=J();if(t.authStatus===y.PROBING||e){s.profileName.textContent="Signing in\u2026",s.profileAvatarImg&&s.profileAvatarImg.classList.add("d-none"),s.profileAvatarInitial&&(s.profileAvatarInitial.classList.remove("d-none"),s.profileAvatarInitial.textContent="?"),s.btnLogin&&s.btnLogin.classList.add("d-none"),s.btnLogout&&s.btnLogout.classList.add("d-none");return}}ie()};function Ue(){if(!(!t.profile||t.profile.avatar)&&s.profileAvatarInitial){let e=D(t.profile.fullName,t.profile.userName);s.profileAvatarInitial.textContent=e,s.profileAvatarInitial.classList.remove("d-none"),s.profileAvatarImg&&s.profileAvatarImg.classList.add("d-none")}}function re(){if(!s.roomsPanel||!s.roomsNoSelection)return;let e=!!t.joinedRoom;s.roomsPanel.classList.toggle("d-none",!e),s.roomsNoSelection.classList.toggle("d-none",e),t.joinedRoom&&s.joinedRoomTitle&&(s.joinedRoomTitle.textContent=t.joinedRoom.name),x()}function ce(){C(),re(),A(),v()}function W(){if(!s.queueBadge)return;let e=t.outbox.length;s.queueBadge.textContent=e,s.queueBadge.classList.toggle("d-none",e===0)}function V(e,n){if(!n||t.messages.find(r=>r.correlationId===n))return;let a=new Date().toISOString(),i={id:pe--,content:e,timestamp:a,fromUserName:t.profile?.userName,fromFullName:t.profile?.fullName,avatar:t.profile?.avatar,isMine:!!t.profile,correlationId:n,pending:!0};t.messages.push(i),s.messagesList&&t.messages.length>1?(q(i,!0),T()):v()}function le(e,n){try{if(!e||!Array.isArray(t.messages)||!t.messages.length)return;let o=t.messages.filter(a=>a&&a.isMine&&(a.pending||a.failed));if(!o.length)return;t.unsentByRoom=t.unsentByRoom||{},t.unsentByRoom[e]=o.map(a=>({content:a.content,timestamp:a.timestamp,fromUserName:a.fromUserName,fromFullName:a.fromFullName,avatar:a.avatar,isMine:!0,correlationId:a.correlationId||null,pending:!!a.pending,failed:!!a.failed,id:a.id})),l("unsent.snapshot",{room:e,count:o.length,reason:n})}catch{}}function je(e){try{if(!e||!t.unsentByRoom||!t.unsentByRoom[e])return;let n=t.unsentByRoom[e];delete t.unsentByRoom[e];let o=new Set(t.messages.map(r=>r.correlationId).filter(Boolean)),a=new Set(t.messages.map(r=>r.isMine?r.content+"|"+r.timestamp:null).filter(Boolean)),i=[];for(let r of n)r.correlationId&&o.has(r.correlationId)||a.has(r.content+"|"+r.timestamp)||i.push(r);if(!i.length)return;i.forEach(r=>{r.pending&&!r.failed&&(r.pending=!0)}),t.messages=t.messages.concat(i),l("unsent.restore",{room:e,count:i.length})}catch{}}let K=e=>fetch(e,{credentials:"include"}).then(n=>n.ok?n.json():Promise.reject(n)),rt=(e,n)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),ct=(e,n)=>fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),lt=e=>fetch(e,{method:"DELETE",credentials:"include"}),f=null,P=0,_e=3e4,Be={nextRetryDelayInMilliseconds(e){let n=e&&typeof e.previousRetryCount=="number"?e.previousRetryCount+1:1,o=[0,2e3,5e3,1e4],a=n<=o.length?o[n-1]:3e4;return Math.min(a,3e4)}};function He(e){let n=new Uint8Array(e);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(n);else for(let o=0;o<e;o++)n[o]=Math.floor(Math.random()*256);return n}function j(e,n){let o=He(n),a="";for(let i of o)a+=(i&15).toString(16);return(e||"")+a+"_"+Date.now().toString(36)}let De=j("s_8",8),_={},de=4e3;function l(e,n){try{let o=Date.now(),a;if(/^send\.flush\.skip$/.test(e)&&(a=e+"|"+(n&&n.reason)),/^send\.queue$/.test(e)&&(a=e+"|"+(n&&n.reason)),/^hub\.connect\.retry$/.test(e)&&(a=e+"|"+(n&&n.attempt)),a){let i=_[a];if(i&&o-i<de)return;_[a]=o}fetch("/api/telemetry/reconnect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({evt:e,ts:o,sessionId:De,...n})})}catch{}}setInterval(()=>{try{let e=Date.now(),n=de*3;for(let o in _)e-_[o]>n&&delete _[o]}catch{}},12e4);function qe(e){if(!e)return{cat:"unknown",msg:""};let n=e&&(e.message||e.toString())||"";return/403|401|unauthor/i.test(n)?{cat:"auth",msg:n}:/timeout|timed out/i.test(n)?{cat:"timeout",msg:n}:/network|fetch|socket|ws|transport/i.test(n)?{cat:"transport",msg:n}:/server|500|hubexception/i.test(n)?{cat:"server",msg:n}:{cat:"other",msg:n}}let Y=null;function ue(){if(f)return f;f=new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect(Be).build();try{f.serverTimeoutInMilliseconds=12*60*60*1e3,f.keepAliveIntervalInMilliseconds=2e4}catch{}return Pe(f),f}function F(){ue();let e=f.state&&f.state.toLowerCase?f.state.toLowerCase():"";if(e&&e!=="disconnected")return(e==="connecting"||e==="reconnecting")&&(w.isReconnecting||(w={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:e==="reconnecting"?"automatic":"manual"},L("reconnecting"))),b("warn","signalr.start.skip",{state:e}),l("hub.connect.skip",{state:e}),Promise.resolve();b("info","signalr.start"),w={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:"manual"},L("reconnecting");let n=performance.now();return t.authStatus===y.PROBING&&!t.profile&&(t._hubStartedEarly||(l("auth.hub.start.early",{}),t._hubStartedEarly=!0)),f.start().then(()=>{P=0,Y=null,w={current:"connected",lastUpdate:Date.now(),isReconnecting:!1,reconnectSource:null},!t.profile&&(t.authStatus===y.PROBING||t.authStatus===y.UNKNOWN)&&fetch("/api/auth/me",{credentials:"include"}).then(o=>o.ok?o.json():null).then(o=>{o&&o.userName&&(t.profile={userName:o.userName,fullName:o.fullName,avatar:o.avatar},t.authStatus=y.AUTHENTICATED,C(),l("auth.reprobe.success",{}))}).catch(()=>{}),fe(),l("hub.connected",{durationMs:Math.round(performance.now()-n)}),L("connected"),t.profile&&t.loading&&I(!1)}).catch(o=>{let a=o&&o.message||"";if(/not in the 'disconnected' state/i.test(a)||/cannot start a hubconnection that is not in the 'disconnected' state/i.test(a)){b("warn","signalr.start.duplicate",{message:a}),l("hub.connect.duplicateStart",{message:a});return}b("error","signalr.start.fail",{error:a}),l("hub.connect.fail",{message:a}),M(o)})}function O(){ue(),(f.state&&f.state.toLowerCase?f.state.toLowerCase():"")==="disconnected"&&F()}function M(e){e&&(Y=e),P++,w={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:"manual"};let n=Math.min(1e3*Math.pow(2,P),_e);L("reconnecting");let{cat:o,msg:a}=qe(Y);l("hub.connect.retry",{attempt:P,delayMs:n,errorCategory:o,errorMessage:a.slice(0,300)}),setTimeout(()=>F().catch(i=>M(i)),n)}function Pe(e){e.on("getProfileInfo",n=>{t.profile={userName:n.userName,fullName:n.fullName,avatar:n.avatar},t.authStatus=y.AUTHENTICATED,I(!1),C(),h("profile")}),e.on("presenceSnapshot",n=>{if(!Array.isArray(n))return;let o=n.map(a=>({userName:a.userName||a.UserName||a.username||"",fullName:a.fullName||a.FullName||a.name||"",avatar:a.avatar||a.Avatar||"",currentRoom:a.currentRoom||a.CurrentRoom||a.room||null,...a}));t.joinedRoom?t.users=o.filter(a=>a.currentRoom===t.joinedRoom.name):t.users=o,A()}),e.on("newMessage",n=>{if(t.profile&&t.profile.userName&&n.correlationId){let a=t.messages.findIndex(i=>i.isMine&&i.correlationId===n.correlationId);if(a>=0){t.messages[a]={id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:!0,correlationId:n.correlationId,readBy:n.readBy||[]},t.pendingMessages[n.correlationId]&&delete t.pendingMessages[n.correlationId];for(let i=t.messages.length-1;i>=0;i--)i!==a&&t.messages[i]&&t.messages[i].id===n.id&&t.messages.splice(i,1);v(),T();return}}if(n&&n.id!==void 0){let a=t.messages.findIndex(i=>i&&i.id===n.id);if(a>=0){let i=!!(t.profile&&t.profile.userName===n.fromUserName);t.messages[a]={id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:i,correlationId:n.correlationId||t.messages[a].correlationId,readBy:n.readBy||t.messages[a].readBy||[]},v(),T();return}}Ge({...n,correlationId:n.correlationId});try{!!(t.profile&&t.profile.userName===n.fromUserName)||(Ce()?k():(t.unreadCount=(t.unreadCount||0)+1,Te(n.room||t.joinedRoom&&t.joinedRoom.name||""),Se()))}catch{}}),e.on("notify",n=>$e(n)),e.on("messageRead",n=>{try{let o=n&&(n.id||n.Id),a=n&&(n.readers||n.Readers)||[],i=t.messages.findIndex(r=>r&&r.id===o);if(i>=0){let r=t.messages[i];r.readBy=a,U(r)||v()}}catch{}}),e.onreconnected(n=>{w={current:"connected",lastUpdate:Date.now(),isReconnecting:!1,reconnectSource:null};try{t.joinedRoom?(le(t.joinedRoom.name,"reconnected"),B(t.joinedRoom.name,!0)):fe()}catch{}L("connected")}),e.onreconnecting(n=>{(!w.isReconnecting||w.reconnectSource!=="automatic")&&(w={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:"automatic"}),b("warn","hub.reconnecting",{message:n&&n.message}),L("reconnecting")}),e.onclose(n=>{b("warn","hub.onclose",{message:n&&n.message}),w.isReconnecting||(w={current:"disconnected",lastUpdate:Date.now(),isReconnecting:!1,reconnectSource:null},n&&(b("warn","hub.onclose.error.triggering.reconnect",{msg:(n.message||"").slice(0,120)}),M(n))),L(w.current),t.users=[],A()}),e.on("addUser",n=>Fe(n)),e.on("removeUser",n=>Oe(n.userName)),e.on("addChatRoom",n=>me(n)),e.on("updateChatRoom",n=>me(n)),e.on("removeChatRoom",n=>{t.rooms=t.rooms.filter(o=>o.id!==n),t.joinedRoom&&t.joinedRoom.id===n&&(t.joinedRoom=null,t.messages=[]),ce()}),e.on("onError",n=>$(n))}function me(e){let n=t.rooms.find(o=>o.id===e.id);n?(n.name=e.name,n.admin=e.admin):t.rooms.push({id:e.id,name:e.name,admin:e.admin}),x()}function Fe(e){let n={userName:e.userName||e.UserName||e.username||"",fullName:e.fullName||e.FullName||e.name||"",avatar:e.avatar||e.Avatar||"",currentRoom:e.currentRoom||e.CurrentRoom||e.room||null,...e},o=t.users.find(a=>a.userName===n.userName);o?Object.assign(o,n):t.users.push(n),A()}function Oe(e){t.users=t.users.filter(n=>n.userName!==e),A()}function Ge(e){let n=t.profile&&t.profile.userName===e.fromUserName,o=-1;e&&e.correlationId&&(o=t.messages.findIndex(i=>i&&i.correlationId===e.correlationId)),o<0&&e&&e.id!==void 0&&(o=t.messages.findIndex(i=>i&&i.id===e.id));let a={id:e.id,content:e.content,timestamp:e.timestamp,fromUserName:e.fromUserName,fromFullName:e.fromFullName,avatar:e.avatar,isMine:n,correlationId:e.correlationId,readBy:e.readBy||[]};o>=0?(t.messages[o]=a,v()):(t.messages.push(a),s.messagesList&&t.messages.length>1?(q(a,!0),T()):v())}function $e(e){let n=e.ts||new Date().toISOString(),o=`[NOTIFY] ${e.title}${e.body?": "+e.body:""}`;t.messages.push({id:"notify_"+n,content:o,timestamp:n,fromUserName:e.from||"system",fromFullName:e.from||"system",avatar:null,isMine:!1}),v()}function B(e,n){if(!f||!e||t.joinInProgress&&t.pendingJoin===e||!n&&t.joinedRoom&&t.joinedRoom.name===e&&!t.joinInProgress)return;n&&t.joinedRoom&&t.joinedRoom.name===e&&le(e,"forceJoin");let o=j("j_",8);t._joinToken=o,t.joinInProgress=!0,t.pendingJoin=e,x();let a=performance.now(),i=3,r=0;function m(){r++,f.invoke("Join",e).then(()=>{t._joinToken!==o||t.pendingJoin!==e||(t.joinedRoom=t.rooms.find(c=>c.name===e)||{name:e},t.pendingJoin=null,t.joinInProgress=!1,localStorage.setItem("lastRoom",e),s.joinedRoomTitle&&(t._baseRoomTitle=t.joinedRoom.name,s.joinedRoomTitle.textContent=t._baseRoomTitle),Je(),ze(),re(),Ue(),l("room.join.success",{room:e,durationMs:Math.round(performance.now()-a),attempts:r}),h("join"))}).catch(c=>{if(t._joinToken!==o)return;let d=c&&c.message||"";if(/timeout|temporar|network|reconnect|connection/i.test(d)&&r<i){let p=300*r;l("room.join.retry",{room:e,attempt:r,backoff:p,msg:d.slice(0,120)}),setTimeout(m,p)}else t.pendingJoin===e&&(t.joinInProgress=!1,t.pendingJoin=null),x(),l("room.join.fail",{room:e,attempts:r,msg:d.slice(0,200)}),$("Join failed: "+d),b("warn","room.join.failed.triggering.reconnect",{room:e,msg:d.slice(0,120)}),M(c)})}m()}function fe(){K("/api/Rooms").then(e=>{t.rooms=(e||[]).map(o=>({id:o.id!==void 0?o.id:o.Id,name:o.name!==void 0?o.name:o.Name,admin:o.admin!==void 0?o.admin:o.Admin})),x();let n=localStorage.getItem("lastRoom");n&&t.rooms.some(o=>o.name===n)?B(n):t.rooms.length>0&&B(t.rooms[0].name)}).catch(()=>{})}function Je(){t.joinedRoom&&f.invoke("GetUsers",t.joinedRoom.name).then(e=>{let n=(e||[]).map(o=>({userName:o.userName||o.UserName||o.username||"",fullName:o.fullName||o.FullName||o.name||"",avatar:o.avatar||o.Avatar||"",currentRoom:o.currentRoom||o.CurrentRoom||o.room||null,...o}));t.users=n,A()}).catch(e=>{b("warn","loadUsers.failed",{msg:e&&e.message}),setTimeout(()=>M(e),1e3)})}function ze(){t.joinedRoom&&(t.oldestLoaded=null,t.canLoadMore=!0,t._autoFillPass=0,K("/api/Messages/Room/"+encodeURIComponent(t.joinedRoom.name)+"?take="+t.pageSize).then(e=>{t.messages=e.map(n=>({id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:t.profile&&t.profile.userName===n.fromUserName,readBy:n.readBy||[]})),je(t.joinedRoom.name),t.messages.length>0?(t.oldestLoaded=t.messages[0].timestamp,e.length<t.pageSize&&(t.canLoadMore=!1)):t.canLoadMore=!1,v(),We()}).catch(()=>{}))}let Q=0;function ge(){if(!t.canLoadMore||t.loadingMore||!t.joinedRoom||!t.oldestLoaded)return;t.loadingMore=!0;let e=++Q,n=t.oldestLoaded,o=encodeURIComponent(n);l("messages.page.req",{before:n,token:e}),K("/api/Messages/Room/"+encodeURIComponent(t.joinedRoom.name)+"?before="+o+"&take="+t.pageSize).then(a=>{if(e!==Q){l("messages.page.stale",{token:e});return}if(!Array.isArray(a)||a.length===0){t.canLoadMore=!1,l("messages.page.empty",{token:e});return}let i=a.map(d=>({id:d.id,content:d.content,timestamp:d.timestamp,fromUserName:d.fromUserName,fromFullName:d.fromFullName,avatar:d.avatar,isMine:t.profile&&t.profile.userName===d.fromUserName,readBy:d.readBy||[]})),r=document.querySelector(".messages-container"),m=r?r.scrollHeight:0,c=t.oldestLoaded;if(t.messages=i.concat(t.messages),t.oldestLoaded=t.messages[0].timestamp,c&&t.oldestLoaded>c&&(l("messages.page.nonmonotonic",{prev:c,now:t.oldestLoaded}),t.oldestLoaded=c),a.length<t.pageSize&&(t.canLoadMore=!1),v(),r){let d=r.scrollHeight;r.scrollTop=d-m}l("messages.page.ok",{token:e,added:a.length,remaining:t.canLoadMore?1:0})}).catch(a=>{l("messages.page.err",{token:e,msg:a&&a.message||""})}).finally(()=>{e===Q&&(t.loadingMore=!1)})}function We(){let e=document.querySelector(".messages-container");if(!e||e.dataset.paginated)return;e.dataset.paginated="true";let n=0;e.addEventListener("scroll",()=>{if(t.autoScroll=Le(),e.scrollTop<40){let o=Date.now();o-n>500&&(n=o,!t.loadingMore&&t.canLoadMore&&t.joinedRoom&&t.oldestLoaded&&ge())}Z(),k()})}let pe=-1;function G(e,n,o,a){let i=Date.now();if(!n&&i-t.lastSendAt<t.minSendIntervalMs)return $("You are sending messages too quickly"),Promise.reject("rateLimited");!o&&!a&&(t.lastSendAt=i);let r=a||j("c_",12),m;if(a){let g=t.messages.find(p=>p.correlationId===a);g&&(m=g.id)}else{m=pe--;let g=new Date().toISOString(),p={id:m,content:e,timestamp:g,fromUserName:t.profile?.userName,fromFullName:t.profile?.fullName,avatar:t.profile?.avatar,isMine:!!t.profile,correlationId:r,pending:!0};t.messages.push(p),s.messagesList&&t.messages.length>1?(q(p,!0),T()):v()}if(!f)return Promise.reject("noHub");let c=t.pendingMessages[r]||{attempts:0,createdAt:Date.now(),text:e,tempId:m};c.attempts++,t.pendingMessages[r]=c,l("send.attempt",{cid:r,len:e.length,fromFlush:!!o,attempts:c.attempts,resend:!!a});let d=f.invoke("SendMessage",e,r).then(()=>{l("send.invoke.ok",{cid:r}),Ve(r)}).catch(g=>{let p=g&&g.message||"",u=t.messages.find(N=>N.correlationId===r);throw u&&(u.failed=!0,u.pending=!1),delete t.pendingMessages[r],he(r),l("send.invoke.fail",{cid:r,msg:p}),u&&(U(u)?T():v()),b("warn","sendMessage.failed.triggering.reconnect",{msg:p.slice(0,120)}),setTimeout(()=>M(g),500),g});return ye(r),d}function he(e){let n=t.ackTimers&&t.ackTimers[e];if(n){try{clearTimeout(n)}catch{}delete t.ackTimers[e]}}function ye(e){t.ackTimers||(t.ackTimers={}),!t.ackTimers[e]&&(t.ackTimers[e]=setTimeout(()=>{delete t.ackTimers[e];let o=t.pendingMessages[e];if(o){if(o.attempts>=3){l("send.timeout.giveup",{cid:e,attempts:o.attempts}),l("send.reconcile",{cid:e,mode:"giveup",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),delete t.pendingMessages[e];let a=t.messages.find(i=>i.correlationId===e);a&&(a.failed=!0,a.pending=!1,U(a)?T():v());return}l("send.timeout.resend",{cid:e,attempts:o.attempts}),l("send.reconcile",{cid:e,mode:"timeout-resend",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),G(o.text,!0,!0,e),ye(e)}},3e4))}function Ve(e){let n=t.messages.find(a=>a.correlationId===e);n&&(n.pending=!1,n.failed=!1,U(n)?T():v());let o=t.pendingMessages[e];o&&l("send.reconcile",{cid:e,mode:"ack",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),delete t.pendingMessages[e],he(e)}function we(e){let n=t.messages.find(o=>o.correlationId===e);n&&(n.failed=!1,n.pending=!0,U(n)?T():v(),l("send.retry.manual",{cid:e}),G(n.content,!0,!0,e))}function H(e){t.outbox.length>=50&&t.outbox.shift();let o=j("c_",12),a={text:e,cid:o};t.outbox.push(a),V(e,o),W(),X()}function Ne(){let e=(s.messageInput&&s.messageInput.value||"").trim();if(!e)return;if(t.isOffline){H(e),l("send.queue",{reason:"offline",size:t.outbox.length}),s.messageInput&&(s.messageInput.value="");return}if(!t.profile){let o=Date.now(),a=J();if(t.authStatus===y.UNKNOWN||t.authStatus===y.PROBING||a){H(e);let i="awaitingProfile";a?i="authGrace":t.loading?i="loadingUI":t.authStatus===y.PROBING&&(i="authProbing"),l("send.queue",{reason:i,size:t.outbox.length}),s.messageInput&&(s.messageInput.value="");return}$(window.i18n.SessionExpired||"Session expired. Please refresh.");return}if(t.joinInProgress||t.pendingJoin){H(e),l("send.queue",{reason:"joinInProgress",size:t.outbox.length}),s.messageInput&&(s.messageInput.value="");return}if(!t.joinedRoom){let o=t.rooms&&t.rooms.length?localStorage.getItem("lastRoom")&&t.rooms.some(a=>a.name===localStorage.getItem("lastRoom"))?localStorage.getItem("lastRoom"):t.rooms[0].name:null;o&&B(o),H(e),l("send.queue",{reason:"noRoomYet",size:t.outbox.length}),s.messageInput&&(s.messageInput.value="");return}try{let o=z();if(o!=="connected"){H(e),l("send.queue",{reason:"hubNotConnected:"+o,size:t.outbox.length}),s.messageInput&&(s.messageInput.value="");return}}catch{}let n=j("c_",12);V(e,n),G(e,!1,!1,n),s.messageInput&&(s.messageInput.value="")}function Re(){t.rooms=[],t.users=[],t.messages=[],t.profile=null,t.joinedRoom=null,ce(),I(!1)}function ve(){t.authStatus=y.PROBING;let e=performance.now();t.authGraceUntil=Date.now()+5e3,setTimeout(()=>{!t.profile&&(t.authStatus===y.PROBING||t.authStatus===y.UNKNOWN)&&!J()&&(t.authStatus=y.UNAUTHENTICATED,l("auth.finalize.unauth",{}),C())},5200);let n=setTimeout(()=>{b("warn","auth.timeout"),I(!1),l("auth.probe.timeout",{})},6e3);return fetch("/api/auth/me",{credentials:"include"}).then(o=>o.ok?o.json():null).then(o=>{clearTimeout(n),o&&o.userName?(t.profile={userName:o.userName,fullName:o.fullName,avatar:o.avatar},t.authStatus=y.AUTHENTICATED,l("auth.probe.success",{durationMs:Math.round(performance.now()-e)}),F(),h("authProbe"),t.authGraceUntil=null):(I(!1),t.authStatus=y.UNAUTHENTICATED,l("auth.probe.unauth",{durationMs:Math.round(performance.now()-e)})),C()}).catch(o=>{clearTimeout(n),I(!1);let a=o&&o.message||"";/timeout|network|fetch|offline|temporar(?:y|ily)?|dns|refused/i.test(a)?(l("auth.probe.errorTransient",{durationMs:Math.round(performance.now()-e)}),t.authGraceUntil=Date.now()+5e3,setTimeout(()=>{(t.authStatus===y.PROBING||t.authStatus===y.UNKNOWN)&&ve()},1200)):(t.authStatus=y.UNAUTHENTICATED,l("auth.probe.error",{durationMs:Math.round(performance.now()-e)}))}).finally(()=>{})}function Ke(){s.messageInput&&s.messageInput.addEventListener("keypress",n=>{n.key==="Enter"&&Ne()});let e=document.getElementById("btn-send-message");e&&e.addEventListener("click",n=>{n.preventDefault(),Ne()}),s.filterInput&&s.filterInput.addEventListener("input",()=>{t.filter=s.filterInput.value,A()}),s.btnLogout&&s.btnLogout.addEventListener("click",()=>{fetch("/api/auth/logout",{method:"POST",credentials:"include"}).catch(()=>{}).finally(()=>{try{f&&f.stop&&f.stop()}catch{}Re(),window.location.replace("/login?ReturnUrl=/chat")})})}function $(e){if(!s.errorAlert)return;let n=s.errorAlert.querySelector("span");n&&(n.textContent=e),s.errorAlert.classList.remove("d-none"),setTimeout(()=>s.errorAlert.classList.add("d-none"),5e3)}window.chatApp=window.chatApp||{},window.chatApp.onAuthenticated=function(){I(!0),t.authStatus=y.PROBING;let e=performance.now(),n=!1,o=!1,a=6,i=400,r=0;function m(){r++,fetch("/api/auth/me",{credentials:"include"}).then(c=>c.ok?c.json():null).then(c=>{c&&c.userName?(o=!0,t.profile={userName:c.userName,fullName:c.fullName,avatar:c.avatar},t.authStatus=y.AUTHENTICATED,C(),F(),h("authRetry"),t.loading&&I(!1)):r<a?setTimeout(m,i*r):(t.loading&&I(!1),b("warn","auth.retry.exhausted"),t.authStatus=y.UNAUTHENTICATED)}).catch(()=>{r<a?setTimeout(m,i*r):(t.loading&&I(!1),b("error","auth.retry.failed"),t.authStatus=y.UNAUTHENTICATED)}).finally(()=>{(r>=a||o)&&(n=!0)})}m(),setTimeout(()=>{t.loading&&(t.profile||n)&&(I(!1),b("warn","auth.safetyFallback",{elapsedMs:Math.round(performance.now()-e)}))},2e3)},window.chatApp.logoutCleanup=Re;function Ye(){try{let e=sessionStorage.getItem("chat.outbox");if(e){let n=JSON.parse(e);Array.isArray(n)&&(t.outbox=n.slice(0,50).map(o=>typeof o=="string"?{text:o,cid:be(o)}:o&&typeof o=="object"&&o.text?o:{text:String(o||""),cid:be(String(o||""))}))}}catch{}W()}function be(e){let n=2166136261;for(let a=0;a<e.length;a++)n^=e.charCodeAt(a),n+=(n<<1)+(n<<4)+(n<<7)+(n<<8)+(n<<24);return"c_"+Math.abs(n).toString(36).padStart(12,"0").slice(0,12)}function X(){try{sessionStorage.setItem("chat.outbox",JSON.stringify(t.outbox))}catch{}}function h(e){if(h._queue||(h._queue=[]),h._inProgress){h._queue.push(e);return}if(!t.outbox.length)return;if(t.isOffline){let d="flushSkip:offline:"+e;h._skipFlags||(h._skipFlags={}),h._skipFlags[d]||(h._skipFlags[d]=Date.now(),l("send.flush.skip",{reason:"offline",phase:e,qlen:t.outbox.length}));return}if(!t.profile||!t.joinedRoom){let d=t.profile?"noRoom":t.joinedRoom?"noProfile":"noProfile_noRoom",g="flushSkip:"+d+":"+e;h._skipFlags||(h._skipFlags={}),h._skipFlags[g]||(h._skipFlags[g]=Date.now(),l("send.flush.skip",{reason:d,phase:e,qlen:t.outbox.length}));return}h._inProgress=!0;let n=10,o=t.outbox.length,a=performance.now();l("send.flush.start",{room:t.joinedRoom&&t.joinedRoom.name,count:o,phase:e});let i=0,r=0,m=t.outbox.splice(0,o);W(),X();function c(){if(!m.length)return Promise.resolve();let d=m.splice(0,n),g=[];return Promise.all(d.map(p=>{let{text:u,cid:N}=typeof p=="string"?{text:p,cid:null}:p;return N&&V(u,N),G(u,!0,!0,N||void 0).then(()=>{i++,g.push({ok:!0})}).catch(()=>{r++,g.push({ok:!1,item:p})})})).then(()=>{let p=g.filter(u=>!u.ok).map(u=>u.item);return p.length&&(p.forEach(u=>t.outbox.push(u)),X(),l("send.flush.batchFail",{failed:p.length,phase:e})),c()})}c().finally(()=>{if(r&&l("send.flush.partialFail",{failed:r,success:i,remaining:t.outbox.length,phase:e}),l("send.flush.done",{room:t.joinedRoom&&t.joinedRoom.name,count:o,success:i,failed:r,durationMs:Math.round(performance.now()-a),phase:e}),h._inProgress=!1,h._queue.length){let d=h._queue.pop();h._queue.length=0,setTimeout(()=>h(d),0)}})}setInterval(()=>{try{t.outbox.length&&h("periodic"),t.outbox.length===0&&s.queueBadge&&s.queueBadge.textContent!=="0"&&!s.queueBadge.classList.contains("d-none")&&(s.queueBadge.textContent="0",s.queueBadge.classList.add("d-none"))}catch{}},1500),document.addEventListener("visibilitychange",()=>{document.hidden||h("visibility")}),document.addEventListener("visibilitychange",()=>{document.hidden||(Z(),k(),O())}),window.addEventListener("focus",()=>{Z(),k(),O()}),document.addEventListener("DOMContentLoaded",()=>{Ee(),Ye(),I(!0),ve(),Ke(),Me(),ke(),Qe(),Ie()});function Qe(){function e(n){t.isOffline=n,n?l("net.offline",{}):(l("net.online",{}),setTimeout(()=>{O(),t.outbox.length&&h("online")},150)),L(z())}typeof navigator<"u"&&"onLine"in navigator&&e(!navigator.onLine),window.addEventListener("offline",()=>e(!0)),window.addEventListener("online",()=>e(!1))}let R={base:null,timer:null,active:!1,counter:0,lastLabel:""};function Ie(){try{R.base=document.title||"Chat"}catch{R.base="Chat"}}function Se(){if(R.base||Ie(),R.active)return;R.active=!0;let e=!0;R.timer=setInterval(()=>{try{document.title=e?R.lastLabel:R.base}catch{}e=!e},1e3)}function Te(e){let n=t.unreadCount||0,o=(n>0?"("+n+") ":"")+"New message"+(e?" \u2022 "+e:"");R.lastLabel=o,n>0&&!R.active&&Se()}function Xe(){if(R.timer){try{clearInterval(R.timer)}catch{}R.timer=null}R.active=!1;try{R.base&&(document.title=R.base)}catch{}}function Le(){let e=document.querySelector(".messages-container");return e?e.scrollHeight-e.scrollTop-e.clientHeight<=8:!1}function Ce(){try{return!document.hidden&&!!t.joinedRoom&&window.document.hasFocus()&&Le()}catch{return!1}}function Ze(){try{return!document.hidden&&!!t.joinedRoom&&window.document.hasFocus()}catch{return!1}}let Ae=new Set;function et(){return(t.profile&&t.profile.userName||"").toLowerCase()}function tt(){try{let e=document.querySelector(".messages-container");if(!e||!s.messagesList)return[];let n=e.getBoundingClientRect(),o=Array.from(s.messagesList.children||[]),a=[],i=et();for(let m of o){if(!m||!m.getBoundingClientRect)continue;let c=m.getBoundingClientRect();if(Math.min(n.bottom,c.bottom)-Math.max(n.top,c.top)>12){let g=m.dataset&&m.dataset.id,p=g?parseInt(g,10):NaN;if(!Number.isFinite(p))continue;let u=t.messages.find(E=>E&&E.id===p);if(!u||u.isMine||(Array.isArray(u.readBy)?u.readBy:[]).some(E=>(E||"").toLowerCase()===i))continue;a.push(p)}}return Array.from(new Set(a)).slice(0,50)}catch{return[]}}function nt(){try{if(!Ze()||!f||!t.joinedRoom)return;let e=tt().filter(n=>!Ae.has(n));if(!e.length)return;e.forEach(n=>Ae.add(n)),e.forEach(n=>{try{f.invoke("MarkRead",n)}catch{}})}catch{}}function ot(e,n){let o;return function(){let a=arguments;clearTimeout(o),o=setTimeout(()=>e.apply(null,a),n)}}let k=ot(nt,300);function Z(){t.unreadCount>0&&Ce()?(t.unreadCount=0,Xe(),k()):t.unreadCount>0&&Te(t.joinedRoom&&t.joinedRoom.name||"")}setInterval(()=>{try{f&&(f.state&&f.state.toLowerCase?f.state.toLowerCase():"")==="disconnected"&&O()}catch{}},1e4),window.addEventListener("error",function(){t.loading&&I(!1)}),window.addEventListener("unhandledrejection",function(){t.loading&&I(!1)})})();})();
