(()=>{window.__chatAppBooted?console.warn("chat.js: duplicate include detected, skipping second init"):window.__chatAppBooted=!0;(function(){let I=(e,n,o)=>window.appLogger&&window.appLogger[e]?window.appLogger[e](n,o):console.log(`[${e}] ${n}`,o||""),N={UNKNOWN:"UNKNOWN",PROBING:"PROBING",AUTHENTICATED:"AUTHENTICATED",UNAUTHENTICATED:"UNAUTHENTICATED"},t={loading:!0,profile:null,rooms:[],users:[],messages:[],joinedRoom:null,filter:"",oldestLoaded:null,canLoadMore:!0,pageSize:20,loadingMore:!1,lastSendAt:0,minSendIntervalMs:800,joinInProgress:!1,pendingJoin:null,outbox:[],pendingAck:{},authStatus:N.UNKNOWN,pendingMessages:{},isOffline:!1,unreadCount:0};t._hubStartedEarly=!1,t._graceStartedAt=null,t._graceEnded=!1;let a={};function P(){return!!(t.authGraceUntil&&Date.now()<t.authGraceUntil)}function fe(){a.app=document.querySelector(".app");let e=Array.from(document.querySelectorAll(".vh-100"));if(a.loaderWrapper=e.find(n=>n.querySelector(".spinner-border"))||document.querySelector(".d-flex.vh-100")||e[0],a.loaderWrapper===e[0]&&e.length>1){let n=e.find(o=>o!==e[0]);n&&(a.loaderWrapper=n)}a.roomsList=document.getElementById("rooms-list"),a.usersList=document.getElementById("users-list"),a.messagesList=document.getElementById("messages-list"),a.messageInput=document.getElementById("message-input"),a.joinedRoomTitle=document.getElementById("joinedRoom"),a.filterInput=document.querySelector(".users-container input[type=text]"),a.errorAlert=document.getElementById("errorAlert"),a.itemToDelete=document.getElementById("itemToDelete"),a.profileAvatarImg=document.getElementById("profileAvatarImg")||document.querySelector(".profile img.avatar"),a.profileAvatarInitial=document.getElementById("profileAvatarInitial")||document.querySelector(".profile span.avatar"),a.profileName=document.getElementById("profileName")||document.querySelector(".profile span:not(.avatar)"),a.btnLogin=document.getElementById("btn-login"),a.btnLogout=document.getElementById("btn-logout"),a.roomsNoSelection=document.querySelector('[data-role="no-room-selected"]'),a.roomsPanel=document.querySelector('[data-role="room-panel"]'),a.usersCount=document.getElementById("users-count"),a.queueBadge=document.getElementById("queue-badge"),a.roomHeader=document.querySelector('.main-content[data-role="room-panel"] .header')}function v(e){t.loading=e,a.loaderWrapper&&a.loaderWrapper.classList.toggle("d-none",!e),a.app&&a.app.classList.toggle("d-none",e)}function L(e){if(a.roomHeader)switch(a.roomHeader.classList.remove("connection-state-connected","connection-state-reconnecting","connection-state-disconnected"),!t._baseRoomTitle&&a.joinedRoomTitle&&(t._baseRoomTitle=a.joinedRoomTitle.textContent||""),e){case"connected":a.roomHeader.classList.add("connection-state-connected"),a.joinedRoomTitle&&t._baseRoomTitle&&(a.joinedRoomTitle.textContent=t._baseRoomTitle);break;case"reconnecting":a.roomHeader.classList.add("connection-state-reconnecting"),a.joinedRoomTitle&&t._baseRoomTitle&&(a.joinedRoomTitle.textContent=t._baseRoomTitle+" (RECONNECTING\u2026)");break;case"disconnected":if(a.roomHeader.classList.add("connection-state-disconnected"),a.joinedRoomTitle){let n=t._baseRoomTitle||a.joinedRoomTitle.textContent||"",o="\u26A0\uFE0F";a.joinedRoomTitle.textContent=n+" ("+o+" DISCONNECTED)"}break}}function Y(){if(!f)return"disconnected";let e=f.state&&f.state.toLowerCase?f.state.toLowerCase():"";return e==="connected"?"connected":e==="connecting"||e==="reconnecting"?"reconnecting":"disconnected"}function pe(){setInterval(()=>{L(Y())},2500)}function M(e,n){let o=e&&typeof e=="string"&&e.trim().length>0?e:n||"";return o&&o.trim().charAt(0).toUpperCase()||"?"}function C(){a.roomsList&&(a.roomsList.innerHTML="",t.rooms.forEach(e=>{let n=document.createElement("li"),o=document.createElement("a");o.href="#",o.textContent=e.name,o.dataset.roomId=e.id,t.pendingJoin===e.name&&(!t.joinedRoom||t.joinedRoom.name!==e.name)&&o.classList.add("joining"),t.joinedRoom&&t.joinedRoom.name===e.name&&o.classList.add("active"),o.addEventListener("click",s=>{s.preventDefault(),S(e.name)}),n.appendChild(o),a.roomsList.appendChild(n)}))}function w(){if(!a.usersList)return;let e=t.filter.toLowerCase();a.usersList.innerHTML="";let n=t.users.filter(o=>!e||(o.fullName||o.userName||"").toLowerCase().includes(e));n.forEach(o=>{let s=document.createElement("li");s.dataset.username=o.userName;let r=document.createElement("div");if(r.className="user",o.avatar){let l=document.createElement("img");l.className="avatar me-2",l.src="/avatars/"+o.avatar,r.appendChild(l)}else{let l=document.createElement("span");l.className="avatar me-2 text-uppercase",l.textContent=M(o.fullName,o.userName),r.appendChild(l)}let i=document.createElement("div");i.className="user-info";let u=document.createElement("span");u.className="name",u.textContent=o.fullName||o.userName,i.appendChild(u),r.appendChild(i),s.appendChild(r),a.usersList.appendChild(s)}),a.usersCount&&(a.usersCount.textContent=n.length)}function K(e){let n=new Date(e),s=Math.round((n-new Date)/(1e3*3600*24)),r=n.getDate(),i=n.getMonth()+1,u=n.getFullYear(),l=n.getHours(),m=("0"+n.getMinutes()).slice(-2),g=l>=12?"PM":"AM";l>12&&(l=l%12);let d=`${r}/${i}/${u}`,h=`${l}:${m} ${g}`,z=`${d} ${h}`,W=d;return s===0?W=`Today, ${h}`:s===-1&&(W=`Yesterday, ${h}`),{relative:W,full:z}}function b(){a.messagesList&&(a.messagesList.innerHTML="",t.messages.forEach(e=>O(e,!1)),R())}function O(e,n){if(!a.messagesList)return;let o=document.createElement("li");o.dataset.cid=e.correlationId||"",e.failed&&o.classList.add("failed");let s=document.createElement("div");if(s.className="message-item",e.isMine&&s.classList.add("ismine"),e.avatar){let d=document.createElement("img");d.className="avatar avatar-lg mx-2",d.src="/avatars/"+e.avatar,s.appendChild(d)}else{let d=document.createElement("span");d.className="avatar avatar-lg mx-2 text-uppercase",d.textContent=M(e.fromFullName,e.fromUserName),s.appendChild(d)}let r=document.createElement("div");r.className="message-content";let i=document.createElement("div");i.className="message-info d-flex flex-wrap align-items-center";let u=document.createElement("span");u.className="author",u.textContent=e.fromFullName||e.fromUserName,i.appendChild(u);let l=document.createElement("span");l.className="timestamp";let m=K(e.timestamp);if(l.textContent=m.relative,l.dataset.bsTitle=m.full,l.setAttribute("data-bs-toggle","tooltip"),i.appendChild(l),e.failed){let d=document.createElement("span");d.className="send-status ms-2 text-danger",d.textContent="(failed)",i.appendChild(d);let h=document.createElement("button");h.type="button",h.className="btn btn-link p-0 ms-2 retry-send",h.textContent="Retry",h.addEventListener("click",()=>se(e.correlationId)),i.appendChild(h)}else if(e.pending){let d=document.createElement("span");d.className="send-status ms-2 text-muted",d.textContent="\u2026",i.appendChild(d)}r.appendChild(i);let g=document.createElement("div");if(g.className="content",g.textContent=e.content,r.appendChild(g),s.appendChild(r),o.appendChild(s),a.messagesList.appendChild(o),n){let d=document.querySelector(".messages-container");d&&(d.scrollTop=d.scrollHeight)}return o}function E(e){if(!a.messagesList||!e.correlationId)return!1;let n=a.messagesList.querySelector('li[data-cid="'+e.correlationId+'"]');if(!n)return!1;let o=n.querySelector(".timestamp");if(o){let u=K(e.timestamp);o.textContent=u.relative,o.dataset.bsTitle=u.full}let s=n.querySelector(".content");s&&(s.textContent=e.content),n.classList.toggle("failed",!!e.failed);let r=n.querySelector(".send-status");if(!r&&(e.failed||e.pending)){let u=n.querySelector(".message-info");u&&(r=document.createElement("span"),r.className="send-status ms-2",u.appendChild(r))}r&&(e.failed?(r.textContent="(failed)",r.className="send-status ms-2 text-danger"):e.pending?(r.textContent="\u2026",r.className="send-status ms-2 text-muted"):r.remove());let i=n.querySelector("button.retry-send");if(e.failed){if(!i){let u=n.querySelector(".message-info");u&&(i=document.createElement("button"),i.type="button",i.className="btn btn-link p-0 ms-2 retry-send",i.textContent="Retry",i.addEventListener("click",()=>se(e.correlationId)),u.appendChild(i))}}else i&&i.remove();return n.dataset.cid=e.correlationId||"",!0}function R(){let e=document.querySelector(".no-messages-info");e&&e.classList.toggle("d-none",t.messages.length>0);let n=document.querySelector(".messages-container");n&&!t.loadingMore&&(n.scrollTop=n.scrollHeight),window.bootstrap&&[].slice.call(a.messagesList.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(s=>{try{new window.bootstrap.Tooltip(s)}catch{}})}function T(){let e=t.profile;a.profileName&&(e?(a.profileName.textContent=e.fullName||e.userName,e.avatar?(a.profileAvatarImg&&(a.profileAvatarImg.src="/avatars/"+e.avatar,a.profileAvatarImg.classList.remove("d-none")),a.profileAvatarInitial&&a.profileAvatarInitial.classList.add("d-none")):(a.profileAvatarInitial&&(a.profileAvatarInitial.textContent=M(e.fullName,e.userName),a.profileAvatarInitial.classList.remove("d-none")),a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none")),a.btnLogin&&a.btnLogin.classList.add("d-none"),a.btnLogout&&a.btnLogout.classList.remove("d-none")):(a.profileName.textContent="Not signed in",a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none"),a.profileAvatarInitial&&(a.profileAvatarInitial.classList.remove("d-none"),a.profileAvatarInitial.textContent="?"),a.btnLogin&&a.btnLogin.classList.remove("d-none"),a.btnLogout&&a.btnLogout.classList.add("d-none")))}let V=T;T=function(){if(!a.profileName){V();return}if(!t.profile){let e=P();if(t.authStatus===N.PROBING||e){a.profileName.textContent="Signing in\u2026",a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none"),a.profileAvatarInitial&&(a.profileAvatarInitial.classList.remove("d-none"),a.profileAvatarInitial.textContent="?"),a.btnLogin&&a.btnLogin.classList.add("d-none"),a.btnLogout&&a.btnLogout.classList.add("d-none");return}}V()};function ge(){if(!(!t.profile||t.profile.avatar)&&a.profileAvatarInitial){let e=M(t.profile.fullName,t.profile.userName);a.profileAvatarInitial.textContent=e,a.profileAvatarInitial.classList.remove("d-none"),a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none")}}function Q(){if(!a.roomsPanel||!a.roomsNoSelection)return;let e=!!t.joinedRoom;a.roomsPanel.classList.toggle("d-none",!e),a.roomsNoSelection.classList.toggle("d-none",e),t.joinedRoom&&a.joinedRoomTitle&&(a.joinedRoomTitle.textContent=t.joinedRoom.name),C()}function X(){T(),Q(),w(),b()}function D(){if(!a.queueBadge)return;let e=t.outbox.length;a.queueBadge.textContent=e,a.queueBadge.classList.toggle("d-none",e===0)}let H=e=>fetch(e,{credentials:"include"}).then(n=>n.ok?n.json():Promise.reject(n)),Be=(e,n)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),Pe=(e,n)=>fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),Oe=e=>fetch(e,{method:"DELETE",credentials:"include"}),f=null,j=0,he=3e4,Ne={nextRetryDelayInMilliseconds(e){let n=e&&typeof e.previousRetryCount=="number"?e.previousRetryCount+1:1,o=[0,2e3,5e3,1e4],s=n<=o.length?o[n-1]:3e4;return Math.min(s,3e4)}};function ye(e){let n=new Uint8Array(e);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(n);else for(let o=0;o<e;o++)n[o]=Math.floor(Math.random()*256);return n}function F(e,n){let o=ye(n),s="";for(let r of o)s+=(r&15).toString(16);return(e||"")+s+"_"+Date.now().toString(36)}let ve=F("s_8",8),A={},Z=4e3;function c(e,n){try{let o=Date.now(),s;if(/^send\.flush\.skip$/.test(e)&&(s=e+"|"+(n&&n.reason)),/^send\.queue$/.test(e)&&(s=e+"|"+(n&&n.reason)),/^hub\.connect\.retry$/.test(e)&&(s=e+"|"+(n&&n.attempt)),s){let r=A[s];if(r&&o-r<Z)return;A[s]=o}fetch("/api/telemetry/reconnect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({evt:e,ts:o,sessionId:ve,...n})})}catch{}}setInterval(()=>{try{let e=Date.now(),n=Z*3;for(let o in A)e-A[o]>n&&delete A[o]}catch{}},12e4);function be(e){if(!e)return{cat:"unknown",msg:""};let n=e&&(e.message||e.toString())||"";return/403|401|unauthor/i.test(n)?{cat:"auth",msg:n}:/timeout|timed out/i.test(n)?{cat:"timeout",msg:n}:/network|fetch|socket|ws|transport/i.test(n)?{cat:"transport",msg:n}:/server|500|hubexception/i.test(n)?{cat:"server",msg:n}:{cat:"other",msg:n}}let G=null;function ee(){if(f)return f;f=new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect(Ne).build();try{f.serverTimeoutInMilliseconds=12*60*60*1e3,f.keepAliveIntervalInMilliseconds=2e4}catch{}return Ie(f),f}function x(){ee();let e=f.state&&f.state.toLowerCase?f.state.toLowerCase():"";if(e&&e!=="disconnected")return I("warn","signalr.start.skip",{state:e}),c("hub.connect.skip",{state:e}),Promise.resolve();I("info","signalr.start"),L("reconnecting");let n=performance.now();return t.authStatus===N.PROBING&&!t.profile&&(t._hubStartedEarly||(c("auth.hub.start.early",{}),t._hubStartedEarly=!0)),f.start().then(()=>{j=0,G=null,oe(),c("hub.connected",{durationMs:Math.round(performance.now()-n)}),L("connected"),t.profile&&t.loading&&v(!1)}).catch(o=>{let s=o&&o.message||"";if(/not in the 'disconnected' state/i.test(s)||/cannot start a hubconnection that is not in the 'disconnected' state/i.test(s)){I("warn","signalr.start.duplicate",{message:s}),c("hub.connect.duplicateStart",{message:s});return}I("error","signalr.start.fail",{error:s}),c("hub.connect.fail",{message:s}),te(o)})}function k(){ee(),(f.state&&f.state.toLowerCase?f.state.toLowerCase():"")==="disconnected"&&x()}function te(e){e&&(G=e),j++;let n=Math.min(1e3*Math.pow(2,j),he);L("reconnecting");let{cat:o,msg:s}=be(G);c("hub.connect.retry",{attempt:j,delayMs:n,errorCategory:o,errorMessage:s.slice(0,300)}),setTimeout(()=>x().catch(r=>te(r)),n)}function Ie(e){e.on("getProfileInfo",n=>{t.profile={userName:n.userName,fullName:n.fullName,avatar:n.avatar},t.authStatus=N.AUTHENTICATED,v(!1),T(),p("profile")}),e.on("presenceSnapshot",n=>{if(!Array.isArray(n))return;let o=n.map(s=>({userName:s.userName||s.UserName||s.username||"",fullName:s.fullName||s.FullName||s.name||"",avatar:s.avatar||s.Avatar||"",currentRoom:s.currentRoom||s.CurrentRoom||s.room||null,...s}));t.joinedRoom?t.users=o.filter(s=>s.currentRoom===t.joinedRoom.name):t.users=o,w()}),e.on("newMessage",n=>{if(t.profile&&t.profile.userName&&n.correlationId){let s=t.messages.findIndex(r=>r.isMine&&r.correlationId===n.correlationId);if(s>=0){t.messages[s]={id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:!0,correlationId:n.correlationId},t.pendingMessages[n.correlationId]&&delete t.pendingMessages[n.correlationId],E(t.messages[s])?R():b();return}}we({...n,correlationId:n.correlationId});try{!!(t.profile&&t.profile.userName===n.fromUserName)||(me()?B():(t.unreadCount=(t.unreadCount||0)+1,ue(n.room||t.joinedRoom&&t.joinedRoom.name||""),de()))}catch{}}),e.on("notify",n=>Te(n)),e.onreconnected(n=>{try{t.joinedRoom?S(t.joinedRoom.name,!0):oe()}catch{}L("connected")}),e.onreconnecting(n=>{I("warn","hub.reconnecting",{message:n&&n.message}),L("reconnecting")}),e.onclose(()=>{L("disconnected"),t.users=[],w()}),e.on("addUser",n=>Le(n)),e.on("removeUser",n=>Re(n.userName)),e.on("addChatRoom",n=>ne(n)),e.on("updateChatRoom",n=>ne(n)),e.on("removeChatRoom",n=>{t.rooms=t.rooms.filter(o=>o.id!==n),t.joinedRoom&&t.joinedRoom.id===n&&(t.joinedRoom=null,t.messages=[]),X()}),e.on("onError",n=>q(n))}function ne(e){let n=t.rooms.find(o=>o.id===e.id);n?(n.name=e.name,n.admin=e.admin):t.rooms.push({id:e.id,name:e.name,admin:e.admin}),C()}function Le(e){let n={userName:e.userName||e.UserName||e.username||"",fullName:e.fullName||e.FullName||e.name||"",avatar:e.avatar||e.Avatar||"",currentRoom:e.currentRoom||e.CurrentRoom||e.room||null,...e},o=t.users.find(s=>s.userName===n.userName);o?Object.assign(o,n):t.users.push(n),w()}function Re(e){t.users=t.users.filter(n=>n.userName!==e),w()}function we(e){let n=t.profile&&t.profile.userName===e.fromUserName,o={id:e.id,content:e.content,timestamp:e.timestamp,fromUserName:e.fromUserName,fromFullName:e.fromFullName,avatar:e.avatar,isMine:n,correlationId:e.correlationId};t.messages.push(o),a.messagesList&&t.messages.length>1?(O(o,!0),R()):b()}function Te(e){let n=e.ts||new Date().toISOString(),o=`[NOTIFY] ${e.title}${e.body?": "+e.body:""}`;t.messages.push({id:"notify_"+n,content:o,timestamp:n,fromUserName:e.from||"system",fromFullName:e.from||"system",avatar:null,isMine:!1}),b()}function S(e,n){if(!f||!e||t.joinInProgress&&t.pendingJoin===e||!n&&t.joinedRoom&&t.joinedRoom.name===e&&!t.joinInProgress)return;let o=F("j_",8);t._joinToken=o,t.joinInProgress=!0,t.pendingJoin=e,C();let s=performance.now(),r=3,i=0;function u(){i++,f.invoke("Join",e).then(()=>{t._joinToken!==o||t.pendingJoin!==e||(t.joinedRoom=t.rooms.find(l=>l.name===e)||{name:e},t.pendingJoin=null,t.joinInProgress=!1,localStorage.setItem("lastRoom",e),a.joinedRoomTitle&&(t._baseRoomTitle=t.joinedRoom.name,a.joinedRoomTitle.textContent=t._baseRoomTitle),Ce(),Ee(),Q(),ge(),c("room.join.success",{room:e,durationMs:Math.round(performance.now()-s),attempts:i}),p("join"))}).catch(l=>{if(t._joinToken!==o)return;let m=l&&l.message||"";if(/timeout|temporar|network|reconnect|connection/i.test(m)&&i<r){let d=300*i;c("room.join.retry",{room:e,attempt:i,backoff:d,msg:m.slice(0,120)}),setTimeout(u,d)}else t.pendingJoin===e&&(t.joinInProgress=!1,t.pendingJoin=null),C(),c("room.join.fail",{room:e,attempts:i,msg:m.slice(0,200)}),q("Join failed: "+m)})}u()}function oe(){H("/api/Rooms").then(e=>{t.rooms=(e||[]).map(o=>({id:o.id!==void 0?o.id:o.Id,name:o.name!==void 0?o.name:o.Name,admin:o.admin!==void 0?o.admin:o.Admin})),C();let n=localStorage.getItem("lastRoom");n&&t.rooms.some(o=>o.name===n)?S(n):t.rooms.length>0&&S(t.rooms[0].name)}).catch(()=>{})}function Ce(){t.joinedRoom&&f.invoke("GetUsers",t.joinedRoom.name).then(e=>{let n=(e||[]).map(o=>({userName:o.userName||o.UserName||o.username||"",fullName:o.fullName||o.FullName||o.name||"",avatar:o.avatar||o.Avatar||"",currentRoom:o.currentRoom||o.CurrentRoom||o.room||null,...o}));t.users=n,w()})}function Ee(){t.joinedRoom&&(t.oldestLoaded=null,t.canLoadMore=!0,H("/api/Messages/Room/"+encodeURIComponent(t.joinedRoom.name)+"?take="+t.pageSize).then(e=>{t.messages=e.map(n=>({id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:t.profile&&t.profile.userName===n.fromUserName})),t.messages.length>0?(t.oldestLoaded=t.messages[0].timestamp,e.length<t.pageSize&&(t.canLoadMore=!1)):t.canLoadMore=!1,b(),Se()}).catch(()=>{}))}let J=0;function Ae(){if(!t.canLoadMore||t.loadingMore||!t.joinedRoom||!t.oldestLoaded)return;t.loadingMore=!0;let e=++J,n=t.oldestLoaded,o=encodeURIComponent(n);c("messages.page.req",{before:n,token:e}),H("/api/Messages/Room/"+encodeURIComponent(t.joinedRoom.name)+"?before="+o+"&take="+t.pageSize).then(s=>{if(e!==J){c("messages.page.stale",{token:e});return}if(!Array.isArray(s)||s.length===0){t.canLoadMore=!1,c("messages.page.empty",{token:e});return}let r=s.map(m=>({id:m.id,content:m.content,timestamp:m.timestamp,fromUserName:m.fromUserName,fromFullName:m.fromFullName,avatar:m.avatar,isMine:t.profile&&t.profile.userName===m.fromUserName})),i=document.querySelector(".messages-container"),u=i?i.scrollHeight:0,l=t.oldestLoaded;if(t.messages=r.concat(t.messages),t.oldestLoaded=t.messages[0].timestamp,l&&t.oldestLoaded>l&&(c("messages.page.nonmonotonic",{prev:l,now:t.oldestLoaded}),t.oldestLoaded=l),s.length<t.pageSize&&(t.canLoadMore=!1),b(),i){let m=i.scrollHeight;i.scrollTop=m-u}c("messages.page.ok",{token:e,added:s.length,remaining:t.canLoadMore?1:0})}).catch(s=>{c("messages.page.err",{token:e,msg:s&&s.message||""})}).finally(()=>{e===J&&(t.loadingMore=!1)})}function Se(){let e=document.querySelector(".messages-container");if(!e||e.dataset.paginated)return;e.dataset.paginated="true";let n=0;e.addEventListener("scroll",()=>{if(e.scrollTop<40){let o=Date.now();o-n>500&&(n=o,!t.loadingMore&&t.canLoadMore&&t.joinedRoom&&t.oldestLoaded&&Ae())}B()})}let Me=-1;function U(e,n,o,s){let r=Date.now();if(!n&&r-t.lastSendAt<t.minSendIntervalMs)return q("You are sending messages too quickly"),Promise.reject("rateLimited");!o&&!s&&(t.lastSendAt=r);let i=s||F("c_",12),u;if(s){let g=t.messages.find(d=>d.correlationId===s);g&&(u=g.id)}else{u=Me--;let g=new Date().toISOString(),d={id:u,content:e,timestamp:g,fromUserName:t.profile?.userName,fromFullName:t.profile?.fullName,avatar:t.profile?.avatar,isMine:!!t.profile,correlationId:i,pending:!0};t.messages.push(d),a.messagesList&&t.messages.length>1?(O(d,!0),R()):b()}if(!f)return Promise.reject("noHub");let l=t.pendingMessages[i]||{attempts:0,createdAt:Date.now(),text:e,tempId:u};l.attempts++,t.pendingMessages[i]=l,c("send.attempt",{cid:i,len:e.length,fromFlush:!!o,attempts:l.attempts,resend:!!s});let m=f.invoke("SendMessage",e,i).then(()=>{c("send.invoke.ok",{cid:i}),je(i)}).catch(g=>{let d=g&&g.message||"",h=t.messages.find(z=>z.correlationId===i);throw h&&(h.failed=!0,h.pending=!1),delete t.pendingMessages[i],c("send.invoke.fail",{cid:i,msg:d}),h&&(E(h)?R():b()),g});return s||ae(i),m}function ae(e){setTimeout(()=>{let o=t.pendingMessages[e];if(o){if(o.attempts>=3){c("send.timeout.giveup",{cid:e,attempts:o.attempts}),c("send.reconcile",{cid:e,mode:"giveup",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),delete t.pendingMessages[e];let s=t.messages.find(r=>r.correlationId===e);s&&(s.failed=!0,s.pending=!1,E(s)?R():b());return}c("send.timeout.resend",{cid:e,attempts:o.attempts}),c("send.reconcile",{cid:e,mode:"timeout-resend",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),U(o.text,!0,!0,e),ae(e)}},3e4)}function je(e){let n=t.messages.find(s=>s.correlationId===e);n&&(n.pending=!1,n.failed=!1,E(n)?R():b());let o=t.pendingMessages[e];o&&c("send.reconcile",{cid:e,mode:"ack",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),delete t.pendingMessages[e]}function se(e){let n=t.messages.find(o=>o.correlationId===e);n&&(n.failed=!1,n.pending=!0,E(n)?R():b(),c("send.retry.manual",{cid:e}),U(n.content,!0,!0,e))}function _(e){t.outbox.length>=50&&t.outbox.shift(),t.outbox.push(e),D(),$()}function ie(){let e=(a.messageInput&&a.messageInput.value||"").trim();if(e){if(t.isOffline){_(e),c("send.queue",{reason:"offline",size:t.outbox.length}),a.messageInput&&(a.messageInput.value="");return}if(!t.profile){let n=Date.now(),o=P();if(t.authStatus===N.UNKNOWN||t.authStatus===N.PROBING||o){_(e);let s="awaitingProfile";o?s="authGrace":t.loading?s="loadingUI":t.authStatus===N.PROBING&&(s="authProbing"),c("send.queue",{reason:s,size:t.outbox.length}),a.messageInput&&(a.messageInput.value="");return}q("Not signed in.");return}if(t.joinInProgress||t.pendingJoin){_(e),c("send.queue",{reason:"joinInProgress",size:t.outbox.length}),a.messageInput&&(a.messageInput.value="");return}if(!t.joinedRoom){let n=t.rooms&&t.rooms.length?localStorage.getItem("lastRoom")&&t.rooms.some(o=>o.name===localStorage.getItem("lastRoom"))?localStorage.getItem("lastRoom"):t.rooms[0].name:null;n&&S(n),_(e),c("send.queue",{reason:"noRoomYet",size:t.outbox.length}),a.messageInput&&(a.messageInput.value="");return}U(e,!1,!1),a.messageInput&&(a.messageInput.value="")}}function re(){t.rooms=[],t.users=[],t.messages=[],t.profile=null,t.joinedRoom=null,X(),v(!1)}function le(){t.authStatus=N.PROBING;let e=performance.now();t.authGraceUntil=Date.now()+5e3,setTimeout(()=>{!t.profile&&(t.authStatus===N.PROBING||t.authStatus===N.UNKNOWN)&&!P()&&(t.authStatus=N.UNAUTHENTICATED,c("auth.finalize.unauth",{}),T())},5200);let n=setTimeout(()=>{I("warn","auth.timeout"),v(!1),c("auth.probe.timeout",{})},6e3);return fetch("/api/auth/me",{credentials:"include"}).then(o=>o.ok?o.json():null).then(o=>{clearTimeout(n),o&&o.userName?(t.profile={userName:o.userName,fullName:o.fullName,avatar:o.avatar},t.authStatus=N.AUTHENTICATED,c("auth.probe.success",{durationMs:Math.round(performance.now()-e)}),x(),p("authProbe"),t.authGraceUntil=null):(v(!1),t.authStatus=N.UNAUTHENTICATED,c("auth.probe.unauth",{durationMs:Math.round(performance.now()-e)})),T()}).catch(o=>{clearTimeout(n),v(!1);let s=o&&o.message||"";/timeout|network|fetch|offline|temporar(?:y|ily)?|dns|refused/i.test(s)?(c("auth.probe.errorTransient",{durationMs:Math.round(performance.now()-e)}),t.authGraceUntil=Date.now()+5e3,setTimeout(()=>{(t.authStatus===N.PROBING||t.authStatus===N.UNKNOWN)&&le()},1200)):(t.authStatus=N.UNAUTHENTICATED,c("auth.probe.error",{durationMs:Math.round(performance.now()-e)}))}).finally(()=>{})}function xe(){a.messageInput&&a.messageInput.addEventListener("keypress",n=>{n.key==="Enter"&&ie()});let e=document.getElementById("btn-send-message");e&&e.addEventListener("click",n=>{n.preventDefault(),ie()}),a.filterInput&&a.filterInput.addEventListener("input",()=>{t.filter=a.filterInput.value,w()}),a.btnLogout&&a.btnLogout.addEventListener("click",()=>{fetch("/api/auth/logout",{method:"POST",credentials:"include"}).catch(()=>{}).finally(()=>{try{f&&f.stop&&f.stop()}catch{}re(),window.location.replace("/login?ReturnUrl=/chat")})})}function q(e){if(!a.errorAlert)return;let n=a.errorAlert.querySelector("span");n&&(n.textContent=e),a.errorAlert.classList.remove("d-none"),setTimeout(()=>a.errorAlert.classList.add("d-none"),5e3)}window.chatApp=window.chatApp||{},window.chatApp.onAuthenticated=function(){v(!0),t.authStatus=N.PROBING;let e=performance.now(),n=!1,o=!1,s=6,r=400,i=0;function u(){i++,fetch("/api/auth/me",{credentials:"include"}).then(l=>l.ok?l.json():null).then(l=>{l&&l.userName?(o=!0,t.profile={userName:l.userName,fullName:l.fullName,avatar:l.avatar},t.authStatus=N.AUTHENTICATED,T(),x(),p("authRetry"),t.loading&&v(!1)):i<s?setTimeout(u,r*i):(t.loading&&v(!1),I("warn","auth.retry.exhausted"),t.authStatus=N.UNAUTHENTICATED)}).catch(()=>{i<s?setTimeout(u,r*i):(t.loading&&v(!1),I("error","auth.retry.failed"),t.authStatus=N.UNAUTHENTICATED)}).finally(()=>{(i>=s||o)&&(n=!0)})}u(),setTimeout(()=>{t.loading&&(t.profile||n)&&(v(!1),I("warn","auth.safetyFallback",{elapsedMs:Math.round(performance.now()-e)}))},2e3)},window.chatApp.logoutCleanup=re;function ke(){try{let e=sessionStorage.getItem("chat.outbox");if(e){let n=JSON.parse(e);Array.isArray(n)&&(t.outbox=n.slice(0,50))}}catch{}D()}function $(){try{sessionStorage.setItem("chat.outbox",JSON.stringify(t.outbox))}catch{}}function p(e){if(p._queue||(p._queue=[]),p._inProgress){p._queue.push(e);return}if(!t.outbox.length)return;if(t.isOffline){let m="flushSkip:offline:"+e;p._skipFlags||(p._skipFlags={}),p._skipFlags[m]||(p._skipFlags[m]=Date.now(),c("send.flush.skip",{reason:"offline",phase:e,qlen:t.outbox.length}));return}if(!t.profile||!t.joinedRoom){let m=t.profile?"noRoom":t.joinedRoom?"noProfile":"noProfile_noRoom",g="flushSkip:"+m+":"+e;p._skipFlags||(p._skipFlags={}),p._skipFlags[g]||(p._skipFlags[g]=Date.now(),c("send.flush.skip",{reason:m,phase:e,qlen:t.outbox.length}));return}p._inProgress=!0;let n=10,o=t.outbox.length,s=performance.now();c("send.flush.start",{room:t.joinedRoom&&t.joinedRoom.name,count:o,phase:e});let r=0,i=0,u=t.outbox.splice(0,o);D(),$();function l(){if(!u.length)return Promise.resolve();let m=u.splice(0,n),g=[];return Promise.all(m.map(d=>U(d,!0,!0).then(()=>{r++,g.push({ok:!0})}).catch(()=>{i++,g.push({ok:!1,text:d})}))).then(()=>{let d=g.filter(h=>!h.ok).map(h=>h.text);return d.length&&(d.forEach(h=>t.outbox.push(h)),$(),c("send.flush.batchFail",{failed:d.length,phase:e})),l()})}l().finally(()=>{if(i&&c("send.flush.partialFail",{failed:i,success:r,remaining:t.outbox.length,phase:e}),c("send.flush.done",{room:t.joinedRoom&&t.joinedRoom.name,count:o,success:r,failed:i,durationMs:Math.round(performance.now()-s),phase:e}),p._inProgress=!1,p._queue.length){let m=p._queue.pop();p._queue.length=0,setTimeout(()=>p(m),0)}})}setInterval(()=>{try{t.outbox.length&&p("periodic"),t.outbox.length===0&&a.queueBadge&&a.queueBadge.textContent!=="0"&&!a.queueBadge.classList.contains("d-none")&&(a.queueBadge.textContent="0",a.queueBadge.classList.add("d-none"))}catch{}},1500),document.addEventListener("visibilitychange",()=>{document.hidden||p("visibility")}),document.addEventListener("visibilitychange",()=>{document.hidden||(B(),k())}),window.addEventListener("focus",()=>{B(),k()}),document.addEventListener("DOMContentLoaded",()=>{if(fe(),a.offlineBanner=document.getElementById("offline-banner"),!a.offlineBanner){let e=document.createElement("div");e.id="offline-banner",e.className="alert alert-warning text-center py-1 mb-0 d-none",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.textContent="You are offline. Messages will send when connection is restored.",document.body.prepend(e),a.offlineBanner=e}ke(),v(!0),le(),xe(),pe(),Ue(),ce()});function Ue(){function e(n){t.isOffline=n,a.offlineBanner&&a.offlineBanner.classList.toggle("d-none",!n),n?c("net.offline",{}):(c("net.online",{}),setTimeout(()=>{k(),t.outbox.length&&p("online")},150)),L(Y())}typeof navigator<"u"&&"onLine"in navigator&&e(!navigator.onLine),window.addEventListener("offline",()=>e(!0)),window.addEventListener("online",()=>e(!1))}let y={base:null,timer:null,active:!1,counter:0,lastLabel:""};function ce(){try{y.base=document.title||"Chat"}catch{y.base="Chat"}}function de(){if(y.base||ce(),y.active)return;y.active=!0;let e=!0;y.timer=setInterval(()=>{try{document.title=e?y.lastLabel:y.base}catch{}e=!e},1e3)}function ue(e){let n=t.unreadCount||0,o=(n>0?"("+n+") ":"")+"New message"+(e?" \u2022 "+e:"");y.lastLabel=o,n>0&&!y.active&&de()}function _e(){if(y.timer){try{clearInterval(y.timer)}catch{}y.timer=null}y.active=!1,y.counter=0;try{y.base&&(document.title=y.base)}catch{}}function qe(){let e=document.querySelector(".messages-container");return e?e.scrollHeight-e.scrollTop-e.clientHeight<=8:!1}function me(){try{return!document.hidden&&!!t.joinedRoom&&window.document.hasFocus()&&qe()}catch{return!1}}function B(){t.unreadCount>0&&me()?(t.unreadCount=0,_e()):t.unreadCount>0&&ue(t.joinedRoom&&t.joinedRoom.name||"")}setInterval(()=>{try{f&&(f.state&&f.state.toLowerCase?f.state.toLowerCase():"")==="disconnected"&&k()}catch{}},1e4),window.addEventListener("error",function(){t.loading&&v(!1)}),window.addEventListener("unhandledrejection",function(){t.loading&&v(!1)})})();})();
