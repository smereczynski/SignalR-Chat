(()=>{(function(){let y=(e,t,a)=>window.appLogger&&window.appLogger[e]?window.appLogger[e](t,a):console.log(`[${e}] ${t}`,a||""),n={loading:!0,profile:null,rooms:[],users:[],messages:[],joinedRoom:null,filter:"",oldestLoaded:null,canLoadMore:!0,pageSize:20,loadingMore:!1,lastSendAt:0,minSendIntervalMs:800},o={};function D(){o.app=document.querySelector(".app");let e=Array.from(document.querySelectorAll(".vh-100"));if(o.loaderWrapper=e.find(t=>t.querySelector(".spinner-border"))||document.querySelector(".d-flex.vh-100")||e[0],o.loaderWrapper===e[0]&&e.length>1){let t=e.find(a=>a!==e[0]);t&&(o.loaderWrapper=t)}o.roomsList=document.getElementById("rooms-list"),o.usersList=document.getElementById("users-list"),o.messagesList=document.getElementById("messages-list"),o.messageInput=document.getElementById("message-input"),o.joinedRoomTitle=document.getElementById("joinedRoom"),o.filterInput=document.querySelector(".users-container input[type=text]"),o.errorAlert=document.getElementById("errorAlert"),o.itemToDelete=document.getElementById("itemToDelete"),o.profileAvatarImg=document.getElementById("profileAvatarImg")||document.querySelector(".profile img.avatar"),o.profileAvatarInitial=document.getElementById("profileAvatarInitial")||document.querySelector(".profile span.avatar"),o.profileName=document.getElementById("profileName")||document.querySelector(".profile span:not(.avatar)"),o.btnLogin=document.getElementById("btn-login"),o.btnLogout=document.getElementById("btn-logout"),o.roomsNoSelection=document.querySelector('[data-role="no-room-selected"]'),o.roomsPanel=document.querySelector('[data-role="room-panel"]'),o.usersCount=document.getElementById("users-count")}function f(e){n.loading=e,o.loaderWrapper&&o.loaderWrapper.classList.toggle("d-none",!e),o.app&&o.app.classList.toggle("d-none",e)}function v(e,t){let a=e&&typeof e=="string"&&e.trim().length>0?e:t||"";return a&&a.trim().charAt(0).toUpperCase()||"?"}function E(){o.roomsList&&(o.roomsList.innerHTML="",n.rooms.forEach(e=>{let t=document.createElement("li"),a=document.createElement("a");a.href="#",a.textContent=e.name,a.dataset.roomId=e.id,n.joinedRoom&&n.joinedRoom.name===e.name&&a.classList.add("active"),a.addEventListener("click",r=>{r.preventDefault(),A(e.name)}),t.appendChild(a),o.roomsList.appendChild(t)}))}function h(){if(!o.usersList)return;let e=n.filter.toLowerCase();o.usersList.innerHTML="";let t=n.users.filter(a=>!e||(a.fullName||a.userName||"").toLowerCase().includes(e));t.forEach(a=>{let r=document.createElement("li");r.dataset.username=a.userName;let s=document.createElement("div");if(s.className="user",a.avatar){let l=document.createElement("img");l.className="avatar me-2",l.src="/avatars/"+a.avatar,s.appendChild(l)}else{let l=document.createElement("span");l.className="avatar me-2 text-uppercase",l.textContent=v(a.fullName,a.userName),s.appendChild(l)}let i=document.createElement("div");i.className="user-info";let u=document.createElement("span");u.className="name",u.textContent=a.fullName||a.userName,i.appendChild(u);let m=document.createElement("span");m.className="device",m.textContent=a.device,i.appendChild(m),s.appendChild(i),r.appendChild(s),o.usersList.appendChild(r)}),o.usersCount&&(o.usersCount.textContent=t.length)}function P(e){let t=new Date(e),r=Math.round((t-new Date)/(1e3*3600*24)),s=t.getDate(),i=t.getMonth()+1,u=t.getFullYear(),m=t.getHours(),l=("0"+t.getMinutes()).slice(-2),L=m>=12?"PM":"AM";m>12&&(m=m%12);let g=`${s}/${i}/${u}`,c=`${m}:${l} ${L}`,se=`${g} ${c}`,S=g;return r===0?S=`Today, ${c}`:r===-1&&(S=`Yesterday, ${c}`),{relative:S,full:se}}function p(){if(!o.messagesList)return;o.messagesList.innerHTML="",n.messages.forEach(a=>{let r=document.createElement("li"),s=document.createElement("div");if(s.className="message-item",a.isMine&&s.classList.add("ismine"),a.avatar){let c=document.createElement("img");c.className="avatar avatar-lg mx-2",c.src="/avatars/"+a.avatar,s.appendChild(c)}else{let c=document.createElement("span");c.className="avatar avatar-lg mx-2 text-uppercase",c.textContent=v(a.fromFullName,a.fromUserName),s.appendChild(c)}let i=document.createElement("div");i.className="message-content";let u=document.createElement("div");u.className="message-info d-flex flex-wrap align-items-center";let m=document.createElement("span");m.className="author",m.textContent=a.fromFullName||a.fromUserName,u.appendChild(m);let l=document.createElement("span");l.className="timestamp";let L=P(a.timestamp);l.textContent=L.relative,l.dataset.bsTitle=L.full,l.setAttribute("data-bs-toggle","tooltip"),u.appendChild(l),i.appendChild(u);let g=document.createElement("div");g.className="content",g.textContent=a.content,i.appendChild(g),s.appendChild(i),r.appendChild(s),o.messagesList.appendChild(r)});let e=document.querySelector(".no-messages-info");e&&e.classList.toggle("d-none",n.messages.length>0);let t=document.querySelector(".messages-container");t&&!n.loadingMore&&(t.scrollTop=t.scrollHeight),window.bootstrap&&[].slice.call(o.messagesList.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(r=>{try{new window.bootstrap.Tooltip(r)}catch{}})}function R(){let e=n.profile;o.profileName&&(e?(o.profileName.textContent=e.fullName||e.userName,e.avatar?(o.profileAvatarImg&&(o.profileAvatarImg.src="/avatars/"+e.avatar,o.profileAvatarImg.classList.remove("d-none")),o.profileAvatarInitial&&o.profileAvatarInitial.classList.add("d-none")):(o.profileAvatarInitial&&(o.profileAvatarInitial.textContent=v(e.fullName,e.userName),o.profileAvatarInitial.classList.remove("d-none")),o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none")),o.btnLogin&&o.btnLogin.classList.add("d-none"),o.btnLogout&&o.btnLogout.classList.remove("d-none")):(o.profileName.textContent="Not signed in",o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none"),o.profileAvatarInitial&&(o.profileAvatarInitial.classList.remove("d-none"),o.profileAvatarInitial.textContent="?"),o.btnLogin&&o.btnLogin.classList.remove("d-none"),o.btnLogout&&o.btnLogout.classList.add("d-none")))}function F(){if(!(!n.profile||n.profile.avatar)&&o.profileAvatarInitial){let e=v(n.profile.fullName,n.profile.userName);o.profileAvatarInitial.textContent=e,o.profileAvatarInitial.classList.remove("d-none"),o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none")}}function M(){if(!o.roomsPanel||!o.roomsNoSelection)return;let e=!!n.joinedRoom;o.roomsPanel.classList.toggle("d-none",!e),o.roomsNoSelection.classList.toggle("d-none",e),n.joinedRoom&&o.joinedRoomTitle&&(o.joinedRoomTitle.textContent=n.joinedRoom.name),E()}function b(){R(),M(),h(),p()}let C=e=>fetch(e,{credentials:"include"}).then(t=>t.ok?t.json():Promise.reject(t)),j=(e,t)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),H=(e,t)=>fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),O=e=>fetch(e,{method:"DELETE",credentials:"include"}),d=null,N=0,$=3e4;function W(e){if(!e)return{cat:"unknown",msg:""};let t=e&&(e.message||e.toString())||"";return/403|401|unauthor/i.test(t)?{cat:"auth",msg:t}:/timeout|timed out/i.test(t)?{cat:"timeout",msg:t}:/network|fetch|socket|ws|transport/i.test(t)?{cat:"transport",msg:t}:/server|500|hubexception/i.test(t)?{cat:"server",msg:t}:{cat:"other",msg:t}}let w=null;function z(){return d||(d=new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build(),J(d),d)}function U(){return z(),y("info","signalr.start"),d.start().then(()=>{N=0,w=null,K()}).catch(e=>{y("error","signalr.start.fail",{error:e&&e.message}),x(e)})}function x(e){e&&(w=e),N++;let t=Math.min(1e3*Math.pow(2,N),$),{cat:a,msg:r}=W(w);try{fetch("/api/telemetry/reconnect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attempt:N,delayMs:t,errorCategory:a,errorMessage:r.slice(0,300)})})}catch{}setTimeout(()=>U().catch(s=>x(s)),t)}function J(e){e.on("getProfileInfo",t=>{n.profile={userName:t.userName,fullName:t.fullName,avatar:t.avatar},f(!1),R()}),e.on("newMessage",t=>{if(n.profile&&n.profile.userName){if(t.correlationId){let s=n.messages.findIndex(i=>i.isMine&&i.correlationId&&i.correlationId===t.correlationId);if(s>=0){n.messages[s]={id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:!0,correlationId:t.correlationId},p();return}}let r=n.messages.findIndex(s=>s.isMine&&s.id<0&&s.content===t.content);if(r>=0){n.messages[r]={id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:!0,correlationId:t.correlationId},p();return}}G({...t,correlationId:t.correlationId})}),e.on("addUser",t=>_(t)),e.on("removeUser",t=>Y(t.userName)),e.on("addChatRoom",t=>T(t)),e.on("updateChatRoom",t=>T(t)),e.on("removeChatRoom",t=>{n.rooms=n.rooms.filter(a=>a.id!==t),n.joinedRoom&&n.joinedRoom.id===t&&(n.joinedRoom=null,n.messages=[]),b()}),e.on("onError",t=>I(t))}function T(e){let t=n.rooms.find(a=>a.id===e.id);t?(t.name=e.name,t.admin=e.admin):n.rooms.push({id:e.id,name:e.name,admin:e.admin}),E()}function _(e){let t=n.users.find(a=>a.userName===e.userName);t?Object.assign(t,e):n.users.push(e),h()}function Y(e){n.users=n.users.filter(t=>t.userName!==e),h()}function G(e){let t=n.profile&&n.profile.userName===e.fromUserName;n.messages.push({id:e.id,content:e.content,timestamp:e.timestamp,fromUserName:e.fromUserName,fromFullName:e.fromFullName,avatar:e.avatar,isMine:t,correlationId:e.correlationId}),p()}function A(e){!d||!e||d.invoke("Join",e).then(()=>{n.joinedRoom=n.rooms.find(t=>t.name===e)||{name:e},localStorage.setItem("lastRoom",e),Q(),V(),M(),F()}).catch(t=>I("Join failed: "+(t&&t.message)))}function K(){C("/api/Rooms").then(e=>{n.rooms=e,E();let t=localStorage.getItem("lastRoom");t&&n.rooms.some(a=>a.name===t)?A(t):n.rooms.length>0&&A(n.rooms[0].name)}).catch(()=>{})}function Q(){n.joinedRoom&&d.invoke("GetUsers",n.joinedRoom.name).then(e=>{n.users=e,h()})}function V(){n.joinedRoom&&(n.oldestLoaded=null,n.canLoadMore=!0,C("/api/Messages/Room/"+encodeURIComponent(n.joinedRoom.name)+"?take="+n.pageSize).then(e=>{n.messages=e.map(t=>({id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:n.profile&&n.profile.userName===t.fromUserName})),n.messages.length>0?(n.oldestLoaded=n.messages[0].timestamp,e.length<n.pageSize&&(n.canLoadMore=!1)):n.canLoadMore=!1,p(),Z()}).catch(()=>{}))}function X(){if(!n.canLoadMore||n.loadingMore||!n.joinedRoom||!n.oldestLoaded)return;n.loadingMore=!0;let e=encodeURIComponent(n.oldestLoaded);C("/api/Messages/Room/"+encodeURIComponent(n.joinedRoom.name)+"?before="+e+"&take="+n.pageSize).then(t=>{if(!Array.isArray(t)||t.length===0){n.canLoadMore=!1;return}let a=t.map(i=>({id:i.id,content:i.content,timestamp:i.timestamp,fromUserName:i.fromUserName,fromFullName:i.fromFullName,avatar:i.avatar,isMine:n.profile&&n.profile.userName===i.fromUserName})),r=document.querySelector(".messages-container"),s=r?r.scrollHeight:0;if(n.messages=a.concat(n.messages),n.oldestLoaded=n.messages[0].timestamp,t.length<n.pageSize&&(n.canLoadMore=!1),p(),r){let i=r.scrollHeight;r.scrollTop=i-s}}).finally(()=>{n.loadingMore=!1})}function Z(){let e=document.querySelector(".messages-container");if(!e||e.dataset.paginated)return;e.dataset.paginated="true";let t=0;e.addEventListener("scroll",()=>{if(e.scrollTop<30){let a=Date.now();a-t>400&&(t=a,X())}})}let ee=-1;function B(){let e=(o.messageInput&&o.messageInput.value||"").trim();if(!e)return;let t=Date.now();if(t-n.lastSendAt<n.minSendIntervalMs){I("You are sending messages too quickly");return}if(n.lastSendAt=t,e.startsWith("/private(")){let a=e.indexOf(")");if(a>9){let r=e.substring(9,a),s=e.substring(a+1).trim();d.invoke("SendPrivate",r,s).catch(()=>{})}}else if(n.joinedRoom){let a=ee--,r=new Date().toISOString(),s="c_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8);n.messages.push({id:a,content:e,timestamp:r,fromUserName:n.profile?.userName,fromFullName:n.profile?.fullName,avatar:n.profile?.avatar,isMine:!0,correlationId:s}),p(),j("/api/Messages",{room:n.joinedRoom.name,content:e,correlationId:s}).catch(()=>{n.messages=n.messages.filter(i=>i.id!==a),p(),I("Send failed")})}o.messageInput&&(o.messageInput.value="")}function te(){let e=document.getElementById("roomName").value.trim();e&&j("/api/Rooms",{name:e})}function ne(){if(!n.joinedRoom)return;let e=document.getElementById("newRoomName").value.trim();e&&H("/api/Rooms/"+n.joinedRoom.id,{id:n.joinedRoom.id,name:e})}function oe(){n.joinedRoom&&O("/api/Rooms/"+n.joinedRoom.id)}function k(){n.rooms=[],n.users=[],n.messages=[],n.profile=null,n.joinedRoom=null,b(),f(!1)}function q(){let e=setTimeout(()=>{y("warn","auth.timeout"),f(!1)},6e3);return fetch("/api/auth/me",{credentials:"include"}).then(t=>t.ok?t.json():null).then(t=>{clearTimeout(e),t&&t.userName?(n.profile={userName:t.userName,fullName:t.fullName,avatar:t.avatar},U()):f(!1),R()}).catch(()=>{clearTimeout(e),f(!1)})}function ae(){o.messageInput&&o.messageInput.addEventListener("keypress",s=>{s.key==="Enter"&&B()});let e=document.getElementById("btn-send-message");e&&e.addEventListener("click",s=>{s.preventDefault(),B()}),o.filterInput&&o.filterInput.addEventListener("input",()=>{n.filter=o.filterInput.value,h()});let t=document.getElementById("btn-create-room");t&&t.addEventListener("click",te);let a=document.getElementById("btn-rename-room");a&&a.addEventListener("click",ne);let r=document.getElementById("btn-delete-room");r&&r.addEventListener("click",oe),o.btnLogout&&o.btnLogout.addEventListener("click",()=>{fetch("/api/auth/logout",{method:"POST",credentials:"include"}).finally(()=>{k()})})}function I(e){if(!o.errorAlert)return;let t=o.errorAlert.querySelector("span");t&&(t.textContent=e),o.errorAlert.classList.remove("d-none"),setTimeout(()=>o.errorAlert.classList.add("d-none"),5e3)}window.chatApp=window.chatApp||{},window.chatApp.onAuthenticated=function(){f(!0),q()},window.chatApp.logoutCleanup=k,document.addEventListener("DOMContentLoaded",()=>{D(),f(!0),q(),ae()}),window.addEventListener("error",function(){n.loading&&f(!1)}),window.addEventListener("unhandledrejection",function(){n.loading&&f(!1)})})();})();
