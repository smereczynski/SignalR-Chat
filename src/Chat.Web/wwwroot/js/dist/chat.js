(()=>{window.__chatAppBooted?console.warn("chat.js: duplicate include detected, skipping second init"):window.__chatAppBooted=!0;(function(){let v=(e,t,o)=>window.appLogger&&window.appLogger[e]?window.appLogger[e](t,o):console.log(`[${e}] ${t}`,o||""),y={UNKNOWN:"UNKNOWN",PROBING:"PROBING",AUTHENTICATED:"AUTHENTICATED",UNAUTHENTICATED:"UNAUTHENTICATED"},n={loading:!0,profile:null,rooms:[],users:[],messages:[],joinedRoom:null,filter:"",oldestLoaded:null,canLoadMore:!0,pageSize:20,loadingMore:!1,lastSendAt:0,minSendIntervalMs:800,joinInProgress:!1,pendingJoin:null,outbox:[],pendingAck:{},authStatus:y.UNKNOWN,pendingMessages:{},isOffline:!1,unreadCount:0,unsentByRoom:{},ackTimers:{},autoScroll:!0,_firstRender:!0,_autoFillPass:0};n._hubStartedEarly=!1,n._graceStartedAt=null,n._graceEnded=!1;let a={},N={current:"disconnected",lastUpdate:0,isReconnecting:!1,reconnectSource:null};function X(){return!!(n.authGraceUntil&&Date.now()<n.authGraceUntil)}function qe(){a.app=document.querySelector(".app");let e=Array.from(document.querySelectorAll(".vh-100"));if(a.loaderWrapper=e.find(t=>t.querySelector(".spinner-border"))||document.querySelector(".d-flex.vh-100")||e[0],a.loaderWrapper===e[0]&&e.length>1){let t=e.find(o=>o!==e[0]);t&&(a.loaderWrapper=t)}a.roomsList=document.getElementById("rooms-list"),a.usersList=document.getElementById("users-list"),a.messagesList=document.getElementById("messages-list"),a.messageInput=document.getElementById("message-input"),a.joinedRoomTitle=document.getElementById("joinedRoom"),a.filterInput=document.querySelector(".users-container input[type=text]"),a.errorAlert=document.getElementById("errorAlert"),a.itemToDelete=document.getElementById("itemToDelete"),a.profileAvatarImg=document.getElementById("profileAvatarImg")||document.querySelector(".profile img.avatar"),a.profileAvatarInitial=document.getElementById("profileAvatarInitial")||document.querySelector(".profile span.avatar"),a.profileName=document.getElementById("profileName")||document.querySelector(".profile span:not(.avatar)"),a.btnLogin=document.getElementById("btn-login"),a.btnLogout=document.getElementById("btn-logout"),a.roomsNoSelection=document.querySelector('[data-role="no-room-selected"]'),a.roomsPanel=document.querySelector('[data-role="room-panel"]'),a.usersHeader=document.getElementById("users-header"),a.queueBadge=document.getElementById("queue-badge"),a.roomHeader=document.querySelector('.main-content[data-role="room-panel"] .header')}function L(e){n.loading=e,a.loaderWrapper&&a.loaderWrapper.classList.toggle("d-none",!e),a.app&&a.app.classList.toggle("d-none",e)}function M(e){if(a.roomHeader)switch(a.roomHeader.classList.remove("connection-state-connected","connection-state-reconnecting","connection-state-disconnected","connection-state-degraded"),!n._baseRoomTitle&&a.joinedRoomTitle&&(n._baseRoomTitle=a.joinedRoomTitle.textContent||""),e){case"connected":a.roomHeader.classList.add("connection-state-connected"),a.joinedRoomTitle&&n._baseRoomTitle&&(a.joinedRoomTitle.textContent=n._baseRoomTitle);break;case"reconnecting":a.roomHeader.classList.add("connection-state-reconnecting"),a.joinedRoomTitle&&n._baseRoomTitle&&(a.joinedRoomTitle.textContent=n._baseRoomTitle+" ("+(window.i18n.reconnecting||"RECONNECTING\u2026")+")");break;case"degraded":if(a.roomHeader.classList.add("connection-state-degraded"),a.joinedRoomTitle&&n._baseRoomTitle){let t="\u26A0\uFE0F";a.joinedRoomTitle.textContent=n._baseRoomTitle+" ("+t+" "+(window.i18n.degraded||"LIMITED")+")"}break;case"disconnected":if(a.roomHeader.classList.add("connection-state-disconnected"),a.joinedRoomTitle){let t=n._baseRoomTitle||a.joinedRoomTitle.textContent||"",o="\u26A0\uFE0F";a.joinedRoomTitle.textContent=t+" ("+o+" "+(window.i18n.disconnected||"DISCONNECTED")+")"}break}}function Z(){let e=Date.now()-N.lastUpdate;if(N.isReconnecting&&N.reconnectSource==="automatic"&&e<6e4)return"reconnecting";if(N.isReconnecting&&N.reconnectSource==="manual")return e<1e4?"reconnecting":"disconnected";if(!m)return"disconnected";let t=m.state&&m.state.toLowerCase?m.state.toLowerCase():"",o=t==="connected",s=Date.now()-I.lastCheck;return o&&s<3e4&&!I.isHealthy?"degraded":e<5e3?N.current:t==="connected"?"connected":(t==="connecting"||t==="reconnecting")&&e>=6e4?"disconnected":t==="connecting"||t==="reconnecting"?"reconnecting":"disconnected"}function De(){setInterval(()=>{M(Z())},2500)}let I={isHealthy:!0,lastCheck:0,redis:"Unknown",cosmos:"Unknown"};async function de(){if(!(!m||m.state!=="Connected"))try{let e=await m.invoke("GetHealthStatus");I.isHealthy=e.isHealthy||!1,I.redis=e.redis||"Unknown",I.cosmos=e.cosmos||"Unknown",I.lastCheck=Date.now(),console.debug("[Health]",e.isHealthy?"\u2713 Healthy":"\u2717 Unhealthy",`Redis: ${e.redis}, Cosmos: ${e.cosmos}`)}catch(e){console.warn("[Health] Check failed:",e),I.isHealthy=!1,I.redis="Error",I.cosmos="Error",I.lastCheck=Date.now()}}async function ue(){if(!(!m||m.state!=="Connected"))try{let e=await m.invoke("Heartbeat");e.acknowledged&&e.health&&(I.isHealthy=e.health.isHealthy||!1,I.redis=e.health.redis||"Unknown",I.cosmos=e.health.cosmos||"Unknown",I.lastCheck=Date.now(),console.debug("[Heartbeat] Acknowledged",e.timestamp))}catch(e){console.warn("[Heartbeat] Failed:",e)}}function Fe(){setInterval(async()=>{await de()},15e3),setInterval(async()=>{await ue()},3e4),setTimeout(async()=>{await de(),await ue()},2e3)}function G(e,t){let o=e&&typeof e=="string"&&e.trim().length>0?e:t||"";return o&&o.trim().charAt(0).toUpperCase()||"?"}function q(){a.roomsList&&(a.roomsList.innerHTML="",n.rooms.forEach(e=>{let t=document.createElement("li"),o=document.createElement("a");o.href="#",o.textContent=e.name,o.dataset.roomId=e.id,n.pendingJoin===e.name&&(!n.joinedRoom||n.joinedRoom.name!==e.name)&&o.classList.add("joining"),n.joinedRoom&&n.joinedRoom.name===e.name&&o.classList.add("active"),o.addEventListener("click",s=>{s.preventDefault(),O(e.name)}),t.appendChild(o),a.roomsList.appendChild(t)}))}function U(){if(!a.usersList)return;let e=n.filter.toLowerCase();a.usersList.innerHTML="";let t=n.users.filter(o=>!e||(o.fullName||o.userName||"").toLowerCase().includes(e));if(t.forEach(o=>{let s=document.createElement("li");s.dataset.username=o.userName;let i=document.createElement("div");if(i.className="user",o.avatar){let l=document.createElement("img");l.className="avatar me-2",l.src="/avatars/"+o.avatar,i.appendChild(l)}else{let l=document.createElement("span");l.className="avatar me-2 text-uppercase",l.textContent=G(o.fullName,o.userName),i.appendChild(l)}let r=document.createElement("div");r.className="user-info";let d=document.createElement("span");d.className="name",d.textContent=o.fullName||o.userName,r.appendChild(d);let c=document.createElement("span");c.className="device",c.textContent=o.device||"",r.appendChild(c),i.appendChild(r),s.appendChild(i),a.usersList.appendChild(s)}),a.usersHeader&&window.i18n?.whosHere){let o=window.i18n.whosHere;a.usersHeader.textContent=o.replace("{0}",t.length)}}function fe(e){let t=new Date(e),s=Math.round((t-new Date)/(1e3*3600*24)),i=t.getDate(),r=t.getMonth()+1,d=t.getFullYear(),l=!(document.documentElement.lang||"en").startsWith("en"),g=t.getHours(),p=("0"+t.getMinutes()).slice(-2),f="",b;l?b=("0"+g).slice(-2):(f=g>=12?window.i18n.PM||"PM":window.i18n.AM||"AM",g>12&&(g=g%12),g===0&&(g=12),b=g);let j=`${i}/${r}/${d}`,H=l?`${b}:${p}`:`${b}:${p} ${f}`,T=`${j} ${H}`,A=j,E=window.i18n.Today||"Today",x=window.i18n.Yesterday||"Yesterday";return s===0?A=`${E}, ${H}`:s===-1&&(A=`${x}, ${H}`),{relative:A,full:T}}function w(){a.messagesList&&(a.messagesList.innerHTML="",n.messages.forEach(e=>z(e,!1)),S())}function wt(){return((document.documentElement.lang||"en").toLowerCase().split("-")[0]||"en").trim()||"en"}function ee(e){return e&&(e.translationStatus||e.TranslationStatus)||"None"}function te(e){let t=e&&(e.translations||e.Translations);return t&&typeof t=="object"?t:{}}function me(e,t){if(e==null)return null;let o=String(e).trim();if(!o)return null;let s=o.toLowerCase();if(t&&s==="auto")return"auto";if(s==="auto")return null;let i=o.replace(/_/g,"-"),r=i.indexOf("-");return(r>0?i.slice(0,r):i).trim().toLowerCase()||null}function Oe(e,t){let o=new Set;o.add("en"),Array.isArray(e)&&e.forEach(i=>{let r=me(i,!1);r&&o.add(r)}),o.delete("auto");let s=me(t,!0);return s&&s!=="auto"&&(o.delete(s),o.add("en")),Array.from(o)}function $e(e){let t=(ee(e)||"").toLowerCase(),o=te(e);return o&&Object.keys(o).length>0||t==="pending"||t==="inprogress"||t==="failed"}function Ge(e){let t=te(e),o=Object.keys(t||{}),s=(ee(e)||"").toLowerCase();if(o.length&&s!=="pending"&&s!=="inprogress")return o;let i=n.joinedRoom&&Array.isArray(n.joinedRoom.languages)?n.joinedRoom.languages:null,r=e&&(e.sourceLanguage||e.SourceLanguage);return i&&i.length?Oe(i,r).map(d=>String(d||"").toLowerCase()).filter(Boolean):o}function ze(e){let t=String(e||"").toLowerCase();return{en:"text-bg-primary",pl:"text-bg-success",de:"text-bg-warning",fr:"text-bg-info",es:"text-bg-danger",it:"text-bg-dark",pt:"text-bg-secondary",ja:"text-bg-primary",zh:"text-bg-success"}[t]||"text-bg-secondary"}function ge(e,t){if(!e)return;let o=e.querySelector(".translation-panel");if(o&&o.remove(),!$e(t))return;let i=(ee(t)||"").toLowerCase(),r=te(t),d=t&&(t.translationFailureMessage||t.translationErrorMessage||t.translationError||""),c=document.createElement("div");c.className="translation-panel mt-2 pt-2 border-top";let l=document.createElement("div");l.className="d-flex align-items-center justify-content-between mb-2";let g=document.createElement("div");g.className="small fw-semibold",g.textContent=window.i18n?.translations||"Translations",l.appendChild(g);let p=t&&(t.id??t.Id),f=typeof p=="number"?p:typeof p=="string"&&p.trim()!==""?Number(p):NaN;if(Number.isFinite(f)){let T=document.createElement("button");T.type="button",T.className="btn btn-link p-0 small text-decoration-none",T.setAttribute("aria-label",window.i18n?.retryTranslation||"Retry translation"),T.innerHTML='<span aria-hidden="true">\u21BB</span>',T.addEventListener("click",async A=>{A.preventDefault();try{t.translationStatus="Pending",typeof C=="function"&&C(t)||(w(),S());let E=await fetch(`/api/Messages/${f}/retry-translation`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"}});if(!E.ok){let x="";try{x=(await E.json())?.error||""}catch{}t.translationStatus="Failed",t.translationErrorMessage=x||window.i18n?.translationRetryFailed||"Retry failed.",C(t)||(w(),S())}}catch{t.translationStatus="Failed",t.translationErrorMessage=window.i18n?.translationRetryFailed||"Retry failed.",C(t)||(w(),S())}}),l.appendChild(T)}c.appendChild(l);let b=document.createElement("div");b.className="d-flex flex-column gap-2",Ge(t).forEach(T=>{let A=r&&(r[T]||r[String(T).toLowerCase()]||r[String(T).toUpperCase()]),E=document.createElement("div");E.className=`${ze(T)} rounded p-2`;let x=document.createElement("div");x.className="d-flex align-items-center justify-content-between mb-1";let ce=document.createElement("span");if(ce.className="small fw-semibold",ce.textContent=String(T||"").toUpperCase(),x.appendChild(ce),!A&&(i==="pending"||i==="inprogress")){let Q=document.createElement("span");Q.className="spinner-border spinner-border-sm",Q.setAttribute("role","status"),Q.setAttribute("aria-label","Translating"),x.appendChild(Q)}let P=document.createElement("div");P.className="small",A?P.textContent=A:i==="failed"?(P.classList.add("fw-semibold"),P.textContent=d||window.i18n?.translationFailed||"Translation failed."):P.textContent=window.i18n?.translationPending||"\u2026",E.appendChild(x),E.appendChild(P),b.appendChild(E)}),c.appendChild(b);let H=e.querySelector(".read-receipt");H?H.before(c):e.appendChild(c)}function z(e,t){if(!a.messagesList)return;let o=document.createElement("li");o.dataset.cid=e.correlationId||"",typeof e.id=="number"&&(o.dataset.id=String(e.id)),e.failed&&o.classList.add("failed");let s=document.createElement("div");if(s.className="message-item",e.isMine&&s.classList.add("ismine"),e.avatar){let f=document.createElement("img");f.className="avatar avatar-lg mx-2",f.src="/avatars/"+e.avatar,s.appendChild(f)}else{let f=document.createElement("span");f.className="avatar avatar-lg mx-2 text-uppercase",f.textContent=G(e.fromFullName,e.fromUserName),s.appendChild(f)}let i=document.createElement("div");i.className="message-content";let r=document.createElement("div");r.className="message-info d-flex flex-wrap align-items-center";let d=document.createElement("span");d.className="author",d.textContent=e.fromFullName||e.fromUserName,r.appendChild(d);let c=document.createElement("span");c.className="timestamp";let l=fe(e.timestamp);if(c.textContent=l.relative,c.dataset.bsTitle=l.full,c.setAttribute("data-bs-toggle","tooltip"),r.appendChild(c),e.failed){let f=document.createElement("span");f.className="send-status ms-2 text-danger",f.textContent=window.i18n.MessageFailed||"(failed)",r.appendChild(f);let b=document.createElement("button");b.type="button",b.className="btn btn-link p-0 ms-2 retry-send",b.textContent=window.i18n.Retry||"Retry",b.addEventListener("click",()=>Ee(e.correlationId)),r.appendChild(b)}else if(e.pending){let f=document.createElement("span");f.className="send-status ms-2 text-muted",f.textContent=window.i18n.MessagePending||"\u2026",r.appendChild(f)}i.appendChild(r);let g=document.createElement("div");g.className="content",g.textContent=e.content,i.appendChild(g),ge(i,e);let p=document.createElement("div");if(p.className="read-receipt small text-muted",pe(p,e),i.appendChild(p),s.appendChild(i),o.appendChild(s),a.messagesList.appendChild(o),t){let f=document.querySelector(".messages-container");f&&(n.autoScroll||n._firstRender)&&(f.scrollTop=f.scrollHeight)}return o}function C(e){if(!a.messagesList||!e.correlationId)return!1;let t=a.messagesList.querySelector('li[data-cid="'+e.correlationId+'"]');if(!t)return!1;typeof e.id=="number"&&(t.dataset.id=String(e.id));let o=t.querySelector(".timestamp");if(o){let l=fe(e.timestamp);o.textContent=l.relative,o.dataset.bsTitle=l.full}let s=t.querySelector(".content");s&&(s.textContent=e.content),t.classList.toggle("failed",!!e.failed);let i=t.querySelector(".send-status");if(!i&&(e.failed||e.pending)){let l=t.querySelector(".message-info");l&&(i=document.createElement("span"),i.className="send-status ms-2",l.appendChild(i))}i&&(e.failed?(i.textContent=window.i18n.MessageFailed||"(failed)",i.className="send-status ms-2 text-danger"):e.pending?(i.textContent=window.i18n.MessagePending||"\u2026",i.className="send-status ms-2 text-muted"):i.remove());let r=t.querySelector("button.retry-send");if(e.failed){if(!r){let l=t.querySelector(".message-info");l&&(r=document.createElement("button"),r.type="button",r.className="btn btn-link p-0 ms-2 retry-send",r.textContent=window.i18n.Retry||"Retry",r.addEventListener("click",()=>Ee(e.correlationId)),l.appendChild(r))}}else r&&r.remove();t.dataset.cid=e.correlationId||"";let d=t.querySelector(".read-receipt");if(!d){d=document.createElement("div"),d.className="read-receipt small text-muted";let l=t.querySelector(".message-content");l&&l.appendChild(d)}pe(d,e);let c=t.querySelector(".message-content");return ge(c,e),!0}function pe(e,t){if(!e)return;let o=Array.isArray(t.readBy)?t.readBy:[];if(!!!t.isMine){e.textContent="",e.classList.add("d-none");return}e.classList.remove("d-none");let i=(n.profile&&n.profile.userName||"").toLowerCase(),r=o.filter(d=>d&&d.toLowerCase()!==i);if(r.length===0){e.textContent=window.i18n?.delivered||"Delivered";return}e.textContent=(window.i18n?.readBy||"Read by")+" "+r.join(", ")}function S(){let e=document.querySelector(".no-messages-info");e&&e.classList.toggle("d-none",n.messages.length>0);let t=document.querySelector(".messages-container");t&&!n.loadingMore&&(n.autoScroll||n._firstRender)&&(t.scrollTop=t.scrollHeight),n._firstRender=!1,window.bootstrap&&[].slice.call(a.messagesList.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(s=>{try{new window.bootstrap.Tooltip(s)}catch{}}),Je(),B()}function Je(){try{let e=document.querySelector(".messages-container");if(!e||n.loadingMore||!n.canLoadMore||!n.joinedRoom||!n.oldestLoaded)return;!(e.scrollHeight>e.clientHeight+4)&&n._autoFillPass<3&&(n._autoFillPass++,setTimeout(()=>Le(),0))}catch{}}function k(){let e=n.profile;a.profileName&&(e?(a.profileName.textContent=e.fullName||e.userName,e.avatar?(a.profileAvatarImg&&(a.profileAvatarImg.src="/avatars/"+e.avatar,a.profileAvatarImg.classList.remove("d-none")),a.profileAvatarInitial&&a.profileAvatarInitial.classList.add("d-none")):(a.profileAvatarInitial&&(a.profileAvatarInitial.textContent=G(e.fullName,e.userName),a.profileAvatarInitial.classList.remove("d-none")),a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none")),a.btnLogin&&a.btnLogin.classList.add("d-none"),a.btnLogout&&a.btnLogout.classList.remove("d-none")):(a.profileName.textContent="Not signed in",a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none"),a.profileAvatarInitial&&(a.profileAvatarInitial.classList.remove("d-none"),a.profileAvatarInitial.textContent="?"),a.btnLogin&&a.btnLogin.classList.remove("d-none"),a.btnLogout&&a.btnLogout.classList.add("d-none")))}let he=k;k=function(){if(!a.profileName){he();return}if(!n.profile){let e=X();if(n.authStatus===y.PROBING||e){a.profileName.textContent="Signing in\u2026",a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none"),a.profileAvatarInitial&&(a.profileAvatarInitial.classList.remove("d-none"),a.profileAvatarInitial.textContent="?"),a.btnLogin&&a.btnLogin.classList.add("d-none"),a.btnLogout&&a.btnLogout.classList.add("d-none");return}}he()};function We(){if(!(!n.profile||n.profile.avatar)&&a.profileAvatarInitial){let e=G(n.profile.fullName,n.profile.userName);a.profileAvatarInitial.textContent=e,a.profileAvatarInitial.classList.remove("d-none"),a.profileAvatarImg&&a.profileAvatarImg.classList.add("d-none")}}function ye(){if(!a.roomsPanel||!a.roomsNoSelection)return;let e=!!n.joinedRoom;a.roomsPanel.classList.toggle("d-none",!e),a.roomsNoSelection.classList.toggle("d-none",e),n.joinedRoom&&a.joinedRoomTitle&&(a.joinedRoomTitle.textContent=n.joinedRoom.name),q()}function we(){k(),ye(),U(),w()}function ne(){if(!a.queueBadge)return;let e=n.outbox.length;a.queueBadge.textContent=e,a.queueBadge.classList.toggle("d-none",e===0)}function oe(e,t){if(!t||n.messages.find(r=>r.correlationId===t))return;let s=new Date().toISOString(),i={id:Ie--,content:e,timestamp:s,fromUserName:n.profile?.userName,fromFullName:n.profile?.fullName,avatar:n.profile?.avatar,isMine:!!n.profile,correlationId:t,pending:!0};n.messages.push(i),a.messagesList&&n.messages.length>1?(z(i,!0),S()):w()}function be(e,t){try{if(!e||!Array.isArray(n.messages)||!n.messages.length)return;let o=n.messages.filter(s=>s&&s.isMine&&(s.pending||s.failed));if(!o.length)return;n.unsentByRoom=n.unsentByRoom||{},n.unsentByRoom[e]=o.map(s=>({content:s.content,timestamp:s.timestamp,fromUserName:s.fromUserName,fromFullName:s.fromFullName,avatar:s.avatar,isMine:!0,correlationId:s.correlationId||null,pending:!!s.pending,failed:!!s.failed,id:s.id})),u("unsent.snapshot",{room:e,count:o.length,reason:t})}catch{}}function Ve(e){try{if(!e||!n.unsentByRoom||!n.unsentByRoom[e])return;let t=n.unsentByRoom[e];delete n.unsentByRoom[e];let o=new Set(n.messages.map(r=>r.correlationId).filter(Boolean)),s=new Set(n.messages.map(r=>r.isMine?r.content+"|"+r.timestamp:null).filter(Boolean)),i=[];for(let r of t)r.correlationId&&o.has(r.correlationId)||s.has(r.content+"|"+r.timestamp)||i.push(r);if(!i.length)return;i.forEach(r=>{r.pending&&!r.failed&&(r.pending=!0)}),n.messages=n.messages.concat(i),u("unsent.restore",{room:e,count:i.length})}catch{}}let se=e=>fetch(e,{credentials:"include"}).then(t=>t.ok?t.json():Promise.reject(t)),bt=(e,t)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),Nt=(e,t)=>fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),St=e=>fetch(e,{method:"DELETE",credentials:"include"}),m=null,J=0,Ke=3e4,Ye={nextRetryDelayInMilliseconds(e){let t=e&&typeof e.previousRetryCount=="number"?e.previousRetryCount+1:1,o=[0,2e3,5e3,1e4],s=t<=o.length?o[t-1]:3e4;return Math.min(s,3e4)}};function Qe(e){let t=new Uint8Array(e);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(t);else for(let o=0;o<e;o++)t[o]=Math.floor(Math.random()*256);return t}function D(e,t){let o=Qe(t),s="";for(let i of o)s+=(i&15).toString(16);return(e||"")+s+"_"+Date.now().toString(36)}let Xe=D("s_8",8),F={},Ne=4e3;function u(e,t){try{let o=Date.now(),s;if(/^send\.flush\.skip$/.test(e)&&(s=e+"|"+(t&&t.reason)),/^send\.queue$/.test(e)&&(s=e+"|"+(t&&t.reason)),/^hub\.connect\.retry$/.test(e)&&(s=e+"|"+(t&&t.attempt)),s){let i=F[s];if(i&&o-i<Ne)return;F[s]=o}fetch("/api/telemetry/reconnect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({evt:e,ts:o,sessionId:Xe,...t})})}catch{}}setInterval(()=>{try{let e=Date.now(),t=Ne*3;for(let o in F)e-F[o]>t&&delete F[o]}catch{}},12e4);function Ze(e){if(!e)return{cat:"unknown",msg:""};let t=e&&(e.message||e.toString())||"";return/403|401|unauthor/i.test(t)?{cat:"auth",msg:t}:/timeout|timed out/i.test(t)?{cat:"timeout",msg:t}:/network|fetch|socket|ws|transport/i.test(t)?{cat:"transport",msg:t}:/server|500|hubexception/i.test(t)?{cat:"server",msg:t}:{cat:"other",msg:t}}let ae=null;function Se(){if(m)return m;m=new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect(Ye).build();try{m.serverTimeoutInMilliseconds=12*60*60*1e3,m.keepAliveIntervalInMilliseconds=2e4}catch{}return et(m),m}function W(){Se();let e=m.state&&m.state.toLowerCase?m.state.toLowerCase():"";if(e&&e!=="disconnected")return(e==="connecting"||e==="reconnecting")&&(N.isReconnecting||(N={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:e==="reconnecting"?"automatic":"manual"},M("reconnecting"))),v("warn","signalr.start.skip",{state:e}),u("hub.connect.skip",{state:e}),Promise.resolve();v("info","signalr.start"),N={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:"manual"},M("reconnecting");let t=performance.now();return n.authStatus===y.PROBING&&!n.profile&&(n._hubStartedEarly||(u("auth.hub.start.early",{}),n._hubStartedEarly=!0)),m.start().then(()=>{J=0,ae=null,N={current:"connected",lastUpdate:Date.now(),isReconnecting:!1,reconnectSource:null},!n.profile&&(n.authStatus===y.PROBING||n.authStatus===y.UNKNOWN)&&fetch("/api/auth/me",{credentials:"include"}).then(o=>o.ok?o.json():null).then(o=>{o&&o.userName&&(n.profile={userName:o.userName,fullName:o.fullName,avatar:o.avatar},n.authStatus=y.AUTHENTICATED,k(),u("auth.reprobe.success",{}))}).catch(()=>{}),ve(),u("hub.connected",{durationMs:Math.round(performance.now()-t)}),M("connected"),n.profile&&n.loading&&L(!1)}).catch(o=>{let s=o&&o.message||"";if(/not in the 'disconnected' state/i.test(s)||/cannot start a hubconnection that is not in the 'disconnected' state/i.test(s)){v("warn","signalr.start.duplicate",{message:s}),u("hub.connect.duplicateStart",{message:s});return}v("error","signalr.start.fail",{error:s}),u("hub.connect.fail",{message:s}),_(o)})}function V(){Se(),(m.state&&m.state.toLowerCase?m.state.toLowerCase():"")==="disconnected"&&W()}function _(e){e&&(ae=e),J++,N={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:"manual"};let t=Math.min(1e3*Math.pow(2,J),Ke);M("reconnecting");let{cat:o,msg:s}=Ze(ae);u("hub.connect.retry",{attempt:J,delayMs:t,errorCategory:o,errorMessage:s.slice(0,300)}),setTimeout(()=>W().catch(i=>_(i)),t)}function et(e){e.on("getProfileInfo",t=>{n.profile={userName:t.userName,fullName:t.fullName,avatar:t.avatar},n.authStatus=y.AUTHENTICATED,L(!1),k(),h("profile")}),e.on("presenceSnapshot",t=>{if(!Array.isArray(t))return;let o=t.map(s=>({userName:s.userName||s.UserName||s.username||"",fullName:s.fullName||s.FullName||s.name||"",avatar:s.avatar||s.Avatar||"",currentRoom:s.currentRoom||s.CurrentRoom||s.room||null,...s}));n.joinedRoom?n.users=o.filter(s=>s.currentRoom===n.joinedRoom.name):n.users=o,U()}),e.on("newMessage",t=>{if(n.profile&&n.profile.userName&&t.correlationId){let s=n.messages.findIndex(i=>i.isMine&&i.correlationId===t.correlationId);if(s>=0){n.messages[s]={id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:!0,correlationId:t.correlationId,readBy:t.readBy||[],translationStatus:t.translationStatus||t.TranslationStatus||"None",sourceLanguage:t.sourceLanguage||t.SourceLanguage||"auto",translations:t.translations||t.Translations||{},translationErrorMessage:""},n.pendingMessages[t.correlationId]&&delete n.pendingMessages[t.correlationId];for(let i=n.messages.length-1;i>=0;i--)i!==s&&n.messages[i]&&n.messages[i].id===t.id&&n.messages.splice(i,1);w(),S();return}}if(t&&t.id!==void 0){let s=n.messages.findIndex(i=>i&&i.id===t.id);if(s>=0){let i=!!(n.profile&&n.profile.userName===t.fromUserName);n.messages[s]={id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:i,correlationId:t.correlationId||n.messages[s].correlationId,readBy:t.readBy||n.messages[s].readBy||[],translationStatus:t.translationStatus||t.TranslationStatus||n.messages[s].translationStatus||"None",sourceLanguage:t.sourceLanguage||t.SourceLanguage||n.messages[s].sourceLanguage||"auto",translations:t.translations||t.Translations||n.messages[s].translations||{},translationErrorMessage:n.messages[s].translationErrorMessage||""},w(),S();return}}ot({...t,correlationId:t.correlationId});try{!!(n.profile&&n.profile.userName===t.fromUserName)||(He()?B():(n.unreadCount=(n.unreadCount||0)+1,_e(t.room||n.joinedRoom&&n.joinedRoom.name||""),Ue()))}catch{}}),e.on("notify",t=>st(t)),e.on("messageRead",t=>{try{let o=t&&(t.id||t.Id),s=t&&(t.readers||t.Readers)||[],i=n.messages.findIndex(r=>r&&r.id===o);if(i>=0){let r=n.messages[i];r.readBy=s,C(r)||w()}}catch{}}),e.on("translationCompleted",t=>{try{let o=t&&(t.messageId||t.MessageId),s=t&&(t.translations||t.Translations)||{},i=n.messages.findIndex(r=>r&&r.id===o);if(i>=0){let r=n.messages[i];r.translationStatus="Completed",r.translations=s,r.translationErrorMessage="",C(r)||w(),S()}}catch{}}),e.on("translationFailed",t=>{try{let o=t&&(t.messageId||t.MessageId),s=t&&(t.message||t.error||t.Message)||"",i=n.messages.findIndex(r=>r&&r.id===o);if(i>=0){let r=n.messages[i];r.translationStatus="Failed",r.translationErrorMessage=s,r.translations=r.translations||{},C(r)||w(),S()}}catch{}}),e.on("translationRetrying",t=>{try{let o=t&&(t.messageId||t.MessageId),s=n.messages.findIndex(i=>i&&i.id===o);if(s>=0){let i=n.messages[s];i.translationStatus="Pending",i.translationErrorMessage="",i.translations=i.translations||{},C(i)||w(),S()}}catch{}}),e.onreconnected(t=>{N={current:"connected",lastUpdate:Date.now(),isReconnecting:!1,reconnectSource:null};try{n.joinedRoom?(be(n.joinedRoom.name,"reconnected"),O(n.joinedRoom.name,!0)):ve()}catch{}M("connected")}),e.onreconnecting(t=>{(!N.isReconnecting||N.reconnectSource!=="automatic")&&(N={current:"reconnecting",lastUpdate:Date.now(),isReconnecting:!0,reconnectSource:"automatic"}),v("warn","hub.reconnecting",{message:t&&t.message}),M("reconnecting")}),e.onclose(t=>{v("warn","hub.onclose",{message:t&&t.message}),N.isReconnecting||(N={current:"disconnected",lastUpdate:Date.now(),isReconnecting:!1,reconnectSource:null},t&&(v("warn","hub.onclose.error.triggering.reconnect",{msg:(t.message||"").slice(0,120)}),_(t))),M(N.current),n.users=[],U()}),e.on("addUser",t=>tt(t)),e.on("removeUser",t=>nt(t.userName)),e.on("addChatRoom",t=>Re(t)),e.on("updateChatRoom",t=>Re(t)),e.on("removeChatRoom",t=>{n.rooms=n.rooms.filter(o=>o.id!==t),n.joinedRoom&&n.joinedRoom.id===t&&(n.joinedRoom=null,n.messages=[]),we()}),e.on("onError",t=>Y(t))}function Re(e){let t={id:e.id!==void 0?e.id:e.Id,name:e.name!==void 0?e.name:e.Name,admin:e.admin!==void 0?e.admin:e.Admin,languages:e.languages!==void 0?e.languages:e.Languages},o=n.rooms.find(s=>s.id===t.id);o?(o.name=t.name,o.admin=t.admin,t.languages!==void 0&&(o.languages=t.languages)):n.rooms.push(t),q()}function tt(e){let t={userName:e.userName||e.UserName||e.username||"",fullName:e.fullName||e.FullName||e.name||"",avatar:e.avatar||e.Avatar||"",currentRoom:e.currentRoom||e.CurrentRoom||e.room||null,...e},o=n.users.find(s=>s.userName===t.userName);o?Object.assign(o,t):n.users.push(t),U()}function nt(e){n.users=n.users.filter(t=>t.userName!==e),U()}function ot(e){let t=n.profile&&n.profile.userName===e.fromUserName,o=-1;e&&e.correlationId&&(o=n.messages.findIndex(i=>i&&i.correlationId===e.correlationId)),o<0&&e&&e.id!==void 0&&(o=n.messages.findIndex(i=>i&&i.id===e.id));let s={id:e.id,content:e.content,timestamp:e.timestamp,fromUserName:e.fromUserName,fromFullName:e.fromFullName,avatar:e.avatar,isMine:t,correlationId:e.correlationId,readBy:e.readBy||[],translationStatus:e.translationStatus||e.TranslationStatus||"None",sourceLanguage:e.sourceLanguage||e.SourceLanguage||"auto",translations:e.translations||e.Translations||{},translationErrorMessage:e.translationErrorMessage||e.translationFailureMessage||e.translationError||""};o>=0?(n.messages[o]=s,w()):(n.messages.push(s),a.messagesList&&n.messages.length>1?(z(s,!0),S()):w())}function st(e){let t=e.ts||new Date().toISOString(),o=`[NOTIFY] ${e.title}${e.body?": "+e.body:""}`;n.messages.push({id:"notify_"+t,content:o,timestamp:t,fromUserName:e.from||"system",fromFullName:e.from||"system",avatar:null,isMine:!1}),w()}function O(e,t){if(!m||!e||n.joinInProgress&&n.pendingJoin===e||!t&&n.joinedRoom&&n.joinedRoom.name===e&&!n.joinInProgress)return;t&&n.joinedRoom&&n.joinedRoom.name===e&&be(e,"forceJoin");let o=D("j_",8);n._joinToken=o,n.joinInProgress=!0,n.pendingJoin=e,q();let s=performance.now(),i=3,r=0;function d(){r++,m.invoke("Join",e).then(()=>{n._joinToken!==o||n.pendingJoin!==e||(n.joinedRoom=n.rooms.find(c=>c.name===e)||{name:e},n.pendingJoin=null,n.joinInProgress=!1,localStorage.setItem("lastRoom",e),a.joinedRoomTitle&&(n._baseRoomTitle=n.joinedRoom.name,a.joinedRoomTitle.textContent=n._baseRoomTitle),at(),it(),ye(),We(),u("room.join.success",{room:e,durationMs:Math.round(performance.now()-s),attempts:r}),h("join"))}).catch(c=>{if(n._joinToken!==o)return;let l=c&&c.message||"";if(/timeout|temporar|network|reconnect|connection/i.test(l)&&r<i){let p=300*r;u("room.join.retry",{room:e,attempt:r,backoff:p,msg:l.slice(0,120)}),setTimeout(d,p)}else n.pendingJoin===e&&(n.joinInProgress=!1,n.pendingJoin=null),q(),u("room.join.fail",{room:e,attempts:r,msg:l.slice(0,200)}),Y("Join failed: "+l),v("warn","room.join.failed.triggering.reconnect",{room:e,msg:l.slice(0,120)}),_(c)})}d()}function ve(){se("/api/Rooms").then(e=>{n.rooms=(e||[]).map(o=>({id:o.id!==void 0?o.id:o.Id,name:o.name!==void 0?o.name:o.Name,admin:o.admin!==void 0?o.admin:o.Admin,languages:o.languages!==void 0?o.languages:o.Languages})),q();let t=localStorage.getItem("lastRoom");t&&n.rooms.some(o=>o.name===t)?O(t):n.rooms.length>0&&O(n.rooms[0].name)}).catch(()=>{})}function at(){n.joinedRoom&&m.invoke("GetUsers",n.joinedRoom.name).then(e=>{let t=(e||[]).map(o=>({userName:o.userName||o.UserName||o.username||"",fullName:o.fullName||o.FullName||o.name||"",avatar:o.avatar||o.Avatar||"",currentRoom:o.currentRoom||o.CurrentRoom||o.room||null,...o}));n.users=t,U()}).catch(e=>{v("warn","loadUsers.failed",{msg:e&&e.message}),setTimeout(()=>_(e),1e3)})}function it(){n.joinedRoom&&(n.oldestLoaded=null,n.canLoadMore=!0,n._autoFillPass=0,se("/api/Messages/Room/"+encodeURIComponent(n.joinedRoom.name)+"?take="+n.pageSize).then(e=>{n.messages=e.map(t=>({id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:n.profile&&n.profile.userName===t.fromUserName,readBy:t.readBy||[],translationStatus:t.translationStatus||t.TranslationStatus||"None",sourceLanguage:t.sourceLanguage||t.SourceLanguage||"auto",translations:t.translations||t.Translations||{},translationErrorMessage:t.translationErrorMessage||t.translationFailureMessage||t.translationError||""})),Ve(n.joinedRoom.name),n.messages.length>0?(n.oldestLoaded=n.messages[0].timestamp,e.length<n.pageSize&&(n.canLoadMore=!1)):n.canLoadMore=!1,w(),rt()}).catch(()=>{}))}let ie=0;function Le(){if(!n.canLoadMore||n.loadingMore||!n.joinedRoom||!n.oldestLoaded)return;n.loadingMore=!0;let e=++ie,t=n.oldestLoaded,o=encodeURIComponent(t);u("messages.page.req",{before:t,token:e}),se("/api/Messages/Room/"+encodeURIComponent(n.joinedRoom.name)+"?before="+o+"&take="+n.pageSize).then(s=>{if(e!==ie){u("messages.page.stale",{token:e});return}if(!Array.isArray(s)||s.length===0){n.canLoadMore=!1,u("messages.page.empty",{token:e});return}let i=s.map(l=>({id:l.id,content:l.content,timestamp:l.timestamp,fromUserName:l.fromUserName,fromFullName:l.fromFullName,avatar:l.avatar,isMine:n.profile&&n.profile.userName===l.fromUserName,readBy:l.readBy||[],translationStatus:l.translationStatus||l.TranslationStatus||"None",sourceLanguage:l.sourceLanguage||l.SourceLanguage||"auto",translations:l.translations||l.Translations||{},translationErrorMessage:l.translationErrorMessage||l.translationFailureMessage||l.translationError||""})),r=document.querySelector(".messages-container"),d=r?r.scrollHeight:0,c=n.oldestLoaded;if(n.messages=i.concat(n.messages),n.oldestLoaded=n.messages[0].timestamp,c&&n.oldestLoaded>c&&(u("messages.page.nonmonotonic",{prev:c,now:n.oldestLoaded}),n.oldestLoaded=c),s.length<n.pageSize&&(n.canLoadMore=!1),w(),r){let l=r.scrollHeight;r.scrollTop=l-d}u("messages.page.ok",{token:e,added:s.length,remaining:n.canLoadMore?1:0})}).catch(s=>{u("messages.page.err",{token:e,msg:s&&s.message||""})}).finally(()=>{e===ie&&(n.loadingMore=!1)})}function rt(){let e=document.querySelector(".messages-container");if(!e||e.dataset.paginated)return;e.dataset.paginated="true";let t=0;e.addEventListener("scroll",()=>{if(n.autoScroll=Be(),e.scrollTop<40){let o=Date.now();o-t>500&&(t=o,!n.loadingMore&&n.canLoadMore&&n.joinedRoom&&n.oldestLoaded&&Le())}le(),B()})}let Ie=-1;function K(e,t,o,s){let i=Date.now();if(!t&&i-n.lastSendAt<n.minSendIntervalMs)return Y("You are sending messages too quickly"),Promise.reject("rateLimited");!o&&!s&&(n.lastSendAt=i);let r=s||D("c_",12),d;if(s){let g=n.messages.find(p=>p.correlationId===s);g&&(d=g.id)}else{d=Ie--;let g=new Date().toISOString(),p={id:d,content:e,timestamp:g,fromUserName:n.profile?.userName,fromFullName:n.profile?.fullName,avatar:n.profile?.avatar,isMine:!!n.profile,correlationId:r,pending:!0};n.messages.push(p),a.messagesList&&n.messages.length>1?(z(p,!0),S()):w()}if(!m)return Promise.reject("noHub");let c=n.pendingMessages[r]||{attempts:0,createdAt:Date.now(),text:e,tempId:d};c.attempts++,n.pendingMessages[r]=c,u("send.attempt",{cid:r,len:e.length,fromFlush:!!o,attempts:c.attempts,resend:!!s});let l=m.invoke("SendMessage",e,r).then(()=>{u("send.invoke.ok",{cid:r}),lt(r)}).catch(g=>{let p=g&&g.message||"",f=n.messages.find(b=>b.correlationId===r);throw f&&(f.failed=!0,f.pending=!1),delete n.pendingMessages[r],Te(r),u("send.invoke.fail",{cid:r,msg:p}),f&&(C(f)?S():w()),v("warn","sendMessage.failed.triggering.reconnect",{msg:p.slice(0,120)}),setTimeout(()=>_(g),500),g});return Ce(r),l}function Te(e){let t=n.ackTimers&&n.ackTimers[e];if(t){try{clearTimeout(t)}catch{}delete n.ackTimers[e]}}function Ce(e){n.ackTimers||(n.ackTimers={}),!n.ackTimers[e]&&(n.ackTimers[e]=setTimeout(()=>{delete n.ackTimers[e];let o=n.pendingMessages[e];if(o){if(o.attempts>=3){u("send.timeout.giveup",{cid:e,attempts:o.attempts}),u("send.reconcile",{cid:e,mode:"giveup",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),delete n.pendingMessages[e];let s=n.messages.find(i=>i.correlationId===e);s&&(s.failed=!0,s.pending=!1,C(s)?S():w());return}u("send.timeout.resend",{cid:e,attempts:o.attempts}),u("send.reconcile",{cid:e,mode:"timeout-resend",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),K(o.text,!0,!0,e),Ce(e)}},3e4))}function lt(e){let t=n.messages.find(s=>s.correlationId===e);t&&(t.pending=!1,t.failed=!1,C(t)?S():w());let o=n.pendingMessages[e];o&&u("send.reconcile",{cid:e,mode:"ack",attempts:o.attempts,latencyMs:Date.now()-o.createdAt}),delete n.pendingMessages[e],Te(e)}function Ee(e){let t=n.messages.find(o=>o.correlationId===e);t&&(t.failed=!1,t.pending=!0,C(t)?S():w(),u("send.retry.manual",{cid:e}),K(t.content,!0,!0,e))}function $(e){n.outbox.length>=50&&n.outbox.shift();let o=D("c_",12),s={text:e,cid:o};n.outbox.push(s),oe(e,o),ne(),re()}function Me(){let e=(a.messageInput&&a.messageInput.value||"").trim();if(!e)return;if(n.isOffline){$(e),u("send.queue",{reason:"offline",size:n.outbox.length}),a.messageInput&&(a.messageInput.value="");return}if(!n.profile){let o=Date.now(),s=X();if(n.authStatus===y.UNKNOWN||n.authStatus===y.PROBING||s){$(e);let i="awaitingProfile";s?i="authGrace":n.loading?i="loadingUI":n.authStatus===y.PROBING&&(i="authProbing"),u("send.queue",{reason:i,size:n.outbox.length}),a.messageInput&&(a.messageInput.value="");return}Y(window.i18n.SessionExpired||"Session expired. Please refresh.");return}if(n.joinInProgress||n.pendingJoin){$(e),u("send.queue",{reason:"joinInProgress",size:n.outbox.length}),a.messageInput&&(a.messageInput.value="");return}if(!n.joinedRoom){let o=n.rooms&&n.rooms.length?localStorage.getItem("lastRoom")&&n.rooms.some(s=>s.name===localStorage.getItem("lastRoom"))?localStorage.getItem("lastRoom"):n.rooms[0].name:null;o&&O(o),$(e),u("send.queue",{reason:"noRoomYet",size:n.outbox.length}),a.messageInput&&(a.messageInput.value="");return}try{let o=Z();if(o!=="connected"){$(e),u("send.queue",{reason:"hubNotConnected:"+o,size:n.outbox.length}),a.messageInput&&(a.messageInput.value="");return}}catch{}let t=D("c_",12);oe(e,t),K(e,!1,!1,t),a.messageInput&&(a.messageInput.value="")}function Ae(){n.rooms=[],n.users=[],n.messages=[],n.profile=null,n.joinedRoom=null,we(),L(!1)}function xe(){n.authStatus=y.PROBING;let e=performance.now();n.authGraceUntil=Date.now()+5e3,setTimeout(()=>{!n.profile&&(n.authStatus===y.PROBING||n.authStatus===y.UNKNOWN)&&!X()&&(n.authStatus=y.UNAUTHENTICATED,u("auth.finalize.unauth",{}),k())},5200);let t=setTimeout(()=>{v("warn","auth.timeout"),L(!1),u("auth.probe.timeout",{})},6e3);return fetch("/api/auth/me",{credentials:"include"}).then(o=>o.ok?o.json():null).then(o=>{clearTimeout(t),o&&o.userName?(n.profile={userName:o.userName,fullName:o.fullName,avatar:o.avatar},n.authStatus=y.AUTHENTICATED,u("auth.probe.success",{durationMs:Math.round(performance.now()-e)}),W(),h("authProbe"),n.authGraceUntil=null):(L(!1),n.authStatus=y.UNAUTHENTICATED,u("auth.probe.unauth",{durationMs:Math.round(performance.now()-e)})),k()}).catch(o=>{clearTimeout(t),L(!1);let s=o&&o.message||"";/timeout|network|fetch|offline|temporar(?:y|ily)?|dns|refused/i.test(s)?(u("auth.probe.errorTransient",{durationMs:Math.round(performance.now()-e)}),n.authGraceUntil=Date.now()+5e3,setTimeout(()=>{(n.authStatus===y.PROBING||n.authStatus===y.UNKNOWN)&&xe()},1200)):(n.authStatus=y.UNAUTHENTICATED,u("auth.probe.error",{durationMs:Math.round(performance.now()-e)}))}).finally(()=>{})}function ct(){a.messageInput&&a.messageInput.addEventListener("keypress",t=>{t.key==="Enter"&&Me()});let e=document.getElementById("btn-send-message");e&&e.addEventListener("click",t=>{t.preventDefault(),Me()}),a.filterInput&&a.filterInput.addEventListener("input",()=>{n.filter=a.filterInput.value,U()}),a.btnLogout&&a.btnLogout.addEventListener("click",()=>{fetch("/api/auth/logout",{method:"POST",credentials:"include"}).catch(()=>{}).finally(()=>{try{m&&m.stop&&m.stop()}catch{}Ae(),window.location.replace("/login?ReturnUrl=/chat")})})}function Y(e){if(!a.errorAlert)return;let t=a.errorAlert.querySelector("span");t&&(t.textContent=e),a.errorAlert.classList.remove("d-none"),setTimeout(()=>a.errorAlert.classList.add("d-none"),5e3)}window.chatApp=window.chatApp||{},window.chatApp.onAuthenticated=function(){L(!0),n.authStatus=y.PROBING;let e=performance.now(),t=!1,o=!1,s=6,i=400,r=0;function d(){r++,fetch("/api/auth/me",{credentials:"include"}).then(c=>c.ok?c.json():null).then(c=>{c&&c.userName?(o=!0,n.profile={userName:c.userName,fullName:c.fullName,avatar:c.avatar},n.authStatus=y.AUTHENTICATED,k(),W(),h("authRetry"),n.loading&&L(!1)):r<s?setTimeout(d,i*r):(n.loading&&L(!1),v("warn","auth.retry.exhausted"),n.authStatus=y.UNAUTHENTICATED)}).catch(()=>{r<s?setTimeout(d,i*r):(n.loading&&L(!1),v("error","auth.retry.failed"),n.authStatus=y.UNAUTHENTICATED)}).finally(()=>{(r>=s||o)&&(t=!0)})}d(),setTimeout(()=>{n.loading&&(n.profile||t)&&(L(!1),v("warn","auth.safetyFallback",{elapsedMs:Math.round(performance.now()-e)}))},2e3)},window.chatApp.logoutCleanup=Ae;function dt(){try{let e=sessionStorage.getItem("chat.outbox");if(e){let t=JSON.parse(e);Array.isArray(t)&&(n.outbox=t.slice(0,50).map(o=>typeof o=="string"?{text:o,cid:ke(o)}:o&&typeof o=="object"&&o.text?o:{text:String(o||""),cid:ke(String(o||""))}))}}catch{}ne()}function ke(e){let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return"c_"+Math.abs(t).toString(36).padStart(12,"0").slice(0,12)}function re(){try{sessionStorage.setItem("chat.outbox",JSON.stringify(n.outbox))}catch{}}function h(e){if(h._queue||(h._queue=[]),h._inProgress){h._queue.push(e);return}if(!n.outbox.length)return;if(n.isOffline){let l="flushSkip:offline:"+e;h._skipFlags||(h._skipFlags={}),h._skipFlags[l]||(h._skipFlags[l]=Date.now(),u("send.flush.skip",{reason:"offline",phase:e,qlen:n.outbox.length}));return}if(!n.profile||!n.joinedRoom){let l=n.profile?"noRoom":n.joinedRoom?"noProfile":"noProfile_noRoom",g="flushSkip:"+l+":"+e;h._skipFlags||(h._skipFlags={}),h._skipFlags[g]||(h._skipFlags[g]=Date.now(),u("send.flush.skip",{reason:l,phase:e,qlen:n.outbox.length}));return}h._inProgress=!0;let t=10,o=n.outbox.length,s=performance.now();u("send.flush.start",{room:n.joinedRoom&&n.joinedRoom.name,count:o,phase:e});let i=0,r=0,d=n.outbox.splice(0,o);ne(),re();function c(){if(!d.length)return Promise.resolve();let l=d.splice(0,t),g=[];return Promise.all(l.map(p=>{let{text:f,cid:b}=typeof p=="string"?{text:p,cid:null}:p;return b&&oe(f,b),K(f,!0,!0,b||void 0).then(()=>{i++,g.push({ok:!0})}).catch(()=>{r++,g.push({ok:!1,item:p})})})).then(()=>{let p=g.filter(f=>!f.ok).map(f=>f.item);return p.length&&(p.forEach(f=>n.outbox.push(f)),re(),u("send.flush.batchFail",{failed:p.length,phase:e})),c()})}c().finally(()=>{if(r&&u("send.flush.partialFail",{failed:r,success:i,remaining:n.outbox.length,phase:e}),u("send.flush.done",{room:n.joinedRoom&&n.joinedRoom.name,count:o,success:i,failed:r,durationMs:Math.round(performance.now()-s),phase:e}),h._inProgress=!1,h._queue.length){let l=h._queue.pop();h._queue.length=0,setTimeout(()=>h(l),0)}})}setInterval(()=>{try{n.outbox.length&&h("periodic"),n.outbox.length===0&&a.queueBadge&&a.queueBadge.textContent!=="0"&&!a.queueBadge.classList.contains("d-none")&&(a.queueBadge.textContent="0",a.queueBadge.classList.add("d-none"))}catch{}},1500),document.addEventListener("visibilitychange",()=>{document.hidden||h("visibility")}),document.addEventListener("visibilitychange",()=>{document.hidden||(le(),B(),V())}),window.addEventListener("focus",()=>{le(),B(),V()}),document.addEventListener("DOMContentLoaded",()=>{qe(),dt(),L(!0),xe(),ct(),De(),Fe(),ut(),je()});function ut(){function e(t){n.isOffline=t,t?u("net.offline",{}):(u("net.online",{}),setTimeout(()=>{V(),n.outbox.length&&h("online")},150)),M(Z())}typeof navigator<"u"&&"onLine"in navigator&&e(!navigator.onLine),window.addEventListener("offline",()=>e(!0)),window.addEventListener("online",()=>e(!1))}let R={base:null,timer:null,active:!1,counter:0,lastLabel:""};function je(){try{R.base=document.title||"Chat"}catch{R.base="Chat"}}function Ue(){if(R.base||je(),R.active)return;R.active=!0;let e=!0;R.timer=setInterval(()=>{try{document.title=e?R.lastLabel:R.base}catch{}e=!e},1e3)}function _e(e){let t=n.unreadCount||0,o=(t>0?"("+t+") ":"")+"New message"+(e?" \u2022 "+e:"");R.lastLabel=o,t>0&&!R.active&&Ue()}function ft(){if(R.timer){try{clearInterval(R.timer)}catch{}R.timer=null}R.active=!1;try{R.base&&(document.title=R.base)}catch{}}function Be(){let e=document.querySelector(".messages-container");return e?e.scrollHeight-e.scrollTop-e.clientHeight<=8:!1}function He(){try{return!document.hidden&&!!n.joinedRoom&&window.document.hasFocus()&&Be()}catch{return!1}}function mt(){try{return!document.hidden&&!!n.joinedRoom&&window.document.hasFocus()}catch{return!1}}let Pe=new Set;function gt(){return(n.profile&&n.profile.userName||"").toLowerCase()}function pt(){try{let e=document.querySelector(".messages-container");if(!e||!a.messagesList)return[];let t=e.getBoundingClientRect(),o=Array.from(a.messagesList.children||[]),s=[],i=gt();for(let d of o){if(!d||!d.getBoundingClientRect)continue;let c=d.getBoundingClientRect();if(Math.min(t.bottom,c.bottom)-Math.max(t.top,c.top)>12){let g=d.dataset&&d.dataset.id,p=g?parseInt(g,10):NaN;if(!Number.isFinite(p))continue;let f=n.messages.find(j=>j&&j.id===p);if(!f||f.isMine||(Array.isArray(f.readBy)?f.readBy:[]).some(j=>(j||"").toLowerCase()===i))continue;s.push(p)}}return Array.from(new Set(s)).slice(0,50)}catch{return[]}}function ht(){try{if(!mt()||!m||!n.joinedRoom)return;let e=pt().filter(t=>!Pe.has(t));if(!e.length)return;e.forEach(t=>Pe.add(t)),e.forEach(t=>{try{m.invoke("MarkRead",t)}catch{}})}catch{}}function yt(e,t){let o;return function(){let s=arguments;clearTimeout(o),o=setTimeout(()=>e.apply(null,s),t)}}let B=yt(ht,300);function le(){n.unreadCount>0&&He()?(n.unreadCount=0,ft(),B()):n.unreadCount>0&&_e(n.joinedRoom&&n.joinedRoom.name||"")}setInterval(()=>{try{m&&(m.state&&m.state.toLowerCase?m.state.toLowerCase():"")==="disconnected"&&V()}catch{}},1e4),window.addEventListener("error",function(){n.loading&&L(!1)}),window.addEventListener("unhandledrejection",function(){n.loading&&L(!1)})})();})();
