(()=>{(function(){let v=(e,n,a)=>window.appLogger&&window.appLogger[e]?window.appLogger[e](n,a):console.log(`[${e}] ${n}`,a||""),t={loading:!0,profile:null,rooms:[],users:[],messages:[],joinedRoom:null,filter:"",oldestLoaded:null,canLoadMore:!0,pageSize:20,loadingMore:!1,lastSendAt:0,minSendIntervalMs:800,joinInProgress:!1,pendingJoin:null,outbox:[],pendingAck:{},authProbing:!1},o={};function H(){o.app=document.querySelector(".app");let e=Array.from(document.querySelectorAll(".vh-100"));if(o.loaderWrapper=e.find(n=>n.querySelector(".spinner-border"))||document.querySelector(".d-flex.vh-100")||e[0],o.loaderWrapper===e[0]&&e.length>1){let n=e.find(a=>a!==e[0]);n&&(o.loaderWrapper=n)}o.roomsList=document.getElementById("rooms-list"),o.usersList=document.getElementById("users-list"),o.messagesList=document.getElementById("messages-list"),o.messageInput=document.getElementById("message-input"),o.joinedRoomTitle=document.getElementById("joinedRoom"),o.filterInput=document.querySelector(".users-container input[type=text]"),o.errorAlert=document.getElementById("errorAlert"),o.itemToDelete=document.getElementById("itemToDelete"),o.profileAvatarImg=document.getElementById("profileAvatarImg")||document.querySelector(".profile img.avatar"),o.profileAvatarInitial=document.getElementById("profileAvatarInitial")||document.querySelector(".profile span.avatar"),o.profileName=document.getElementById("profileName")||document.querySelector(".profile span:not(.avatar)"),o.btnLogin=document.getElementById("btn-login"),o.btnLogout=document.getElementById("btn-logout"),o.roomsNoSelection=document.querySelector('[data-role="no-room-selected"]'),o.roomsPanel=document.querySelector('[data-role="room-panel"]'),o.usersCount=document.getElementById("users-count"),o.queueBadge=document.getElementById("queue-badge"),o.roomHeader=document.querySelector('.main-content[data-role="room-panel"] .header')}function f(e){t.loading=e,o.loaderWrapper&&o.loaderWrapper.classList.toggle("d-none",!e),o.app&&o.app.classList.toggle("d-none",e)}function I(e){if(o.roomHeader)switch(o.roomHeader.classList.remove("connection-state-connected","connection-state-reconnecting","connection-state-disconnected"),!t._baseRoomTitle&&o.joinedRoomTitle&&(t._baseRoomTitle=o.joinedRoomTitle.textContent||""),e){case"connected":o.roomHeader.classList.add("connection-state-connected"),o.joinedRoomTitle&&t._baseRoomTitle&&(o.joinedRoomTitle.textContent=t._baseRoomTitle);break;case"reconnecting":o.roomHeader.classList.add("connection-state-reconnecting"),o.joinedRoomTitle&&t._baseRoomTitle&&(o.joinedRoomTitle.textContent=t._baseRoomTitle+" (RECONNECTING\u2026)");break;case"disconnected":if(o.roomHeader.classList.add("connection-state-disconnected"),o.joinedRoomTitle){let n=t._baseRoomTitle||o.joinedRoomTitle.textContent||"",a="\u26A0\uFE0F";o.joinedRoomTitle.textContent=n+" ("+a+" DISCONNECTED)"}break}}function J(){if(!m)return"disconnected";let e=m.state&&m.state.toLowerCase?m.state.toLowerCase():"";return e==="connected"?"connected":e==="connecting"||e==="reconnecting"?"reconnecting":"disconnected"}function $(){setInterval(()=>{I(J())},2500)}function R(e,n){let a=e&&typeof e=="string"&&e.trim().length>0?e:n||"";return a&&a.trim().charAt(0).toUpperCase()||"?"}function N(){o.roomsList&&(o.roomsList.innerHTML="",t.rooms.forEach(e=>{let n=document.createElement("li"),a=document.createElement("a");a.href="#",a.textContent=e.name,a.dataset.roomId=e.id,t.pendingJoin===e.name&&(!t.joinedRoom||t.joinedRoom.name!==e.name)&&a.classList.add("joining"),t.joinedRoom&&t.joinedRoom.name===e.name&&a.classList.add("active"),a.addEventListener("click",s=>{s.preventDefault(),E(e.name)}),n.appendChild(a),o.roomsList.appendChild(n)}))}function h(){if(!o.usersList)return;let e=t.filter.toLowerCase();o.usersList.innerHTML="";let n=t.users.filter(a=>!e||(a.fullName||a.userName||"").toLowerCase().includes(e));n.forEach(a=>{let s=document.createElement("li");s.dataset.username=a.userName;let i=document.createElement("div");if(i.className="user",a.avatar){let d=document.createElement("img");d.className="avatar me-2",d.src="/avatars/"+a.avatar,i.appendChild(d)}else{let d=document.createElement("span");d.className="avatar me-2 text-uppercase",d.textContent=R(a.fullName,a.userName),i.appendChild(d)}let r=document.createElement("div");r.className="user-info";let l=document.createElement("span");l.className="name",l.textContent=a.fullName||a.userName,r.appendChild(l);let c=document.createElement("span");c.className="device",c.textContent=a.device,r.appendChild(c),i.appendChild(r),s.appendChild(i),o.usersList.appendChild(s)}),o.usersCount&&(o.usersCount.textContent=n.length)}function z(e){let n=new Date(e),s=Math.round((n-new Date)/(1e3*3600*24)),i=n.getDate(),r=n.getMonth()+1,l=n.getFullYear(),c=n.getHours(),d=("0"+n.getMinutes()).slice(-2),y=c>=12?"PM":"AM";c>12&&(c=c%12);let b=`${i}/${r}/${l}`,p=`${c}:${d} ${y}`,ue=`${b} ${p}`,U=b;return s===0?U=`Today, ${p}`:s===-1&&(U=`Yesterday, ${p}`),{relative:U,full:ue}}function g(){if(!o.messagesList)return;o.messagesList.innerHTML="",t.messages.forEach(a=>{let s=document.createElement("li"),i=document.createElement("div");if(i.className="message-item",a.isMine&&i.classList.add("ismine"),a.avatar){let p=document.createElement("img");p.className="avatar avatar-lg mx-2",p.src="/avatars/"+a.avatar,i.appendChild(p)}else{let p=document.createElement("span");p.className="avatar avatar-lg mx-2 text-uppercase",p.textContent=R(a.fromFullName,a.fromUserName),i.appendChild(p)}let r=document.createElement("div");r.className="message-content";let l=document.createElement("div");l.className="message-info d-flex flex-wrap align-items-center";let c=document.createElement("span");c.className="author",c.textContent=a.fromFullName||a.fromUserName,l.appendChild(c);let d=document.createElement("span");d.className="timestamp";let y=z(a.timestamp);d.textContent=y.relative,d.dataset.bsTitle=y.full,d.setAttribute("data-bs-toggle","tooltip"),l.appendChild(d),r.appendChild(l);let b=document.createElement("div");b.className="content",b.textContent=a.content,r.appendChild(b),i.appendChild(r),s.appendChild(i),o.messagesList.appendChild(s)});let e=document.querySelector(".no-messages-info");e&&e.classList.toggle("d-none",t.messages.length>0);let n=document.querySelector(".messages-container");n&&!t.loadingMore&&(n.scrollTop=n.scrollHeight),window.bootstrap&&[].slice.call(o.messagesList.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(s=>{try{new window.bootstrap.Tooltip(s)}catch{}})}function w(){let e=t.profile;o.profileName&&(e?(o.profileName.textContent=e.fullName||e.userName,e.avatar?(o.profileAvatarImg&&(o.profileAvatarImg.src="/avatars/"+e.avatar,o.profileAvatarImg.classList.remove("d-none")),o.profileAvatarInitial&&o.profileAvatarInitial.classList.add("d-none")):(o.profileAvatarInitial&&(o.profileAvatarInitial.textContent=R(e.fullName,e.userName),o.profileAvatarInitial.classList.remove("d-none")),o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none")),o.btnLogin&&o.btnLogin.classList.add("d-none"),o.btnLogout&&o.btnLogout.classList.remove("d-none")):(o.profileName.textContent="Not signed in",o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none"),o.profileAvatarInitial&&(o.profileAvatarInitial.classList.remove("d-none"),o.profileAvatarInitial.textContent="?"),o.btnLogin&&o.btnLogin.classList.remove("d-none"),o.btnLogout&&o.btnLogout.classList.add("d-none")))}function W(){if(!(!t.profile||t.profile.avatar)&&o.profileAvatarInitial){let e=R(t.profile.fullName,t.profile.userName);o.profileAvatarInitial.textContent=e,o.profileAvatarInitial.classList.remove("d-none"),o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none")}}function P(){if(!o.roomsPanel||!o.roomsNoSelection)return;let e=!!t.joinedRoom;o.roomsPanel.classList.toggle("d-none",!e),o.roomsNoSelection.classList.toggle("d-none",e),t.joinedRoom&&o.joinedRoomTitle&&(o.joinedRoomTitle.textContent=t.joinedRoom.name),N()}function q(){w(),P(),h(),g()}function C(){if(!o.queueBadge)return;let e=t.outbox.length;o.queueBadge.textContent=e,o.queueBadge.classList.toggle("d-none",e===0)}let S=e=>fetch(e,{credentials:"include"}).then(n=>n.ok?n.json():Promise.reject(n)),fe=(e,n)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),pe=(e,n)=>fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),ge=e=>fetch(e,{method:"DELETE",credentials:"include"}),m=null,A=0,Y=3e4;function G(e){let n=new Uint8Array(e);if(window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(n);else for(let a=0;a<e;a++)n[a]=Math.floor(Math.random()*256);return n}function k(e,n){let a=G(n),s="";for(let i of a)s+=(i&15).toString(16);return(e||"")+s+"_"+Date.now().toString(36)}let Q=k("s_8",8);function u(e,n){try{fetch("/api/telemetry/reconnect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({evt:e,ts:Date.now(),sessionId:Q,...n})})}catch{}}function V(e){if(!e)return{cat:"unknown",msg:""};let n=e&&(e.message||e.toString())||"";return/403|401|unauthor/i.test(n)?{cat:"auth",msg:n}:/timeout|timed out/i.test(n)?{cat:"timeout",msg:n}:/network|fetch|socket|ws|transport/i.test(n)?{cat:"transport",msg:n}:/server|500|hubexception/i.test(n)?{cat:"server",msg:n}:{cat:"other",msg:n}}let M=null;function X(){return m||(m=new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build(),K(m),m)}function j(){X(),v("info","signalr.start"),I("reconnecting");let e=performance.now();return m.start().then(()=>{A=0,M=null,oe(),u("hub.connected",{durationMs:Math.round(performance.now()-e)}),I("connected"),t.profile&&t.loading&&f(!1)}).catch(n=>{v("error","signalr.start.fail",{error:n&&n.message}),u("hub.connect.fail",{message:n&&n.message||""}),B(n)})}function B(e){e&&(M=e),A++;let n=Math.min(1e3*Math.pow(2,A),Y);I("reconnecting");let{cat:a,msg:s}=V(M);u("hub.connect.retry",{attempt:A,delayMs:n,errorCategory:a,errorMessage:s.slice(0,300)}),setTimeout(()=>j().catch(i=>B(i)),n)}function K(e){e.on("getProfileInfo",n=>{t.profile={userName:n.userName,fullName:n.fullName,avatar:n.avatar},f(!1),w()}),e.on("presenceSnapshot",n=>{Array.isArray(n)&&(t.joinedRoom?t.users=n.filter(a=>a.currentRoom===t.joinedRoom.name||a.CurrentRoom===t.joinedRoom.name):t.users=n,h())}),e.on("newMessage",n=>{if(t.profile&&t.profile.userName){if(n.correlationId){let i=t.messages.findIndex(r=>r.isMine&&r.correlationId&&r.correlationId===n.correlationId);if(i>=0){t.messages[i]={id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:!0,correlationId:n.correlationId},g();return}}let s=t.messages.findIndex(i=>i.isMine&&i.id<0&&i.content===n.content);if(s>=0){t.messages[s]={id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:!0,correlationId:n.correlationId},g();return}}te({...n,correlationId:n.correlationId})}),e.on("notify",n=>ne(n)),e.onreconnected(n=>{try{t.joinedRoom&&m.invoke("GetUsers",t.joinedRoom.name).then(a=>{t.users=a,h()})}catch{}I("connected")}),e.onreconnecting(n=>{v("warn","hub.reconnecting",{message:n&&n.message}),I("reconnecting")}),e.onclose(()=>{I("disconnected"),t.users=[],h()}),e.on("addUser",n=>Z(n)),e.on("removeUser",n=>ee(n.userName)),e.on("addChatRoom",n=>D(n)),e.on("updateChatRoom",n=>D(n)),e.on("removeChatRoom",n=>{t.rooms=t.rooms.filter(a=>a.id!==n),t.joinedRoom&&t.joinedRoom.id===n&&(t.joinedRoom=null,t.messages=[]),q()}),e.on("onError",n=>L(n))}function D(e){let n=t.rooms.find(a=>a.id===e.id);n?(n.name=e.name,n.admin=e.admin):t.rooms.push({id:e.id,name:e.name,admin:e.admin}),N()}function Z(e){let n=t.users.find(a=>a.userName===e.userName);n?Object.assign(n,e):t.users.push(e),h()}function ee(e){t.users=t.users.filter(n=>n.userName!==e),h()}function te(e){let n=t.profile&&t.profile.userName===e.fromUserName;t.messages.push({id:e.id,content:e.content,timestamp:e.timestamp,fromUserName:e.fromUserName,fromFullName:e.fromFullName,avatar:e.avatar,isMine:n,correlationId:e.correlationId}),g()}function ne(e){let n=e.ts||new Date().toISOString(),a=`[NOTIFY] ${e.title}${e.body?": "+e.body:""}`;t.messages.push({id:"notify_"+n,content:a,timestamp:n,fromUserName:e.from||"system",fromFullName:e.from||"system",avatar:null,isMine:!1}),g()}function E(e){if(!m||!e||t.joinInProgress&&t.pendingJoin===e||t.joinedRoom&&t.joinedRoom.name===e&&!t.joinInProgress)return;t.joinInProgress=!0,t.pendingJoin=e,N();let n=e,a=performance.now();m.invoke("Join",e).then(()=>{if(t.pendingJoin===n&&(t.joinedRoom=t.rooms.find(s=>s.name===e)||{name:e},t.pendingJoin=null,t.joinInProgress=!1,localStorage.setItem("lastRoom",e),o.joinedRoomTitle&&(t._baseRoomTitle=t.joinedRoom.name,o.joinedRoomTitle.textContent=t._baseRoomTitle),ae(),se(),P(),W(),u("room.join.success",{room:e,durationMs:Math.round(performance.now()-a)}),t.outbox&&t.outbox.length)){let s=t.outbox.splice(0,t.outbox.length);C(),x();let i=0,r=0,l=[],c=performance.now();s.forEach(d=>{try{F(d,!0,!0).then(()=>{i++}).catch(()=>{r++,l.push(d)})}catch{r++,l.push(d)}}),setTimeout(()=>{l.length&&(t.outbox.unshift(...l.slice(0,50)),C(),x(),u("send.flush.retry",{retry:l.length,room:e})),u("send.flush.done",{room:e,count:s.length,success:i,failed:r,durationMs:Math.round(performance.now()-c)})},50)}}).catch(s=>{t.pendingJoin===n&&(t.joinInProgress=!1,t.pendingJoin=null,N()),L("Join failed: "+(s&&s.message))})}function oe(){S("/api/Rooms").then(e=>{t.rooms=(e||[]).map(a=>({id:a.id!==void 0?a.id:a.Id,name:a.name!==void 0?a.name:a.Name,admin:a.admin!==void 0?a.admin:a.Admin})),N();let n=localStorage.getItem("lastRoom");n&&t.rooms.some(a=>a.name===n)?E(n):t.rooms.length>0&&E(t.rooms[0].name)}).catch(()=>{})}function ae(){t.joinedRoom&&m.invoke("GetUsers",t.joinedRoom.name).then(e=>{t.users=e,h()})}function se(){t.joinedRoom&&(t.oldestLoaded=null,t.canLoadMore=!0,S("/api/Messages/Room/"+encodeURIComponent(t.joinedRoom.name)+"?take="+t.pageSize).then(e=>{t.messages=e.map(n=>({id:n.id,content:n.content,timestamp:n.timestamp,fromUserName:n.fromUserName,fromFullName:n.fromFullName,avatar:n.avatar,isMine:t.profile&&t.profile.userName===n.fromUserName})),t.messages.length>0?(t.oldestLoaded=t.messages[0].timestamp,e.length<t.pageSize&&(t.canLoadMore=!1)):t.canLoadMore=!1,g(),ie()}).catch(()=>{}))}function re(){if(!t.canLoadMore||t.loadingMore||!t.joinedRoom||!t.oldestLoaded)return;t.loadingMore=!0;let e=encodeURIComponent(t.oldestLoaded);S("/api/Messages/Room/"+encodeURIComponent(t.joinedRoom.name)+"?before="+e+"&take="+t.pageSize).then(n=>{if(!Array.isArray(n)||n.length===0){t.canLoadMore=!1;return}let a=n.map(r=>({id:r.id,content:r.content,timestamp:r.timestamp,fromUserName:r.fromUserName,fromFullName:r.fromFullName,avatar:r.avatar,isMine:t.profile&&t.profile.userName===r.fromUserName})),s=document.querySelector(".messages-container"),i=s?s.scrollHeight:0;if(t.messages=a.concat(t.messages),t.oldestLoaded=t.messages[0].timestamp,n.length<t.pageSize&&(t.canLoadMore=!1),g(),s){let r=s.scrollHeight;s.scrollTop=r-i}}).finally(()=>{t.loadingMore=!1})}function ie(){let e=document.querySelector(".messages-container");if(!e||e.dataset.paginated)return;e.dataset.paginated="true";let n=0;e.addEventListener("scroll",()=>{if(e.scrollTop<30){let a=Date.now();a-n>400&&(n=a,re())}})}let le=-1;function F(e,n,a){let s=Date.now();if(!n&&s-t.lastSendAt<t.minSendIntervalMs)return L("You are sending messages too quickly"),Promise.reject("rateLimited");t.lastSendAt=s;let i=le--,r=new Date().toISOString(),l=k("c_",12);return t.messages.push({id:i,content:e,timestamp:r,fromUserName:t.profile?.userName,fromFullName:t.profile?.fullName,avatar:t.profile?.avatar,isMine:!!t.profile,correlationId:l}),g(),m?(u("send.attempt",{cid:l,len:e.length,fromFlush:!!a}),m.invoke("SendMessage",e,l).then(()=>{u("send.invoke.ok",{cid:l})}).catch(d=>{throw t.messages=t.messages.filter(y=>y.id!==i),g(),u("send.invoke.fail",{cid:l,msg:d&&d.message||""}),L("Send failed"),d})):Promise.reject("noHub")}function T(e){t.outbox.length>=50&&t.outbox.shift(),t.outbox.push(e),C(),x()}function O(){let e=(o.messageInput&&o.messageInput.value||"").trim();if(e){if(!t.profile){if(t.authProbing){T(e),u("send.queue",{reason:"authProbing",size:t.outbox.length}),o.messageInput&&(o.messageInput.value="");return}L("Not signed in.");return}if(t.joinInProgress||t.pendingJoin){T(e),u("send.queue",{reason:"joinInProgress",size:t.outbox.length}),o.messageInput&&(o.messageInput.value="");return}if(!t.joinedRoom){let n=t.rooms&&t.rooms.length?localStorage.getItem("lastRoom")&&t.rooms.some(a=>a.name===localStorage.getItem("lastRoom"))?localStorage.getItem("lastRoom"):t.rooms[0].name:null;n&&E(n),T(e),u("send.queue",{reason:"noRoomYet",size:t.outbox.length}),o.messageInput&&(o.messageInput.value="");return}F(e,!1,!1),o.messageInput&&(o.messageInput.value="")}}function _(){t.rooms=[],t.users=[],t.messages=[],t.profile=null,t.joinedRoom=null,q(),f(!1)}function ce(){t.authProbing=!0;let e=performance.now(),n=setTimeout(()=>{v("warn","auth.timeout"),f(!1),u("auth.probe.timeout",{})},6e3);return fetch("/api/auth/me",{credentials:"include"}).then(a=>a.ok?a.json():null).then(a=>{clearTimeout(n),a&&a.userName?(t.profile={userName:a.userName,fullName:a.fullName,avatar:a.avatar},u("auth.probe.success",{durationMs:Math.round(performance.now()-e)}),j()):(f(!1),u("auth.probe.unauth",{durationMs:Math.round(performance.now()-e)})),w()}).catch(()=>{clearTimeout(n),f(!1),u("auth.probe.error",{durationMs:Math.round(performance.now()-e)})}).finally(()=>{t.authProbing=!1})}function de(){o.messageInput&&o.messageInput.addEventListener("keypress",n=>{n.key==="Enter"&&O()});let e=document.getElementById("btn-send-message");e&&e.addEventListener("click",n=>{n.preventDefault(),O()}),o.filterInput&&o.filterInput.addEventListener("input",()=>{t.filter=o.filterInput.value,h()}),o.btnLogout&&o.btnLogout.addEventListener("click",()=>{fetch("/api/auth/logout",{method:"POST",credentials:"include"}).finally(()=>{try{m&&m.stop&&m.stop()}catch{}_()})})}function L(e){if(!o.errorAlert)return;let n=o.errorAlert.querySelector("span");n&&(n.textContent=e),o.errorAlert.classList.remove("d-none"),setTimeout(()=>o.errorAlert.classList.add("d-none"),5e3)}window.chatApp=window.chatApp||{},window.chatApp.onAuthenticated=function(){f(!0),t.authProbing=!0;let e=performance.now(),n=!1,a=!1,s=6,i=400,r=0;function l(){r++,fetch("/api/auth/me",{credentials:"include"}).then(c=>c.ok?c.json():null).then(c=>{c&&c.userName?(a=!0,t.profile={userName:c.userName,fullName:c.fullName,avatar:c.avatar},w(),j(),t.loading&&f(!1),t.authProbing=!1):r<s?setTimeout(l,i*r):(t.loading&&f(!1),v("warn","auth.retry.exhausted"),t.authProbing=!1)}).catch(()=>{r<s?setTimeout(l,i*r):(t.loading&&f(!1),v("error","auth.retry.failed"),t.authProbing=!1)}).finally(()=>{(r>=s||a)&&(n=!0)})}l(),setTimeout(()=>{t.loading&&(t.profile||n)&&(f(!1),v("warn","auth.safetyFallback",{elapsedMs:Math.round(performance.now()-e)}))},2e3)},window.chatApp.logoutCleanup=_;function me(){try{let e=sessionStorage.getItem("chat.outbox");if(e){let n=JSON.parse(e);Array.isArray(n)&&(t.outbox=n.slice(0,50))}}catch{}C()}function x(){try{sessionStorage.setItem("chat.outbox",JSON.stringify(t.outbox))}catch{}}document.addEventListener("DOMContentLoaded",()=>{H(),me(),f(!0),ce(),de(),$()}),window.addEventListener("error",function(){t.loading&&f(!1)}),window.addEventListener("unhandledrejection",function(){t.loading&&f(!1)})})();})();
