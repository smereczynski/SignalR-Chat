(()=>{(function(){let v=(e,t,a)=>window.appLogger&&window.appLogger[e]?window.appLogger[e](t,a):console.log(`[${e}] ${t}`,a||""),n={loading:!0,profile:null,rooms:[],users:[],messages:[],joinedRoom:null,filter:"",oldestLoaded:null,canLoadMore:!0,pageSize:20,loadingMore:!1,lastSendAt:0,minSendIntervalMs:800,joinInProgress:!1,pendingJoin:null,outbox:[],pendingAck:{}},o={};function O(){o.app=document.querySelector(".app");let e=Array.from(document.querySelectorAll(".vh-100"));if(o.loaderWrapper=e.find(t=>t.querySelector(".spinner-border"))||document.querySelector(".d-flex.vh-100")||e[0],o.loaderWrapper===e[0]&&e.length>1){let t=e.find(a=>a!==e[0]);t&&(o.loaderWrapper=t)}o.roomsList=document.getElementById("rooms-list"),o.usersList=document.getElementById("users-list"),o.messagesList=document.getElementById("messages-list"),o.messageInput=document.getElementById("message-input"),o.joinedRoomTitle=document.getElementById("joinedRoom"),o.filterInput=document.querySelector(".users-container input[type=text]"),o.errorAlert=document.getElementById("errorAlert"),o.itemToDelete=document.getElementById("itemToDelete"),o.profileAvatarImg=document.getElementById("profileAvatarImg")||document.querySelector(".profile img.avatar"),o.profileAvatarInitial=document.getElementById("profileAvatarInitial")||document.querySelector(".profile span.avatar"),o.profileName=document.getElementById("profileName")||document.querySelector(".profile span:not(.avatar)"),o.btnLogin=document.getElementById("btn-login"),o.btnLogout=document.getElementById("btn-logout"),o.roomsNoSelection=document.querySelector('[data-role="no-room-selected"]'),o.roomsPanel=document.querySelector('[data-role="room-panel"]'),o.usersCount=document.getElementById("users-count"),o.queueBadge=document.getElementById("queue-badge")}function u(e){n.loading=e,o.loaderWrapper&&o.loaderWrapper.classList.toggle("d-none",!e),o.app&&o.app.classList.toggle("d-none",e)}function b(e,t){let a=e&&typeof e=="string"&&e.trim().length>0?e:t||"";return a&&a.trim().charAt(0).toUpperCase()||"?"}function y(){o.roomsList&&(o.roomsList.innerHTML="",n.rooms.forEach(e=>{let t=document.createElement("li"),a=document.createElement("a");a.href="#",a.textContent=e.name,a.dataset.roomId=e.id,n.pendingJoin===e.name&&(!n.joinedRoom||n.joinedRoom.name!==e.name)&&a.classList.add("joining"),n.joinedRoom&&n.joinedRoom.name===e.name&&a.classList.add("active"),a.addEventListener("click",s=>{s.preventDefault(),S(e.name)}),t.appendChild(a),o.roomsList.appendChild(t)}))}function N(){if(!o.usersList)return;let e=n.filter.toLowerCase();o.usersList.innerHTML="";let t=n.users.filter(a=>!e||(a.fullName||a.userName||"").toLowerCase().includes(e));t.forEach(a=>{let s=document.createElement("li");s.dataset.username=a.userName;let i=document.createElement("div");if(i.className="user",a.avatar){let c=document.createElement("img");c.className="avatar me-2",c.src="/avatars/"+a.avatar,i.appendChild(c)}else{let c=document.createElement("span");c.className="avatar me-2 text-uppercase",c.textContent=b(a.fullName,a.userName),i.appendChild(c)}let r=document.createElement("div");r.className="user-info";let l=document.createElement("span");l.className="name",l.textContent=a.fullName||a.userName,r.appendChild(l);let d=document.createElement("span");d.className="device",d.textContent=a.device,r.appendChild(d),i.appendChild(r),s.appendChild(i),o.usersList.appendChild(s)}),o.usersCount&&(o.usersCount.textContent=t.length)}function J(e){let t=new Date(e),s=Math.round((t-new Date)/(1e3*3600*24)),i=t.getDate(),r=t.getMonth()+1,l=t.getFullYear(),d=t.getHours(),c=("0"+t.getMinutes()).slice(-2),h=d>=12?"PM":"AM";d>12&&(d=d%12);let I=`${i}/${r}/${l}`,p=`${d}:${c} ${h}`,ie=`${I} ${p}`,x=I;return s===0?x=`Today, ${p}`:s===-1&&(x=`Yesterday, ${p}`),{relative:x,full:ie}}function g(){if(!o.messagesList)return;o.messagesList.innerHTML="",n.messages.forEach(a=>{let s=document.createElement("li"),i=document.createElement("div");if(i.className="message-item",a.isMine&&i.classList.add("ismine"),a.avatar){let p=document.createElement("img");p.className="avatar avatar-lg mx-2",p.src="/avatars/"+a.avatar,i.appendChild(p)}else{let p=document.createElement("span");p.className="avatar avatar-lg mx-2 text-uppercase",p.textContent=b(a.fromFullName,a.fromUserName),i.appendChild(p)}let r=document.createElement("div");r.className="message-content";let l=document.createElement("div");l.className="message-info d-flex flex-wrap align-items-center";let d=document.createElement("span");d.className="author",d.textContent=a.fromFullName||a.fromUserName,l.appendChild(d);let c=document.createElement("span");c.className="timestamp";let h=J(a.timestamp);c.textContent=h.relative,c.dataset.bsTitle=h.full,c.setAttribute("data-bs-toggle","tooltip"),l.appendChild(c),r.appendChild(l);let I=document.createElement("div");I.className="content",I.textContent=a.content,r.appendChild(I),i.appendChild(r),s.appendChild(i),o.messagesList.appendChild(s)});let e=document.querySelector(".no-messages-info");e&&e.classList.toggle("d-none",n.messages.length>0);let t=document.querySelector(".messages-container");t&&!n.loadingMore&&(t.scrollTop=t.scrollHeight),window.bootstrap&&[].slice.call(o.messagesList.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(s=>{try{new window.bootstrap.Tooltip(s)}catch{}})}function w(){let e=n.profile;o.profileName&&(e?(o.profileName.textContent=e.fullName||e.userName,e.avatar?(o.profileAvatarImg&&(o.profileAvatarImg.src="/avatars/"+e.avatar,o.profileAvatarImg.classList.remove("d-none")),o.profileAvatarInitial&&o.profileAvatarInitial.classList.add("d-none")):(o.profileAvatarInitial&&(o.profileAvatarInitial.textContent=b(e.fullName,e.userName),o.profileAvatarInitial.classList.remove("d-none")),o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none")),o.btnLogin&&o.btnLogin.classList.add("d-none"),o.btnLogout&&o.btnLogout.classList.remove("d-none")):(o.profileName.textContent="Not signed in",o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none"),o.profileAvatarInitial&&(o.profileAvatarInitial.classList.remove("d-none"),o.profileAvatarInitial.textContent="?"),o.btnLogin&&o.btnLogin.classList.remove("d-none"),o.btnLogout&&o.btnLogout.classList.add("d-none")))}function H(){if(!(!n.profile||n.profile.avatar)&&o.profileAvatarInitial){let e=b(n.profile.fullName,n.profile.userName);o.profileAvatarInitial.textContent=e,o.profileAvatarInitial.classList.remove("d-none"),o.profileAvatarImg&&o.profileAvatarImg.classList.add("d-none")}}function U(){if(!o.roomsPanel||!o.roomsNoSelection)return;let e=!!n.joinedRoom;o.roomsPanel.classList.toggle("d-none",!e),o.roomsNoSelection.classList.toggle("d-none",e),n.joinedRoom&&o.joinedRoomTitle&&(o.joinedRoomTitle.textContent=n.joinedRoom.name),y()}function T(){w(),U(),N(),g()}function M(){if(!o.queueBadge)return;let e=n.outbox.length;o.queueBadge.textContent=e,o.queueBadge.classList.toggle("d-none",e===0)}let E=e=>fetch(e,{credentials:"include"}).then(t=>t.ok?t.json():Promise.reject(t)),le=(e,t)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),de=(e,t)=>fetch(e,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),ce=e=>fetch(e,{method:"DELETE",credentials:"include"}),f=null,A=0,$=3e4,_="s_"+Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);function m(e,t){try{fetch("/api/telemetry/reconnect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({evt:e,ts:Date.now(),sessionId:_,...t})})}catch{}}function z(e){if(!e)return{cat:"unknown",msg:""};let t=e&&(e.message||e.toString())||"";return/403|401|unauthor/i.test(t)?{cat:"auth",msg:t}:/timeout|timed out/i.test(t)?{cat:"timeout",msg:t}:/network|fetch|socket|ws|transport/i.test(t)?{cat:"transport",msg:t}:/server|500|hubexception/i.test(t)?{cat:"server",msg:t}:{cat:"other",msg:t}}let C=null;function W(){return f||(f=new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build(),Y(f),f)}function R(){W(),v("info","signalr.start");let e=performance.now();return f.start().then(()=>{A=0,C=null,V(),m("hub.connected",{durationMs:Math.round(performance.now()-e)}),n.profile&&n.loading&&u(!1)}).catch(t=>{v("error","signalr.start.fail",{error:t&&t.message}),m("hub.connect.fail",{message:t&&t.message||""}),q(t)})}function q(e){e&&(C=e),A++;let t=Math.min(1e3*Math.pow(2,A),$),{cat:a,msg:s}=z(C);m("hub.connect.retry",{attempt:A,delayMs:t,errorCategory:a,errorMessage:s.slice(0,300)}),setTimeout(()=>R().catch(i=>q(i)),t)}function Y(e){e.on("getProfileInfo",t=>{n.profile={userName:t.userName,fullName:t.fullName,avatar:t.avatar},u(!1),w()}),e.on("newMessage",t=>{if(n.profile&&n.profile.userName){if(t.correlationId){let i=n.messages.findIndex(r=>r.isMine&&r.correlationId&&r.correlationId===t.correlationId);if(i>=0){n.messages[i]={id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:!0,correlationId:t.correlationId},g();return}}let s=n.messages.findIndex(i=>i.isMine&&i.id<0&&i.content===t.content);if(s>=0){n.messages[s]={id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:!0,correlationId:t.correlationId},g();return}}X({...t,correlationId:t.correlationId})}),e.on("addUser",t=>Q(t)),e.on("removeUser",t=>G(t.userName)),e.on("addChatRoom",t=>P(t)),e.on("updateChatRoom",t=>P(t)),e.on("removeChatRoom",t=>{n.rooms=n.rooms.filter(a=>a.id!==t),n.joinedRoom&&n.joinedRoom.id===t&&(n.joinedRoom=null,n.messages=[]),T()}),e.on("onError",t=>L(t)),e.on("notify",t=>K(t))}function P(e){let t=n.rooms.find(a=>a.id===e.id);t?(t.name=e.name,t.admin=e.admin):n.rooms.push({id:e.id,name:e.name,admin:e.admin}),y()}function Q(e){let t=n.users.find(a=>a.userName===e.userName);t?Object.assign(t,e):n.users.push(e),N()}function G(e){n.users=n.users.filter(t=>t.userName!==e),N()}function X(e){let t=n.profile&&n.profile.userName===e.fromUserName;n.messages.push({id:e.id,content:e.content,timestamp:e.timestamp,fromUserName:e.fromUserName,fromFullName:e.fromFullName,avatar:e.avatar,isMine:t,correlationId:e.correlationId}),g()}function K(e){let t=e.ts||new Date().toISOString(),a=`[NOTIFY] ${e.title}${e.body?": "+e.body:""}`;n.messages.push({id:"notify_"+t,content:a,timestamp:t,fromUserName:e.from||"system",fromFullName:e.from||"system",avatar:null,isMine:!1}),g()}function S(e){if(!f||!e||n.joinInProgress&&n.pendingJoin===e||n.joinedRoom&&n.joinedRoom.name===e&&!n.joinInProgress)return;n.joinInProgress=!0,n.pendingJoin=e,y();let t=e,a=performance.now();f.invoke("Join",e).then(()=>{if(n.pendingJoin===t&&(n.joinedRoom=n.rooms.find(s=>s.name===e)||{name:e},n.pendingJoin=null,n.joinInProgress=!1,localStorage.setItem("lastRoom",e),Z(),ee(),U(),H(),m("room.join.success",{room:e,durationMs:Math.round(performance.now()-a)}),n.outbox&&n.outbox.length)){let s=n.outbox.splice(0,n.outbox.length);M(),j();let i=0,r=0,l=[],d=performance.now();s.forEach(c=>{try{k(c,!0,!0).then(()=>{i++}).catch(()=>{r++,l.push(c)})}catch{r++,l.push(c)}}),setTimeout(()=>{l.length&&(n.outbox.unshift(...l.slice(0,50)),M(),j(),m("send.flush.retry",{retry:l.length,room:e})),m("send.flush.done",{room:e,count:s.length,success:i,failed:r,durationMs:Math.round(performance.now()-d)})},50)}}).catch(s=>{n.pendingJoin===t&&(n.joinInProgress=!1,n.pendingJoin=null,y()),L("Join failed: "+(s&&s.message))})}function V(){E("/api/Rooms").then(e=>{n.rooms=(e||[]).map(a=>({id:a.id!==void 0?a.id:a.Id,name:a.name!==void 0?a.name:a.Name,admin:a.admin!==void 0?a.admin:a.Admin})),y();let t=localStorage.getItem("lastRoom");t&&n.rooms.some(a=>a.name===t)?S(t):n.rooms.length>0&&S(n.rooms[0].name)}).catch(()=>{})}function Z(){n.joinedRoom&&f.invoke("GetUsers",n.joinedRoom.name).then(e=>{n.users=e,N()})}function ee(){n.joinedRoom&&(n.oldestLoaded=null,n.canLoadMore=!0,E("/api/Messages/Room/"+encodeURIComponent(n.joinedRoom.name)+"?take="+n.pageSize).then(e=>{n.messages=e.map(t=>({id:t.id,content:t.content,timestamp:t.timestamp,fromUserName:t.fromUserName,fromFullName:t.fromFullName,avatar:t.avatar,isMine:n.profile&&n.profile.userName===t.fromUserName})),n.messages.length>0?(n.oldestLoaded=n.messages[0].timestamp,e.length<n.pageSize&&(n.canLoadMore=!1)):n.canLoadMore=!1,g(),ne()}).catch(()=>{}))}function te(){if(!n.canLoadMore||n.loadingMore||!n.joinedRoom||!n.oldestLoaded)return;n.loadingMore=!0;let e=encodeURIComponent(n.oldestLoaded);E("/api/Messages/Room/"+encodeURIComponent(n.joinedRoom.name)+"?before="+e+"&take="+n.pageSize).then(t=>{if(!Array.isArray(t)||t.length===0){n.canLoadMore=!1;return}let a=t.map(r=>({id:r.id,content:r.content,timestamp:r.timestamp,fromUserName:r.fromUserName,fromFullName:r.fromFullName,avatar:r.avatar,isMine:n.profile&&n.profile.userName===r.fromUserName})),s=document.querySelector(".messages-container"),i=s?s.scrollHeight:0;if(n.messages=a.concat(n.messages),n.oldestLoaded=n.messages[0].timestamp,t.length<n.pageSize&&(n.canLoadMore=!1),g(),s){let r=s.scrollHeight;s.scrollTop=r-i}}).finally(()=>{n.loadingMore=!1})}function ne(){let e=document.querySelector(".messages-container");if(!e||e.dataset.paginated)return;e.dataset.paginated="true";let t=0;e.addEventListener("scroll",()=>{if(e.scrollTop<30){let a=Date.now();a-t>400&&(t=a,te())}})}let oe=-1;function k(e,t,a){let s=Date.now();if(!t&&s-n.lastSendAt<n.minSendIntervalMs)return L("You are sending messages too quickly"),Promise.reject("rateLimited");n.lastSendAt=s;let i=oe--,r=new Date().toISOString(),l="c_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8);return n.messages.push({id:i,content:e,timestamp:r,fromUserName:n.profile?.userName,fromFullName:n.profile?.fullName,avatar:n.profile?.avatar,isMine:!!n.profile,correlationId:l}),g(),f?(m("send.attempt",{cid:l,len:e.length,fromFlush:!!a}),f.invoke("SendMessage",e,l).then(()=>{m("send.invoke.ok",{cid:l})}).catch(c=>{throw n.messages=n.messages.filter(h=>h.id!==i),g(),m("send.invoke.fail",{cid:l,msg:c&&c.message||""}),L("Send failed"),c})):Promise.reject("noHub")}function B(e){n.outbox.length>=50&&n.outbox.shift(),n.outbox.push(e),M(),j()}function D(){let e=(o.messageInput&&o.messageInput.value||"").trim();if(e){if(!n.profile){L("Not signed in.");return}if(n.joinInProgress||n.pendingJoin){B(e),m("send.queue",{reason:"joinInProgress",size:n.outbox.length}),o.messageInput&&(o.messageInput.value="");return}if(!n.joinedRoom){let t=n.rooms&&n.rooms.length?localStorage.getItem("lastRoom")&&n.rooms.some(a=>a.name===localStorage.getItem("lastRoom"))?localStorage.getItem("lastRoom"):n.rooms[0].name:null;t&&S(t),B(e),m("send.queue",{reason:"noRoomYet",size:n.outbox.length}),o.messageInput&&(o.messageInput.value="");return}k(e,!1,!1),o.messageInput&&(o.messageInput.value="")}}function F(){n.rooms=[],n.users=[],n.messages=[],n.profile=null,n.joinedRoom=null,T(),u(!1)}function ae(){let e=performance.now(),t=setTimeout(()=>{v("warn","auth.timeout"),u(!1),m("auth.probe.timeout",{})},6e3);return fetch("/api/auth/me",{credentials:"include"}).then(a=>a.ok?a.json():null).then(a=>{clearTimeout(t),a&&a.userName?(n.profile={userName:a.userName,fullName:a.fullName,avatar:a.avatar},m("auth.probe.success",{durationMs:Math.round(performance.now()-e)}),R()):(u(!1),m("auth.probe.unauth",{durationMs:Math.round(performance.now()-e)})),w()}).catch(()=>{clearTimeout(t),u(!1),m("auth.probe.error",{durationMs:Math.round(performance.now()-e)})})}function se(){o.messageInput&&o.messageInput.addEventListener("keypress",t=>{t.key==="Enter"&&D()});let e=document.getElementById("btn-send-message");e&&e.addEventListener("click",t=>{t.preventDefault(),D()}),o.filterInput&&o.filterInput.addEventListener("input",()=>{n.filter=o.filterInput.value,N()}),o.btnLogout&&o.btnLogout.addEventListener("click",()=>{fetch("/api/auth/logout",{method:"POST",credentials:"include"}).finally(()=>{F()})})}function L(e){if(!o.errorAlert)return;let t=o.errorAlert.querySelector("span");t&&(t.textContent=e),o.errorAlert.classList.remove("d-none"),setTimeout(()=>o.errorAlert.classList.add("d-none"),5e3)}window.chatApp=window.chatApp||{},window.chatApp.onAuthenticated=function(){u(!0);let e=performance.now(),t=!1,a=!1,s=6,i=400,r=0;function l(){r++,fetch("/api/auth/me",{credentials:"include"}).then(d=>d.ok?d.json():null).then(d=>{d&&d.userName?(a=!0,n.profile={userName:d.userName,fullName:d.fullName,avatar:d.avatar},w(),R(),n.loading&&u(!1)):r<s?setTimeout(l,i*r):(n.loading&&u(!1),v("warn","auth.retry.exhausted"))}).catch(()=>{r<s?setTimeout(l,i*r):(n.loading&&u(!1),v("error","auth.retry.failed"))}).finally(()=>{(r>=s||a)&&(t=!0)})}l(),setTimeout(()=>{n.loading&&(n.profile||t)&&(u(!1),v("warn","auth.safetyFallback",{elapsedMs:Math.round(performance.now()-e)}))},2e3)},window.chatApp.logoutCleanup=F;function re(){try{let e=sessionStorage.getItem("chat.outbox");if(e){let t=JSON.parse(e);Array.isArray(t)&&(n.outbox=t.slice(0,50))}}catch{}M()}function j(){try{sessionStorage.setItem("chat.outbox",JSON.stringify(n.outbox))}catch{}}document.addEventListener("DOMContentLoaded",()=>{O(),re(),u(!0),ae(),se()}),window.addEventListener("error",function(){n.loading&&u(!1)}),window.addEventListener("unhandledrejection",function(){n.loading&&u(!1)})})();})();
