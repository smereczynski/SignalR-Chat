name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - validate
          - deploy
          - teardown

permissions:
  id-token: write
  contents: read

jobs:
  infrastructure:
    name: ${{ github.event.inputs.action }} - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    env:
      RESOURCE_GROUP: rg-${{ vars.BICEP_BASE_NAME }}-${{ github.event.inputs.environment }}-${{ vars.BICEP_SHORT_LOCATION }}
      NETWORKING_RESOURCE_GROUP: rg-vnet-${{ vars.BICEP_BASE_NAME }}-${{ github.event.inputs.environment }}-${{ vars.BICEP_SHORT_LOCATION }}
      BICEP_BASE_NAME: ${{ vars.BICEP_BASE_NAME }}
      BICEP_LOCATION: ${{ vars.BICEP_LOCATION }}
      BICEP_SHORT_LOCATION: ${{ vars.BICEP_SHORT_LOCATION }}
      BICEP_VNET_ADDRESS_PREFIX: ${{ vars.BICEP_VNET_ADDRESS_PREFIX }}
      BICEP_APP_SERVICE_SUBNET_PREFIX: ${{ vars.BICEP_APP_SERVICE_SUBNET_PREFIX }}
      BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX: ${{ vars.BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX }}
      BICEP_ACS_DATA_LOCATION: ${{ vars.BICEP_ACS_DATA_LOCATION }}
      BICEP_VNET_DNS_SERVERS: ${{ vars.BICEP_VNET_DNS_SERVERS }}
      ENVIRONMENT: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate Environment Variables
        run: |
          echo "::group::Validating Required Environment Variables"
          
          MISSING_VARS=()
          
          if [ -z "${{ vars.BICEP_BASE_NAME }}" ]; then
            MISSING_VARS+=("BICEP_BASE_NAME")
          fi
          
          if [ -z "${{ vars.BICEP_LOCATION }}" ]; then
            MISSING_VARS+=("BICEP_LOCATION")
          fi
          
          if [ -z "${{ vars.BICEP_SHORT_LOCATION }}" ]; then
            MISSING_VARS+=("BICEP_SHORT_LOCATION")
          fi
          
          if [ -z "${{ vars.BICEP_VNET_ADDRESS_PREFIX }}" ]; then
            MISSING_VARS+=("BICEP_VNET_ADDRESS_PREFIX")
          fi
          
          if [ -z "${{ vars.BICEP_APP_SERVICE_SUBNET_PREFIX }}" ]; then
            MISSING_VARS+=("BICEP_APP_SERVICE_SUBNET_PREFIX")
          fi
          
          if [ -z "${{ vars.BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX }}" ]; then
            MISSING_VARS+=("BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX")
          fi
          
          if [ -z "${{ vars.BICEP_ACS_DATA_LOCATION }}" ]; then
            MISSING_VARS+=("BICEP_ACS_DATA_LOCATION")
          fi
          
          if [ ${#MISSING_VARS[@]} -gt 0 ]; then
            echo "âŒ ERROR: Missing required environment variables for environment '${{ github.event.inputs.environment }}':"
            for var in "${MISSING_VARS[@]}"; do
              echo "  - $var"
            done
            echo ""
            echo "Please configure these variables in:"
            echo "GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions â†’ Variables"
            echo "Select the '${{ github.event.inputs.environment }}' environment"
            exit 1
          fi
          
          echo "âœ… All required environment variables are configured:"
          echo "  - BICEP_BASE_NAME: ${{ vars.BICEP_BASE_NAME }}"
          echo "  - BICEP_LOCATION: ${{ vars.BICEP_LOCATION }}"
          echo "  - BICEP_SHORT_LOCATION: ${{ vars.BICEP_SHORT_LOCATION }}"
          echo "  - BICEP_VNET_ADDRESS_PREFIX: ${{ vars.BICEP_VNET_ADDRESS_PREFIX }}"
          echo "  - BICEP_APP_SERVICE_SUBNET_PREFIX: ${{ vars.BICEP_APP_SERVICE_SUBNET_PREFIX }}"
          echo "  - BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX: ${{ vars.BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX }}"
          echo "  - BICEP_ACS_DATA_LOCATION: ${{ vars.BICEP_ACS_DATA_LOCATION }}"
          
          echo "::endgroup::"
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Register Azure Resource Providers
        if: github.event.inputs.action != 'teardown'
        run: |
          echo "::group::Checking and Registering Required Azure Resource Providers"
          
          PROVIDERS=(
            "Microsoft.AlertsManagement"
            "Microsoft.DocumentDB"
            "Microsoft.Cache"
            "Microsoft.SignalRService"
            "Microsoft.Communication"
            "Microsoft.Web"
            "Microsoft.Network"
            "Microsoft.Insights"
            "Microsoft.OperationalInsights"
          )
          
          for PROVIDER in "${PROVIDERS[@]}"; do
            echo "Checking provider: $PROVIDER"
            
            # Get current registration state
            STATE=$(az provider show --namespace "$PROVIDER" --query "registrationState" -o tsv 2>/dev/null || echo "NotFound")
            
            if [ "$STATE" == "Registered" ]; then
              echo "  âœ… Already registered: $PROVIDER"
            else
              echo "  â³ Registering: $PROVIDER (current state: $STATE)"
              az provider register --namespace "$PROVIDER" --wait
              echo "  âœ… Registered: $PROVIDER"
            fi
          done
          
          echo ""
          echo "âœ… All required resource providers are registered"
          echo "::endgroup::"
      
      - name: Create Networking Resource Group
        if: github.event.inputs.action != 'teardown'
        run: |
          az group create \
            --name ${{ env.NETWORKING_RESOURCE_GROUP }} \
            --location ${{ env.BICEP_LOCATION }}
      
      - name: Create Resource Group
        if: github.event.inputs.action != 'teardown'
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.BICEP_LOCATION }}
      
      - name: Validate Bicep Template
        if: github.event.inputs.action == 'validate' || github.event.inputs.action == 'deploy'
        working-directory: infra/bicep
        run: |
          echo "::group::Bicep Syntax Check"
          az bicep build --file main.bicep
          echo "::endgroup::"
          
          echo "::group::Template Validation"
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters baseName=${{ env.BICEP_BASE_NAME }} \
            --parameters environment=${{ env.ENVIRONMENT }} \
            --parameters location=${{ env.BICEP_LOCATION }} \
            --parameters shortLocation=${{ env.BICEP_SHORT_LOCATION }} \
            --parameters vnetAddressPrefix=${{ env.BICEP_VNET_ADDRESS_PREFIX }} \
            --parameters vnetDnsServers="${{ env.BICEP_VNET_DNS_SERVERS }}" \
            --parameters appServiceSubnetPrefix=${{ env.BICEP_APP_SERVICE_SUBNET_PREFIX }} \
            --parameters privateEndpointsSubnetPrefix=${{ env.BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX }} \
            --parameters acsDataLocation="${{ env.BICEP_ACS_DATA_LOCATION }}" \
            --parameters networkingResourceGroupName=${{ env.NETWORKING_RESOURCE_GROUP }} \
            --parameters otpPepper="${{ secrets.OTP_PEPPER }}" \
            --parameters entraIdConnectionString="${{ secrets.ENTRA_ID_CONNECTION_STRING }}" \
            --parameters entraIdAuthorizationHomeTenantId="${{ secrets.ENTRA_ID_HOME_TENANT_ID }}" \
            --parameters entraIdAuthorizationAdminRoleValue="${{ vars.ENTRA_ID_ADMIN_ROLE_VALUE }}"
          echo "::endgroup::"
      
      - name: What-If Analysis
        if: github.event.inputs.action == 'validate'
        working-directory: infra/bicep
        run: |
          echo "::group::What-If Preview"
          az deployment group what-if \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters baseName=${{ env.BICEP_BASE_NAME }} \
            --parameters environment=${{ env.ENVIRONMENT }} \
            --parameters location=${{ env.BICEP_LOCATION }} \
            --parameters shortLocation=${{ env.BICEP_SHORT_LOCATION }} \
            --parameters vnetAddressPrefix=${{ env.BICEP_VNET_ADDRESS_PREFIX }} \
            --parameters vnetDnsServers="${{ env.BICEP_VNET_DNS_SERVERS }}" \
            --parameters appServiceSubnetPrefix=${{ env.BICEP_APP_SERVICE_SUBNET_PREFIX }} \
            --parameters privateEndpointsSubnetPrefix=${{ env.BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX }} \
            --parameters acsDataLocation="${{ env.BICEP_ACS_DATA_LOCATION }}" \
            --parameters networkingResourceGroupName=${{ env.NETWORKING_RESOURCE_GROUP }} \
            --parameters otpPepper="${{ secrets.OTP_PEPPER }}" \
            --parameters entraIdConnectionString="${{ secrets.ENTRA_ID_CONNECTION_STRING }}" \
            --parameters entraIdAuthorizationHomeTenantId="${{ secrets.ENTRA_ID_HOME_TENANT_ID }}" \
            --parameters entraIdAuthorizationAdminRoleValue="${{ vars.ENTRA_ID_ADMIN_ROLE_VALUE }}" \
            --result-format FullResourcePayloads
          echo "::endgroup::"
      
      - name: Deploy Infrastructure
        if: github.event.inputs.action == 'deploy'
        id: deploy
        working-directory: infra/bicep
        run: |
          DEPLOYMENT_NAME="signalrchat-${{ env.ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)"
          
          echo "::group::Deploying Infrastructure"
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters baseName=${{ env.BICEP_BASE_NAME }} \
            --parameters environment=${{ env.ENVIRONMENT }} \
            --parameters location=${{ env.BICEP_LOCATION }} \
            --parameters shortLocation=${{ env.BICEP_SHORT_LOCATION }} \
            --parameters vnetAddressPrefix=${{ env.BICEP_VNET_ADDRESS_PREFIX }} \
            --parameters vnetDnsServers="${{ env.BICEP_VNET_DNS_SERVERS }}" \
            --parameters appServiceSubnetPrefix=${{ env.BICEP_APP_SERVICE_SUBNET_PREFIX }} \
            --parameters privateEndpointsSubnetPrefix=${{ env.BICEP_PRIVATE_ENDPOINTS_SUBNET_PREFIX }} \
            --parameters acsDataLocation="${{ env.BICEP_ACS_DATA_LOCATION }}" \
            --parameters networkingResourceGroupName=${{ env.NETWORKING_RESOURCE_GROUP }} \
            --parameters otpPepper="${{ secrets.OTP_PEPPER }}" \
            --parameters entraIdConnectionString="${{ secrets.ENTRA_ID_CONNECTION_STRING }}" \
            --parameters entraIdAuthorizationHomeTenantId="${{ secrets.ENTRA_ID_HOME_TENANT_ID }}" \
            --parameters entraIdAuthorizationAdminRoleValue="${{ vars.ENTRA_ID_ADMIN_ROLE_VALUE }}" \
            --name "$DEPLOYMENT_NAME" \
            --output json > deployment-output.json
          echo "::endgroup::"
          
          echo "::group::Deployment Outputs"
          cat deployment-output.json | jq -r '.properties.outputs'
          echo "::endgroup::"
          
          # Extract outputs for subsequent steps
          APP_URL=$(cat deployment-output.json | jq -r '.properties.outputs.appUrl.value')
          
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ App URL: $APP_URL"
          echo "â„¹ï¸  All connection strings configured in App Service during deployment"
      
      - name: Post-Deployment Validation
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "::group::Validating Deployment"
          
          # Wait for App Service to be ready and database seeding to complete
          echo "â„¹ï¸  Initial database seeding happens automatically during first app startup"
          sleep 30
          
          APP_URL="${{ steps.deploy.outputs.app_url }}"
          
          # Test health endpoint
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/health" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed: $APP_URL/health"
            echo "âœ… Database seeding completed during app startup"
          else
            echo "âš ï¸  Health check returned status: $HTTP_STATUS"
            echo "App may still be starting up or seeding data. Check Azure Portal for details."
          fi
          
          echo "::endgroup::"
      
      - name: Teardown Infrastructure
        if: github.event.inputs.action == 'teardown'
        run: |
          echo "::group::Deleting Application Resource Group"
          echo "âš ï¸  WARNING: This will delete all resources in ${{ env.RESOURCE_GROUP }}"
          
          # List resources to be deleted
          az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[].{Name:name, Type:type, Location:location}" \
            --output table || true
          
          # Delete resource group
          az group delete \
            --name ${{ env.RESOURCE_GROUP }} \
            --yes \
            --no-wait
          
          echo "âœ… Application RG deletion initiated (running in background)"
          echo "::endgroup::"
          
          echo "::group::Deleting Networking Resource Group"
          echo "âš ï¸  WARNING: This will delete all networking resources in ${{ env.NETWORKING_RESOURCE_GROUP }}"
          
          # List resources to be deleted
          az resource list \
            --resource-group ${{ env.NETWORKING_RESOURCE_GROUP }} \
            --query "[].{Name:name, Type:type, Location:location}" \
            --output table || true
          
          # Delete resource group
          az group delete \
            --name ${{ env.NETWORKING_RESOURCE_GROUP }} \
            --yes \
            --no-wait
          
          echo "âœ… Networking RG deletion initiated (running in background)"
          echo "::endgroup::"
      
      - name: Deployment Summary
        if: always() && github.event.inputs.action == 'deploy'
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Location:** ${{ env.BICEP_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deploy.outputs.app_url }}" != "" ]; then
            echo "**App URL:** ${{ steps.deploy.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          fi
